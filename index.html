<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Ayuda CNCI</title>
    
    <!-- Fuentes y Estilos -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cnciBlue: '#2563eb',
                        cnciDark: '#1e40af',
                        cnciNavy: '#004aad',
                        accent: '#ff8500',
                        universityGold: '#facc15'
                    },
                    borderRadius: { '3xl': '1.5rem' },
                    boxShadow: { 'premium': '0 20px 50px -12px rgba(0,74,173,0.12)' }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; color: #1e293b; overflow-x: hidden; }
        
        /* Animaciones Universitarias */
        .reveal-on-scroll { opacity: 0; transform: translateY(20px); transition: all 0.6s ease-out; }
        .reveal-on-scroll.visible { opacity: 1; transform: translateY(0); }

        .video-wrapper { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 1.5rem; background: #000; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
        
        .hero-gradient {
            background: linear-gradient(135deg, #004aad 0%, #002d69 100%);
            position: relative;
        }

        .hero-gradient::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: linear-gradient(to top, #f8fafc, transparent);
        }

        .faq-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .faq-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .faq-answer-text { font-size: 0.95rem; line-height: 1.7; }
        @media (min-width: 1024px) { .faq-answer-text { font-size: 1.15rem; } }

        #mobile-menu { 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(-150%);
            opacity: 0;
            pointer-events: none;
            position: fixed;
            z-index: 40;
        }
        #mobile-menu.active { transform: translateY(0); opacity: 1; pointer-events: auto; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .hidden-view { display: none !important; }

        .sort-icon { font-size: 10px; margin-left: 4px; cursor: pointer; color: #cbd5e1; }
        .sort-icon.active { color: #2563eb; }

        /* Estilo para los datos de las barras en las gr√°ficas */
        .chart-container { position: relative; height: 300px; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="toast-container" class="fixed top-4 right-4 z-[100] flex flex-col gap-2"></div>

    <nav class="bg-white sticky top-0 z-50 border-b border-slate-100 shadow-sm transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 h-20 flex justify-between items-center">
            <div class="flex items-center cursor-pointer group" onclick="location.reload()">
                <div class="bg-blue-600 p-1.5 rounded-lg mr-3 group-hover:scale-110 transition-transform">
                    <img class="h-7 w-auto" src="https://i.ibb.co/m5QcyKWg/Logo-CNCI.png" alt="Logo CNCI">
                </div>
                <span class="text-xl font-extrabold text-slate-800 tracking-tight">Centro de Ayuda <span class="text-blue-600">CNCI</span></span>
            </div>

            <div class="hidden md:flex items-center space-x-8 text-sm font-bold text-slate-600 uppercase tracking-widest">
                <a href="https://www.office.com/" target="_blank" class="hover:text-blue-700 transition-colors">Office 365</a>
                <a href="https://cnci.unlimitedlearning.io/" target="_blank" class="hover:text-blue-700 transition-colors">Biblioteca</a>
                <a href="https://cnci.blackboard.com/ultra/" target="_blank" 
                   class="bg-blue-600 text-white px-6 py-3 rounded-xl hover:bg-blue-700 transition-all shadow-lg hover:shadow-blue-200 active:scale-95">
                    Ir a Blackboard
                </a>
                <div id="admin-logged-info" class="hidden flex items-center gap-3 border-l pl-6 ml-2">
                    <span class="text-[10px] font-black bg-blue-100 text-blue-700 px-2 py-1 rounded">STAFF</span>
                    <button onclick="window.logoutAdmin()" class="text-red-500 hover:underline text-xs">Salir</button>
                </div>
            </div>

            <button onclick="window.toggleMobileMenu()" class="md:hidden text-slate-600 p-2 relative z-50">
                <i id="menu-icon" class="fa-solid fa-bars-staggered text-2xl"></i>
            </button>
        </div>

        <div id="mobile-menu" class="fixed inset-x-0 top-0 pt-24 bg-white border-b shadow-2xl p-6 flex flex-col gap-4 md:hidden">
            <a href="https://www.office.com/" target="_blank" class="py-4 border-b font-bold text-slate-700 text-lg">Office 365</a>
            <a href="https://cnci.unlimitedlearning.io/" target="_blank" class="py-4 border-b font-bold text-slate-700 text-lg">Biblioteca</a>
            <a href="https://cnci.blackboard.com/ultra/" target="_blank" class="mt-4 py-5 bg-blue-600 text-white text-center rounded-2xl font-black text-xl shadow-lg">Blackboard</a>
        </div>
    </nav>

    <main id="view-client" class="flex-grow">
        <section class="hero-gradient text-white pt-20 pb-32 px-6 overflow-hidden">
            <div class="max-w-4xl mx-auto text-center relative z-10 animate__animated animate__fadeIn">
                <span class="inline-block bg-white/10 backdrop-blur-md px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-[0.3em] mb-6 border border-white/20">Portal de Autoservicio</span>
                <h1 class="text-4xl md:text-6xl font-black mb-6 leading-tight">
                    ¬øEn qu√© podemos <br><span class="text-blue-300">orientarte</span> hoy?
                </h1>
                <p class="text-blue-100 text-lg md:text-xl mb-12 max-w-2xl mx-auto font-light leading-relaxed">
                    Resuelve tus dudas sobre procesos acad√©micos, plataformas y servicios universitarios en segundos.
                </p>
                
                <div class="max-w-2xl mx-auto relative group">
                    <div class="absolute inset-0 bg-blue-400/20 blur-2xl group-hover:bg-blue-400/30 transition-all rounded-3xl"></div>
                    <i class="fa-solid fa-search absolute left-8 top-1/2 -translate-y-1/2 text-slate-400 text-xl"></i>
                    <input type="text" id="search-input" oninput="window.handleSearch(event)" 
                        placeholder="Busca por palabra clave (ej. becas, titulaci√≥n)..." 
                        class="w-full pl-16 pr-8 py-6 rounded-2xl border-0 shadow-2xl focus:ring-4 focus:ring-blue-400/40 outline-none text-gray-800 text-lg transition-all relative z-10">
                </div>
            </div>
        </section>

        <div class="max-w-5xl mx-auto px-4 sm:px-6 -mt-16 pb-24 relative z-20">
            <div class="flex overflow-x-auto no-scrollbar gap-3 mb-12 pb-4 justify-start md:justify-center animate__animated animate__fadeInUp animate__delay-1s" id="categories-container"></div>
            
            <div id="faqs-container" class="space-y-6"></div>

            <!-- Paginaci√≥n -->
            <div id="pagination-controls" class="mt-16 flex justify-center items-center gap-3 animate__animated animate__fadeIn"></div>
        </div>
    </main>

    <!-- Vista Admin -->
    <main id="view-admin" class="flex-grow bg-slate-50 hidden-view pb-24">
        <div class="max-w-7xl mx-auto px-4 py-10">
            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-10 gap-6">
                <div>
                    <h2 class="text-3xl font-black text-slate-800">Panel Universitario</h2>
                    <p class="text-slate-500 font-medium">Gesti√≥n de base de conocimientos CNCI</p>
                </div>
                <div class="flex bg-white p-1 rounded-2xl shadow-sm border w-full lg:w-auto overflow-x-auto">
                    <button onclick="window.switchAdminTab('dashboard')" id="tab-btn-dashboard" class="flex-1 lg:flex-none px-8 py-3 rounded-xl text-xs font-black transition-all">Dashboard</button>
                    <button onclick="window.switchAdminTab('metrics')" id="tab-btn-metrics" class="flex-1 lg:flex-none px-8 py-3 rounded-xl text-xs font-black transition-all">Sesiones</button>
                    <button onclick="window.switchAdminTab('faqs')" id="tab-btn-faqs" class="flex-1 lg:flex-none px-8 py-3 rounded-xl text-xs font-black transition-all">Preguntas</button>
                    <button onclick="window.switchAdminTab('categories')" id="tab-btn-categories" class="flex-1 lg:flex-none px-8 py-3 rounded-xl text-xs font-black transition-all">Estructura</button>
                </div>
            </div>

            <!-- Dashboard Acad√©mico -->
            <div id="admin-tab-dashboard" class="animate__animated animate__fadeIn">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-white p-8 rounded-[2rem] shadow-premium border border-slate-100">
                        <h3 class="font-black text-slate-800 mb-8 flex items-center gap-3">
                            <i class="fa-solid fa-chart-line text-blue-600"></i> FAQs con mayor apertura
                        </h3>
                        <div class="chart-container">
                            <canvas id="chartTopClicks"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-8 rounded-[2rem] shadow-premium border border-slate-100">
                        <h3 class="font-black text-slate-800 mb-8 flex items-center gap-3">
                            <i class="fa-solid fa-thumbs-up text-blue-600"></i> Top Likes (Valoradas)
                        </h3>
                        <div class="chart-container">
                            <canvas id="chartTopLikes"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- M√©tricas (Modificadas seg√∫n solicitud) -->
            <div id="admin-tab-metrics" class="hidden-view animate__animated animate__fadeIn">
                <div class="bg-white rounded-[2rem] shadow-premium border overflow-hidden">
                    <div class="p-8 border-b flex flex-col md:flex-row justify-between items-center bg-slate-50/50 gap-4">
                        <div>
                            <span class="font-black text-slate-800 text-lg uppercase tracking-tight">Registro Acad√©mico de Sesiones</span>
                            <p class="text-xs text-slate-500 font-medium">Historial de accesos al portal de ayuda</p>
                        </div>
                        <div class="relative w-full md:w-64">
                            <i class="fa-solid fa-filter absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                            <input type="text" id="metric-filter" oninput="window.filterMetrics()" placeholder="Filtrar por ciudad/estado..." 
                                class="w-full pl-10 pr-4 py-3 bg-white border rounded-xl outline-none text-xs font-bold">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-100/80 text-[10px] uppercase text-slate-500 font-black">
                                <tr>
                                    <th class="px-8 py-5 cursor-pointer hover:bg-slate-200 transition-colors" onclick="window.sortMetrics('date')">
                                        Fecha <i class="fa-solid fa-sort sort-icon" id="sort-date"></i>
                                    </th>
                                    <th class="px-8 py-5 cursor-pointer hover:bg-slate-200 transition-colors" onclick="window.sortMetrics('time')">
                                        Hora <i class="fa-solid fa-sort sort-icon" id="sort-time"></i>
                                    </th>
                                    <th class="px-8 py-5 cursor-pointer hover:bg-slate-200 transition-colors" onclick="window.sortMetrics('location')">
                                        Ubicaci√≥n (Ciudad/Estado) <i class="fa-solid fa-sort sort-icon" id="sort-location"></i>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="admin-metrics-table-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- FAQs Admin -->
            <div id="admin-tab-faqs" class="hidden-view animate__animated animate__fadeIn">
                <div class="bg-white rounded-[2rem] shadow-premium border overflow-hidden">
                    <div class="p-8 border-b flex justify-between items-center bg-slate-50/50">
                        <span class="font-black text-slate-800 text-lg uppercase tracking-tight">Banco de Conocimiento</span>
                        <button onclick="window.openFaqModal()" class="bg-blue-600 text-white px-6 py-3 rounded-xl text-xs font-black flex items-center gap-2 shadow-lg hover:bg-blue-700 transition-all">
                            <i class="fa-solid fa-plus"></i> Crear FAQ
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-100 text-[10px] uppercase text-slate-500 font-black">
                                <tr>
                                    <th class="px-8 py-5">Contenido / Pregunta</th>
                                    <th class="px-8 py-5 text-center">Likes</th>
                                    <th class="px-8 py-5 text-center">Aperturas</th>
                                    <th class="px-8 py-5 text-right">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="admin-faqs-table-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Categor√≠as Admin -->
            <div id="admin-tab-categories" class="hidden-view grid grid-cols-1 md:grid-cols-2 gap-8 animate__animated animate__fadeIn">
                <div class="bg-white p-8 rounded-[2rem] shadow-premium border">
                    <div class="flex justify-between items-center mb-8">
                        <h3 class="font-black text-slate-800 text-lg uppercase">Categor√≠as</h3>
                        <button onclick="window.openSimpleModal('category')" class="bg-blue-50 text-blue-600 w-10 h-10 rounded-xl flex items-center justify-center hover:bg-blue-600 hover:text-white transition-all">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>
                    <ul id="admin-categories-list" class="divide-y text-sm"></ul>
                </div>
                <div class="bg-white p-8 rounded-[2rem] shadow-premium border">
                    <div class="flex justify-between items-center mb-8">
                        <h3 class="font-black text-slate-800 text-lg uppercase">Responsables Acad√©micos</h3>
                        <button onclick="window.openSimpleModal('area')" class="bg-blue-50 text-blue-600 w-10 h-10 rounded-xl flex items-center justify-center hover:bg-blue-600 hover:text-white transition-all">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>
                    <ul id="admin-areas-list" class="divide-y text-sm"></ul>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-white border-t py-12 px-6 mt-auto">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-10">
            <div class="text-center md:text-left">
                <div class="flex items-center justify-center md:justify-start gap-3 grayscale opacity-40">
                    <img class="h-6" src="https://i.ibb.co/m5QcyKWg/Logo-CNCI.png">
                    <span class="font-bold text-slate-800">Centro de Ayuda CNCI</span>
                </div>
                <p class="text-slate-400 text-[10px] mt-4 uppercase font-bold tracking-[0.2em]">¬© 2024 Universidad Virtual CNCI. Formaci√≥n de L√≠deres con Sentido Humano.</p>
            </div>
            <button id="nav-admin-btn" onclick="window.showLoginModal()" class="text-slate-300 text-[10px] font-black uppercase hover:text-blue-600 transition-colors border-2 border-slate-100 px-6 py-2 rounded-full">
                üîí Acceso de Personal
            </button>
        </div>
    </footer>

    <!-- Modales -->
    <div id="modal-login" class="fixed inset-0 bg-slate-900/70 backdrop-blur-md z-[100] flex justify-center items-center hidden-view p-4">
        <div class="bg-white rounded-[2.5rem] p-10 max-w-md w-full shadow-2xl animate__animated animate__zoomIn">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-blue-600 rounded-2xl mx-auto flex items-center justify-center shadow-lg shadow-blue-200 mb-4">
                    <i class="fa-solid fa-user-shield text-white text-2xl"></i>
                </div>
                <h3 class="text-2xl font-black text-slate-800 uppercase tracking-tight">Acceso Staff</h3>
                <p class="text-slate-400 text-xs font-medium">Ingresa tus credenciales institucionales</p>
            </div>
            <form onsubmit="window.handleLogin(event)" class="space-y-4">
                <div class="relative">
                    <i class="fa-solid fa-envelope absolute left-5 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input type="email" id="login-email" placeholder="Usuario Institucional" required class="w-full pl-12 pr-6 py-4 bg-slate-50 border-0 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 font-medium">
                </div>
                <div class="relative">
                    <i class="fa-solid fa-lock absolute left-5 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input type="password" id="login-password" placeholder="Contrase√±a" required class="w-full pl-12 pr-6 py-4 bg-slate-50 border-0 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 font-medium">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black shadow-xl hover:bg-blue-700 transition-all uppercase tracking-widest mt-4">Validar Ingreso</button>
                <button type="button" onclick="window.closeModal('modal-login')" class="w-full text-slate-400 text-[10px] font-bold uppercase tracking-widest mt-4">Cancelar</button>
            </form>
        </div>
    </div>

    <!-- Modal FAQ Editor -->
    <div id="modal-faq" class="fixed inset-0 bg-slate-900/80 backdrop-blur-md z-[100] flex justify-center items-center hidden-view p-4">
        <div class="bg-white rounded-[3rem] p-8 md:p-12 max-w-4xl w-full max-h-[90vh] overflow-y-auto shadow-2xl animate__animated animate__slideInUp">
            <h3 id="modal-faq-title" class="text-3xl font-black text-slate-800 mb-8 uppercase tracking-tight">Gestionar Respuesta</h3>
            <form onsubmit="window.saveFaq(event)" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <input type="hidden" id="faq-id">
                <div class="md:col-span-2 space-y-2">
                    <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Pregunta del Estudiante</label>
                    <input type="text" id="faq-question" required class="w-full px-6 py-4 bg-slate-50 border-0 rounded-2xl outline-none focus:ring-2 focus:ring-blue-600 font-bold">
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Clasificaci√≥n Acad√©mica</label>
                    <select id="faq-category" required class="w-full px-6 py-4 bg-slate-50 border-0 rounded-2xl outline-none font-bold text-slate-700"></select>
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Departamento Responsable</label>
                    <select id="faq-area" required class="w-full px-6 py-4 bg-slate-50 border-0 rounded-2xl outline-none font-bold text-slate-700"></select>
                </div>
                <div class="md:col-span-2 space-y-2">
                    <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest text-blue-600">Cuerpo de la Respuesta</label>
                    <div class="border-2 border-slate-50 rounded-3xl overflow-hidden bg-white shadow-sm">
                        <div class="bg-slate-50/50 p-3 border-b flex gap-2">
                            <button type="button" onclick="document.execCommand('bold')" class="w-10 h-10 hover:bg-white rounded-xl transition-all"><i class="fa-solid fa-bold text-slate-600"></i></button>
                            <button type="button" onclick="document.execCommand('insertUnorderedList')" class="w-10 h-10 hover:bg-white rounded-xl transition-all"><i class="fa-solid fa-list-ul text-slate-600"></i></button>
                        </div>
                        <div id="faq-answer-rte" contenteditable="true" class="p-6 min-h-[180px] outline-none text-slate-600 text-sm leading-relaxed"></div>
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Imagen / Infograf√≠a (URL)</label>
                    <input type="url" id="faq-image" class="w-full px-6 py-4 bg-slate-50 border-0 rounded-2xl outline-none text-xs">
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase text-red-500 tracking-widest">Video Tutorial (Youtube Embed)</label>
                    <input type="text" id="faq-video-embed" class="w-full px-6 py-4 bg-red-50/30 border-0 rounded-2xl outline-none text-xs" placeholder="<iframe... src='...'>">
                </div>
                <div class="md:col-span-2 flex justify-end gap-4 pt-6">
                    <button type="button" onclick="window.closeModal('modal-faq')" class="px-8 py-3 text-slate-400 font-black text-xs uppercase tracking-widest">Descartar</button>
                    <button type="submit" class="px-10 py-4 bg-blue-600 text-white rounded-2xl font-black shadow-xl hover:bg-blue-700 transition-all uppercase tracking-widest">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, increment, addDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC8jIUPHKmcKy7eO1aq6eS4ZJ6kfq4zrBo",
            authDomain: "apppaneldesupcallcenter.firebaseapp.com",
            projectId: "apppaneldesupcallcenter",
            storageBucket: "apppaneldesupcallcenter.firebasestorage.app",
            messagingSenderId: "1091325080953",
            appId: "1:1091325080953:web:14fd225a15f532f92feba8"
        };
        const customAppId = "cnci-faq-hub-v2";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let faqsData = [], categoriesData = [], areasData = [], metricsData = [], filteredMetrics = [];
        let currentCategory = 'all', searchQuery = '', chartL, chartC;
        let metricSort = { col: 'date', order: 'desc' };
        
        // Paginaci√≥n
        let currentPage = 1;
        const itemsPerPage = 10;

        const extractYouTubeId = (input) => {
            if (!input) return null;
            const iframeMatch = input.match(/src="[^"]*\/embed\/([^"?]+)/);
            if (iframeMatch && iframeMatch[1]) return iframeMatch[1];
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = input.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        };

        const showToast = (msg, type='success') => {
            const container = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = `px-8 py-5 rounded-2xl shadow-2xl text-white text-[11px] font-black uppercase tracking-widest animate__animated animate__fadeInRight ${type === 'success' ? 'bg-blue-600' : 'bg-red-500'}`;
            t.innerHTML = msg;
            container.appendChild(t);
            setTimeout(() => { t.classList.replace('animate__fadeInRight', 'animate__fadeOutRight'); setTimeout(() => t.remove(), 500); }, 3000);
        };

        window.toggleMobileMenu = () => {
            const menu = document.getElementById('mobile-menu');
            const icon = document.getElementById('menu-icon');
            const isActive = menu.classList.toggle('active');
            icon.className = isActive ? 'fa-solid fa-xmark text-2xl' : 'fa-solid fa-bars-staggered text-2xl';
            document.body.style.overflow = isActive ? 'hidden' : '';
        };

        // --- Anal√≠tica con Fallback ---
        async function trackSession() {
            try {
                let geoData = { city: 'Desconocido', region: 'Desconocido' };
                try {
                    const res = await fetch('https://ipapi.co/json/', { signal: AbortSignal.timeout(4000) });
                    if (res.ok) geoData = await res.json();
                } catch (e) { console.warn("Geo offline"); }

                await addDoc(collection(db, 'artifacts', customAppId, 'public', 'data', 'sessions'), {
                    city: geoData.city || 'Desconocido',
                    region: geoData.region || 'Desconocido',
                    timestamp: serverTimestamp()
                });
            } catch (e) { console.error("Track err", e); }
        }

        onAuthStateChanged(auth, (user) => {
            const isAdmin = user && !user.isAnonymous;
            document.getElementById('admin-logged-info').classList.toggle('hidden', !isAdmin);
            document.getElementById('nav-admin-btn').classList.toggle('hidden', isAdmin);
            if (!window.listenersActive) {
                setupListeners();
                if (!isAdmin) trackSession();
            }
        });

        async function setupListeners() {
            window.listenersActive = true;
            onSnapshot(collection(db, 'artifacts', customAppId, 'public', 'data', 'categories'), s => {
                categoriesData = s.docs.map(d => ({id: d.id, ...d.data()}));
                renderCategories();
                updateSelects();
                renderSimple();
            });
            onSnapshot(collection(db, 'artifacts', customAppId, 'public', 'data', 'areas'), s => {
                areasData = s.docs.map(d => ({id: d.id, ...d.data()}));
                updateSelects();
                renderSimple();
            });
            onSnapshot(collection(db, 'artifacts', customAppId, 'public', 'data', 'faqs'), s => {
                faqsData = s.docs.map(d => ({id: d.id, ...d.data()}));
                renderFAQs();
                renderAdminTable();
                if(!document.getElementById('admin-tab-dashboard').classList.contains('hidden-view')) updateCharts();
            });
            onSnapshot(collection(db, 'artifacts', customAppId, 'public', 'data', 'sessions'), s => {
                metricsData = s.docs.map(d => {
                    const dt = d.data().timestamp?.toDate() || new Date();
                    return {
                        id: d.id,
                        date: dt.toLocaleDateString('es-MX'),
                        time: dt.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' }),
                        location: `${d.data().city}, ${d.data().region}`,
                        rawTimestamp: dt.getTime()
                    };
                });
                filteredMetrics = [...metricsData];
                renderMetricsTable();
            });
        }

        // --- Funciones de Home ---
        window.handleSearch = (e) => { searchQuery = e.target.value.toLowerCase(); currentPage = 1; renderFAQs(); };
        window.setCategory = (id) => { currentCategory = id; currentPage = 1; renderFAQs(); renderCategories(); };
        window.goToPage = (p) => { currentPage = p; window.scrollTo({ top: 300, behavior: 'smooth' }); renderFAQs(); };

        function renderCategories() {
            const container = document.getElementById('categories-container');
            const btnClass = (active) => `flex-shrink-0 px-6 py-3 rounded-2xl text-[10px] font-black transition-all uppercase tracking-widest ${active ? 'bg-blue-600 text-white shadow-xl scale-105' : 'bg-white text-slate-400 border hover:bg-slate-50 shadow-sm'}`;
            let html = `<button onclick="window.setCategory('all')" class="${btnClass(currentCategory === 'all')}">Todos</button>`;
            categoriesData.forEach(c => html += `<button onclick="window.setCategory('${c.id}')" class="${btnClass(currentCategory === c.id)}">${c.name}</button>`);
            container.innerHTML = html;
        }

        function renderFAQs() {
            const container = document.getElementById('faqs-container');
            const pagControls = document.getElementById('pagination-controls');
            const filtered = faqsData.filter(f => {
                const matchCat = currentCategory === 'all' || f.categoryId === currentCategory;
                const matchSearch = !searchQuery || (f.question + f.answer).toLowerCase().includes(searchQuery);
                return matchCat && matchSearch;
            });

            const totalPages = Math.ceil(filtered.length / itemsPerPage);
            const paginated = filtered.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

            if(!paginated.length) { 
                container.innerHTML = '<div class="text-center py-24 text-slate-300 font-bold uppercase tracking-widest">No hay resultados para tu b√∫squeda</div>'; 
                pagControls.innerHTML = '';
                return; 
            }

            container.innerHTML = paginated.map((f, idx) => {
                const isOpen = window.openedFaqId === f.id;
                const vId = extractYouTubeId(f.videoUrl);
                const area = areasData.find(a => a.id === f.areaId)?.name || 'General';

                return `
                <div class="bg-white rounded-[2.5rem] overflow-hidden shadow-premium border border-slate-100/50 faq-card animate__animated animate__fadeInUp" style="animation-delay: ${idx * 0.1}s">
                    <button onclick="window.toggleFaq('${f.id}')" class="w-full text-left p-8 md:p-10 flex justify-between items-center group">
                        <div class="flex items-center gap-6">
                            <div class="w-12 h-12 rounded-2xl bg-blue-50 text-blue-600 flex items-center justify-center shrink-0 group-hover:bg-blue-600 group-hover:text-white transition-all">
                                <i class="fa-solid fa-graduation-cap text-lg"></i>
                            </div>
                            <div>
                                <h3 class="font-black text-slate-800 text-base md:text-2xl leading-tight group-hover:text-blue-700 transition-colors">${f.question}</h3>
                                <p class="text-[9px] font-black text-slate-300 uppercase tracking-widest mt-2">${area}</p>
                            </div>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center transition-all ${isOpen ? 'rotate-180 bg-blue-600 text-white' : 'text-slate-300'}">
                            <i class="fa-solid fa-chevron-down text-[10px]"></i>
                        </div>
                    </button>
                    <div class="overflow-hidden transition-all duration-500" style="display: ${isOpen ? 'block' : 'none'}">
                        <div class="px-8 md:px-28 pb-12 pt-4 border-t border-slate-50">
                            <div class="text-slate-600 faq-answer-text leading-relaxed mb-8">${f.answer}</div>
                            ${f.imageUrl ? `<img src="${f.imageUrl}" class="w-full rounded-3xl shadow-2xl mb-8">` : ''}
                            ${vId ? `<div class="video-wrapper shadow-2xl"><iframe src="https://www.youtube.com/embed/${vId}" allowfullscreen></iframe></div>` : ''}
                            <div class="mt-12 pt-8 border-t border-slate-100 flex flex-wrap justify-between items-center gap-6">
                                <div class="flex gap-2">
                                    <span class="bg-blue-50 text-blue-600 px-4 py-1.5 rounded-full text-[9px] font-black uppercase tracking-widest">Oficial</span>
                                </div>
                                <div class="flex items-center gap-4">
                                    <span class="text-[10px] text-slate-400 font-black uppercase tracking-tighter">¬øResolvimos tu duda?</span>
                                    <button onclick="window.handleLike(event, '${f.id}')" class="flex items-center gap-3 bg-slate-50 hover:bg-rose-50 px-6 py-3 rounded-2xl transition-all font-black text-slate-500 hover:text-rose-600 shadow-sm border border-transparent hover:border-rose-100 group">
                                        <i class="fa-solid fa-heart group-hover:scale-125 transition-transform ${f.likes > 0 ? 'text-rose-500' : ''}"></i>
                                        <span class="text-xs">${f.likes || 0}</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');

            if(totalPages > 1) {
                let pBtnHtml = `<button onclick="window.goToPage(${Math.max(1, currentPage - 1)})" class="w-10 h-10 flex items-center justify-center rounded-xl border text-slate-400" ${currentPage === 1 ? 'disabled' : ''}><i class="fa-solid fa-chevron-left text-[10px]"></i></button>`;
                for(let i=1; i<=totalPages; i++) {
                    pBtnHtml += `<button onclick="window.goToPage(${i})" class="w-10 h-10 flex items-center justify-center rounded-xl text-xs font-black ${currentPage === i ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-500 border'}">${i}</button>`;
                }
                pBtnHtml += `<button onclick="window.goToPage(${Math.min(totalPages, currentPage + 1)})" class="w-10 h-10 flex items-center justify-center rounded-xl border text-slate-400" ${currentPage === totalPages ? 'disabled' : ''}><i class="fa-solid fa-chevron-right text-[10px]"></i></button>`;
                pagControls.innerHTML = pBtnHtml;
            } else pagControls.innerHTML = '';
        }

        window.toggleFaq = async (id) => { 
            const isOpening = window.openedFaqId !== id;
            window.openedFaqId = isOpening ? id : null; 
            renderFAQs();
            if(isOpening) await updateDoc(doc(db, 'artifacts', customAppId, 'public', 'data', 'faqs', id), { clicks: increment(1) });
        };

        window.handleLike = async (e, id) => { e.stopPropagation(); await updateDoc(doc(db, 'artifacts', customAppId, 'public', 'data', 'faqs', id), { likes: increment(1) }); };
        window.showLoginModal = () => document.getElementById('modal-login').classList.remove('hidden-view');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden-view');
        
        window.handleLogin = async (e) => {
            e.preventDefault();
            try {
                await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value);
                window.closeModal('modal-login');
                document.getElementById('view-client').classList.add('hidden-view');
                document.getElementById('view-admin').classList.remove('hidden-view');
                showToast("Acceso Concedido");
            } catch(e) { showToast("Error de Acceso", "error"); }
        };

        window.logoutAdmin = async () => { await signOut(auth); location.reload(); };

        window.switchAdminTab = (t) => {
            ['dashboard', 'metrics', 'faqs', 'categories'].forEach(id => {
                const view = document.getElementById(`admin-tab-${id}`);
                if(view) view.classList.toggle('hidden-view', id !== t);
                const btn = document.getElementById(`tab-btn-${id}`);
                if(btn) btn.className = `px-8 py-3 rounded-xl text-xs font-black transition-all ${id === t ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-500 hover:bg-slate-100'}`;
            });
            if(t === 'dashboard') setTimeout(updateCharts, 50);
        };

        // --- Gesti√≥n de M√©tricas (Filtro y Orden) ---
        window.filterMetrics = () => {
            const query = document.getElementById('metric-filter').value.toLowerCase();
            filteredMetrics = metricsData.filter(m => m.location.toLowerCase().includes(query));
            renderMetricsTable();
        };

        window.sortMetrics = (col) => {
            metricSort.order = (metricSort.col === col && metricSort.order === 'asc') ? 'desc' : 'asc';
            metricSort.col = col;

            filteredMetrics.sort((a, b) => {
                let valA = a[col], valB = b[col];
                if(col === 'date') { valA = a.rawTimestamp; valB = b.rawTimestamp; }
                if (valA < valB) return metricSort.order === 'asc' ? -1 : 1;
                if (valA > valB) return metricSort.order === 'asc' ? 1 : -1;
                return 0;
            });

            document.querySelectorAll('.sort-icon').forEach(i => i.classList.remove('active'));
            document.getElementById(`sort-${col}`).classList.add('active');
            renderMetricsTable();
        };

        function renderMetricsTable() {
            const body = document.getElementById('admin-metrics-table-body');
            if(!body) return;
            body.innerHTML = filteredMetrics.map(m => `
                <tr class="hover:bg-slate-50/50 transition-colors text-[11px]">
                    <td class="px-8 py-5 font-bold text-slate-800">${m.date}</td>
                    <td class="px-8 py-5 text-slate-500">${m.time}</td>
                    <td class="px-8 py-5 font-black text-blue-700">${m.location}</td>
                </tr>`).join('');
        }

        // --- Gr√°ficas Horizontales ---
        function updateCharts() {
            const ctxC = document.getElementById('chartTopClicks'), ctxL = document.getElementById('chartTopLikes');
            if(!ctxC || !ctxL || faqsData.length === 0) return;
            
            if(chartC) chartC.destroy();
            if(chartL) chartL.destroy();

            const topClicks = [...faqsData].sort((a,b) => b.clicks - a.clicks).slice(0, 5);
            const topLikes = [...faqsData].sort((a,b) => b.likes - a.likes).slice(0, 5);

            const commonOptions = {
                indexAxis: 'y', // Convertir a Barras Horizontales
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: true }
                },
                scales: {
                    x: { grid: { display: false }, ticks: { font: { size: 10, weight: 'bold' } } },
                    y: { grid: { display: false }, ticks: { font: { size: 10, weight: 'bold' } } }
                }
            };

            chartC = new Chart(ctxC, {
                type: 'bar',
                data: {
                    labels: topClicks.map(x => x.question.substring(0, 20) + '...'),
                    datasets: [{
                        label: 'Clics',
                        data: topClicks.map(x => x.clicks),
                        backgroundColor: '#2563eb',
                        borderRadius: 12,
                        barThickness: 25
                    }]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        ...commonOptions.plugins,
                        afterDraw: (chart) => {
                            const {ctx, data} = chart;
                            ctx.save();
                            ctx.font = 'bold 10px Poppins';
                            ctx.fillStyle = '#1e293b';
                            chart.getDatasetMeta(0).data.forEach((bar, index) => {
                                ctx.fillText(data.datasets[0].data[index], bar.x + 10, bar.y + 5);
                            });
                        }
                    }
                }
            });

            chartL = new Chart(ctxL, {
                type: 'bar',
                data: {
                    labels: topLikes.map(x => x.question.substring(0, 20) + '...'),
                    datasets: [{
                        label: 'Likes',
                        data: topLikes.map(x => x.likes),
                        backgroundColor: '#ff8500',
                        borderRadius: 12,
                        barThickness: 25
                    }]
                },
                options: commonOptions
            });
        }

        // --- Gesti√≥n FAQs Admin ---
        window.openFaqModal = () => {
            document.getElementById('faq-id').value = '';
            document.getElementById('faq-question').value = '';
            document.getElementById('faq-answer-rte').innerHTML = '';
            document.getElementById('faq-image').value = '';
            document.getElementById('faq-video-embed').value = '';
            document.getElementById('modal-faq-title').innerText = 'Nueva FAQ';
            document.getElementById('modal-faq').classList.remove('hidden-view');
        };

        window.editFaq = (id) => {
            const f = faqsData.find(x => x.id === id);
            document.getElementById('faq-id').value = f.id;
            document.getElementById('faq-question').value = f.question;
            document.getElementById('faq-category').value = f.categoryId;
            document.getElementById('faq-area').value = f.areaId;
            document.getElementById('faq-answer-rte').innerHTML = f.answer;
            document.getElementById('faq-image').value = f.imageUrl || '';
            document.getElementById('faq-video-embed').value = f.videoUrl || '';
            document.getElementById('modal-faq-title').innerText = 'Editar FAQ';
            document.getElementById('modal-faq').classList.remove('hidden-view');
        };

        window.saveFaq = async (e) => {
            e.preventDefault();
            const id = document.getElementById('faq-id').value;
            const data = {
                question: document.getElementById('faq-question').value,
                categoryId: document.getElementById('faq-category').value,
                areaId: document.getElementById('faq-area').value,
                answer: document.getElementById('faq-answer-rte').innerHTML,
                imageUrl: document.getElementById('faq-image').value,
                videoUrl: document.getElementById('faq-video-embed').value
            };
            if(id) await updateDoc(doc(db, 'artifacts', customAppId, 'public', 'data', 'faqs', id), data);
            else await addDoc(collection(db, 'artifacts', customAppId, 'public', 'data', 'faqs'), {...data, likes: 0, clicks: 0});
            
            showToast("Guardado con √©xito");
            window.closeModal('modal-faq');
        };

        function renderAdminTable() {
            const body = document.getElementById('admin-faqs-table-body');
            if(!body) return;
            body.innerHTML = faqsData.map(f => `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="px-8 py-5 font-bold text-slate-700 text-xs">${f.question}</td>
                    <td class="px-8 py-5 text-center"><span class="bg-blue-50 text-blue-600 px-3 py-1 rounded-lg text-[10px] font-black">${f.likes || 0}</span></td>
                    <td class="px-8 py-5 text-center"><span class="bg-slate-100 text-slate-500 px-3 py-1 rounded-lg text-[10px] font-black">${f.clicks || 0}</span></td>
                    <td class="px-8 py-5 text-right space-x-2">
                        <button onclick="window.editFaq('${f.id}')" class="text-blue-500 hover:bg-blue-50 w-8 h-8 rounded-lg transition-all"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="window.deleteFaq('${f.id}')" class="text-red-400 hover:bg-red-50 w-8 h-8 rounded-lg transition-all"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`).join('');
        }

        window.deleteFaq = async (id) => { if(confirm('¬øConfirmas eliminar esta informaci√≥n acad√©mica?')) await deleteDoc(doc(db, 'artifacts', customAppId, 'public', 'data', 'faqs', id)); };
        
        window.updateSelects = () => {
            const c = document.getElementById('faq-category'), a = document.getElementById('faq-area');
            if(c) c.innerHTML = categoriesData.map(i => `<option value="${i.id}">${i.name}</option>`).join('');
            if(a) a.innerHTML = areasData.map(i => `<option value="${i.id}">${i.name}</option>`).join('');
        };

        window.openSimpleModal = (type) => {
            const name = prompt(`Nombre de la nueva ${type === 'category' ? 'categor√≠a' : '√°rea'}:`);
            if(name) addDoc(collection(db, 'artifacts', customAppId, 'public', 'data', type === 'category' ? 'categories' : 'areas'), { name });
        };

        window.renderSimple = () => {
            const catL = document.getElementById('admin-categories-list'), areaL = document.getElementById('admin-areas-list');
            if(catL) catL.innerHTML = categoriesData.map(c => `<li class="py-4 flex justify-between items-center group font-bold text-slate-600">${c.name} <button onclick="window.delSimple('categories','${c.id}')" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all"><i class="fa-solid fa-trash-can"></i></button></li>`).join('');
            if(areaL) areaL.innerHTML = areasData.map(a => `<li class="py-4 flex justify-between items-center group font-bold text-slate-600">${a.name} <button onclick="window.delSimple('areas','${a.id}')" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all"><i class="fa-solid fa-trash-can"></i></button></li>`).join('');
        };

        window.delSimple = async (col, id) => { if(confirm('¬øEliminar elemento?')) await deleteDoc(doc(db, 'artifacts', customAppId, 'public', 'data', col, id)); };

        // Animaci√≥n de scroll
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => { if(entry.isIntersecting) entry.target.classList.add('visible'); });
        }, { threshold: 0.1 });

        document.querySelectorAll('.reveal-on-scroll').forEach(el => observer.observe(el));

        signInAnonymously(auth);
    </script>
</body>
</html>
