<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Ayuda - Universidad CNCI</title>

    <link rel="icon" type="image/x-icon" href="favicon.ico?v=1">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico?v=1">
    <link rel="apple-touch-icon" href="favicon.ico?v=1">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>
    <script>
        window.tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cnciAzul: '#2a6aff',
                        cnciNaranja: '#ff8500',
                    }
                }
            }
        }
    </script>
    <script>
        // VARIABLES DE ESTADO GLOBAL (Para filtros y paginaci√≥n)
        let currentPage = 1;
        const itemsPerPage = 10;
        let currentCategory = 'all';
        let searchTerm = '';
        let openedFaqId = null; // Guardar√° el ID de la pregunta que est√© abierta
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; background-color: #f4f7fe; overflow-x: hidden; }
        .gradient-bg { background: linear-gradient(135deg, #2a6aff 0%, #1a49b8 100%); }
        .category-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; }
        .category-card:hover { transform: translateY(-8px); border-color: #ff8500; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out; }
        .accordion-item.active .accordion-content { max-height: 1500px; }
        .accordion-item.active .chevron { transform: rotate(180deg); color: #ff8500; }
        .btn-naranja { background-color: #ff8500; transition: all 0.3s; color: white; font-weight: 600; }
        .btn-naranja:hover { background-color: #e67700; transform: scale(1.02); }
        .admin-tab.active { background-color: #2a6aff; color: white; box-shadow: 0 4px 12px rgba(42, 106, 255, 0.3); }
        .sort-btn { cursor: pointer; transition: color 0.2s; }
        .sort-btn:hover { color: #2a6aff; }
        .filter-input { border: 1px solid #e2e8f0; border-radius: 8px; padding: 4px 8px; font-size: 12px; width: 100%; outline: none; font-weight: normal; margin-top: 4px; }
        .filter-input:focus { border-color: #2a6aff; }
    </style>
</head>
<body class="text-slate-800">

    <!-- Status Toast -->
    <div id="status-toast" class="fixed top-4 right-4 z-[100] hidden animate__animated animate__fadeInRight">
        <div class="px-6 py-3 rounded-xl shadow-lg flex items-center">
            <i class="fas fa-info-circle mr-3"></i>
            <span id="status-msg"></span>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="bg-white py-4 px-6 shadow-md sticky top-0 z-50 border-b border-slate-100" aria-label="Navegaci√≥n principal">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
        <a href="/" class="flex items-center">
            <img src="https://i.postimg.cc/KzxV7m0Z/CNCI-VIRTUAL-LOGO.jpg" alt="CNCI Logo" class="h-10 md:h-12 hover:opacity-90 transition-opacity">
        </a>

        <div class="hidden md:flex items-center space-x-8 text-sm font-semibold text-slate-600">
            <a href="https://www.office.com/" 
               target="_blank" 
               class="hover:text-blue-700 transition-colors duration-300">
               Office 365
            </a>
            
            <a href="https://cnci.unlimitedlearning.io/" 
               target="_blank" 
               rel="noopener noreferrer"
               class="hover:text-blue-700 transition-colors duration-300">
               Biblioteca
            </a>

            <a href="https://cnci.blackboard.com/ultra/" 
               target="_blank" 
               rel="noopener noreferrer"
               class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700 transition-all shadow-sm hover:shadow-md active:scale-95">
               Blackboard
            </a>
        </div>

        <div class="md:hidden">
            <button class="text-slate-600 focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                </svg>
            </button>
        </div>
    </div>
</nav>

    <!-- Header -->
    <header class="gradient-bg text-white pb-32 pt-20 px-4 relative overflow-hidden">
        <div class="max-w-4xl mx-auto text-center animate__animated animate__fadeInDown">
            <h1 class="text-4xl md:text-6xl font-extrabold mb-6 tracking-tight">Centro de Ayuda CNCI üéì</h1>
            <p class="text-blue-100 mb-10 text-lg md:text-xl opacity-90 max-w-2xl mx-auto">Encuentra respuestas inmediatas sobre tu proceso acad√©mico.</p>
            
            <div class="relative max-w-2xl mx-auto group">
                <input type="text" id="search-input" placeholder="¬øC√≥mo ingreso a Blackboard?..." 
                       class="w-full py-6 px-8 rounded-3xl text-slate-800 shadow-2xl focus:ring-4 focus:ring-cnciNaranja/30 outline-none transition-all text-lg pr-16">
                <div class="absolute right-4 top-1/2 -translate-y-1/2 w-12 h-12 bg-cnciAzul rounded-2xl flex items-center justify-center">
                    <i class="fas fa-search text-white"></i>
                </div>

                <div class="mt-6 text-center">
                    <button onclick="clearAllFilters()" class="bg-white/10 backdrop-blur-md border border-white/20 text-white px-6 py-2 rounded-full text-sm font-semibold hover:bg-cnciNaranja hover:border-cnciNaranja transition-all duration-300 flex items-center gap-2 mx-auto shadow-lg">
                        <i class="fas fa-filter-circle-xmark"></i>
                        Ver todas las preguntas / Limpiar filtros
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-4 -mt-20 mb-24 relative z-10">
        <div id="category-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 mb-16"></div>

        <div class="bg-white rounded-[3rem] shadow-2xl border border-white p-8 md:p-14">
            <div class="flex flex-col md:flex-row md:items-center justify-between mb-12 border-b border-slate-50 pb-8">
                <div>
                    <h2 id="section-title" class="text-3xl md:text-4xl font-black text-slate-800">Preguntas Frecuentes</h2>
                </div>
                <button onclick="clearAllFilters()" class="text-sm font-bold text-cnciAzul hover:bg-blue-50 px-4 py-2 rounded-xl transition-all">Ver todo</button>
            </div>

            <div id="faq-list" class="space-y-6"></div>
            
            <div id="pagination-container" class="mt-12 flex justify-center"></div>

            <div id="empty-search" class="hidden py-24 text-center">
                <div class="text-8xl mb-6 grayscale">üïµÔ∏è‚Äç‚ôÇÔ∏è</div>
                <p class="text-2xl font-bold text-slate-800 mb-2">No encontramos coincidencias</p>
                <button onclick="clearAllFilters()" class="btn-naranja px-8 py-3 rounded-2xl shadow-lg mt-4">Reiniciar b√∫squeda</button>
            </div>
        </div>
    </main>

    <!-- Admin Button -->
    <footer class="bg-slate-900 text-slate-500 py-16 px-6">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <img src="https://i.postimg.cc/KzxV7m0Z/CNCI-VIRTUAL-LOGO.jpg" alt="Logo" class="h-10 grayscale brightness-200">
            <button id="admin-lock-btn" class="bg-slate-800 hover:bg-slate-700 p-4 rounded-2xl transition-all">
                <i class="fas fa-user-shield text-slate-600 hover:text-cnciNaranja"></i>
            </button>
        </div>
    </footer>

    <!-- ADMIN MODAL -->
    <div id="admin-modal" class="fixed inset-0 bg-slate-950/80 backdrop-blur-md z-50 flex items-center justify-center hidden p-4">
        <div class="bg-white w-full max-w-7xl rounded-[3rem] shadow-2xl overflow-hidden max-h-[90vh] flex flex-col">
            
            <div class="p-8 border-b bg-slate-50 flex justify-between items-center">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-cnciAzul rounded-2xl flex items-center justify-center text-white mr-4 shadow-lg">
                        <i class="fas fa-tools text-xl"></i>
                    </div>
                    <h3 class="text-2xl font-black text-slate-800">Panel Administrativo</h3>
                </div>
                <button id="close-admin-btn" class="text-slate-400 hover:text-red-500 transition-all text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="flex-grow flex flex-col md:flex-row overflow-hidden">
                <!-- Sidebar -->
                <div class="w-full md:w-72 bg-slate-50 border-r p-6 space-y-2 overflow-y-auto">
                    <button onclick="switchAdminMainTab('faqs')" id="tab-faqs" class="admin-tab w-full text-left px-5 py-3 rounded-2xl font-bold flex items-center active"><i class="fas fa-question-circle mr-3"></i> Preguntas</button>
                    <button onclick="switchAdminMainTab('categories')" id="tab-categories" class="admin-tab w-full text-left px-5 py-3 rounded-2xl font-bold flex items-center"><i class="fas fa-th-large mr-3"></i> Secciones</button>
                    <button onclick="switchAdminMainTab('areas')" id="tab-areas" class="admin-tab w-full text-left px-5 py-3 rounded-2xl font-bold flex items-center"><i class="fas fa-building mr-3"></i> √Åreas</button>
                    <button onclick="switchAdminMainTab('stats')" id="tab-stats" class="admin-tab w-full text-left px-5 py-3 rounded-2xl font-bold flex items-center"><i class="fas fa-chart-bar mr-3"></i> Estad√≠sticas</button>
                    <button onclick="switchAdminMainTab('data')" id="tab-data" class="admin-tab w-full text-left px-5 py-3 rounded-2xl font-bold flex items-center"><i class="fas fa-file-import mr-3"></i> Datos (CSV)</button>
                </div>

                <!-- Admin Content Area -->
                <div class="flex-grow p-8 overflow-y-auto bg-white">
                    
                    <!-- VIEW: FAQS -->
                    <div id="view-faqs" class="admin-view space-y-6">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-xl font-bold">Gesti√≥n de Preguntas</h4>
                            <button onclick="openFaqForm()" class="bg-cnciAzul text-white px-5 py-2.5 rounded-xl font-bold text-sm shadow-md hover:scale-105 transition-transform">
                                <i class="fas fa-plus mr-2"></i> A√±adir Pregunta Individual
                            </button>
                        </div>
                        <div class="border rounded-3xl overflow-x-auto shadow-sm">
                            <table class="w-full text-left text-sm min-w-[700px]">
                                <thead class="bg-slate-50 text-slate-500 font-bold border-b">
                                    <tr>
                                        <th class="p-5">
                                            <div class="flex flex-col">
                                                <div class="flex items-center justify-between">
                                                    <span>Pregunta</span>
                                                    <i class="fas fa-sort sort-btn" onclick="sortFaqs('question')"></i>
                                                </div>
                                                <input type="text" placeholder="Filtrar..." class="filter-input" oninput="applyFaqFilters('question', this.value)">
                                            </div>
                                        </th>
                                        <th class="p-5 w-48">
                                            <div class="flex flex-col">
                                                <div class="flex items-center justify-between">
                                                    <span>Secci√≥n</span>
                                                    <i class="fas fa-sort sort-btn" onclick="sortFaqs('category')"></i>
                                                </div>
                                                <input type="text" placeholder="Filtrar..." class="filter-input" oninput="applyFaqFilters('category', this.value)">
                                            </div>
                                        </th>
                                        <th class="p-5 text-center w-24">
                                            <div class="flex flex-col items-center">
                                                <div class="flex items-center justify-between w-full">
                                                    <span>Likes</span>
                                                    <i class="fas fa-sort sort-btn" onclick="sortFaqs('likes')"></i>
                                                </div>
                                                <input type="text" placeholder="0" class="filter-input text-center" oninput="applyFaqFilters('likes', this.value)">
                                            </div>
                                        </th>
                                        <th class="p-5 text-right w-32">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-faqs-body" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- VIEW: CATEGORIES -->
                    <div id="view-categories" class="admin-view hidden space-y-6">
                        <div class="flex justify-between items-center">
                            <h4 class="text-xl font-bold">Gesti√≥n de Secciones</h4>
                            <button onclick="openCatForm()" class="btn-naranja px-6 py-2.5 rounded-xl shadow-lg text-sm">
                                <i class="fas fa-plus mr-2"></i> Nuevo Registro de Secci√≥n
                            </button>
                        </div>
                        <div class="border rounded-3xl overflow-hidden shadow-sm">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50 text-slate-500 font-bold border-b">
                                    <tr>
                                        <th class="p-5">Icono</th>
                                        <th class="p-5">Nombre</th>
                                        <th class="p-5 text-right">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-cats-body" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- VIEW: STATS -->
                    <div id="view-stats" class="admin-view hidden space-y-10">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                            <div class="bg-slate-50 p-8 rounded-[2.5rem]">
                                <h5 class="font-bold mb-6 flex items-center text-slate-700">
                                    <i class="fas fa-chart-pie mr-3 text-cnciAzul"></i> Preguntas por Secci√≥n
                                </h5>
                                <div class="h-64 flex items-center justify-center">
                                    <canvas id="chart-sections"></canvas>
                                </div>
                            </div>
                            <div class="bg-slate-50 p-8 rounded-[2.5rem]">
                                <h5 class="font-bold mb-6 flex items-center text-slate-700">
                                    <i class="fas fa-heart mr-3 text-cnciNaranja"></i> Top Likes por Pregunta
                                </h5>
                                <div class="h-64 flex items-center justify-center">
                                    <canvas id="chart-likes"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- VIEW: AREAS -->
                    <div id="view-areas" class="admin-view hidden space-y-6">
                        <div class="flex justify-between items-center">
                            <h4 class="text-xl font-bold">Gesti√≥n de √Åreas Universitarias</h4>
                            <button onclick="openAreaForm()" class="btn-naranja px-6 py-2.5 rounded-xl shadow-lg text-sm">
                                <i class="fas fa-plus mr-2"></i> Nueva √Årea
                            </button>
                        </div>
                        <div class="border rounded-3xl overflow-hidden shadow-sm">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50 text-slate-500 font-bold border-b">
                                    <tr>
                                        <th class="p-5">Nombre del √Årea</th>
                                        <th class="p-5 text-right">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-areas-body" class="divide-y divide-slate-100">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- VIEW: DATA -->
                    <div id="view-data" class="admin-view hidden space-y-10">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="bg-blue-50 p-8 rounded-[2rem] border border-blue-100">
                                <h5 class="text-xl font-bold mb-2">Exportar CSV</h5>
                                <button onclick="exportDataToCSV()" class="mt-4 bg-white text-cnciAzul border border-cnciAzul px-6 py-3 rounded-xl font-bold hover:bg-cnciAzul hover:text-white transition-all">Generar .CSV</button>
                            </div>
                            <div class="bg-orange-50 p-8 rounded-[2rem] border border-orange-100">
                                <h5 class="text-xl font-bold mb-2">Importar CSV</h5>
                                <input type="file" id="csv-upload" class="hidden" accept=".csv" onchange="importDataFromCSV(event)">
                                <button onclick="document.getElementById('csv-upload').click()" class="btn-naranja mt-4 px-6 py-3 rounded-xl">Seleccionar Archivo</button>
                            </div>
                        </div>
                    </div>

                    <!-- FORMS -->
                    <div id="admin-form-container" class="hidden animate__animated animate__fadeIn">
                        <button onclick="closeAdminForm()" class="mb-6 text-cnciAzul font-bold flex items-center"><i class="fas fa-arrow-left mr-2"></i> Volver</button>
                        
                        <div id="faq-form-block" class="hidden">
                            <h4 class="text-2xl font-black mb-8" id="faq-title-label">A√±adir Pregunta</h4>
                            <form id="faq-form" class="space-y-6 max-w-2xl">
                                <input type="hidden" id="form-faq-id">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-xs font-bold uppercase text-slate-400">Secci√≥n (Categor√≠a)</label>
                                        <select id="form-faq-category" class="w-full bg-slate-50 border p-4 rounded-2xl outline-none"></select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold uppercase text-slate-400">√Årea Universitaria</label>
                                        <select id="form-faq-area" class="w-full bg-slate-50 border p-4 rounded-2xl outline-none"></select>
                                    </div>
                                    <div class="col-span-2">
                                        <label class="text-xs font-bold uppercase text-slate-400">Pregunta</label>
                                        <input type="text" id="form-faq-question" required class="w-full bg-slate-50 border p-4 rounded-2xl outline-none">
                                    </div>
                                    
                                    <div class="col-span-2">
                                        <label class="text-xs font-bold uppercase text-slate-400">Respuesta Enriquecida</label>
                                        <div class="border rounded-2xl overflow-hidden bg-slate-50">
                                            <div class="bg-white border-b p-2 flex flex-wrap gap-1" id="editor-toolbar">
                                                <button type="button" onclick="formatDoc('bold')" class="w-8 h-8 hover:bg-slate-100 rounded text-slate-600" title="Negrita"><i class="fas fa-bold"></i></button>
                                                <button type="button" onclick="formatDoc('italic')" class="w-8 h-8 hover:bg-slate-100 rounded text-slate-600" title="Cursiva"><i class="fas fa-italic"></i></button>
                                                <button type="button" onclick="formatDoc('insertUnorderedList')" class="w-8 h-8 hover:bg-slate-100 rounded text-slate-600" title="Lista"><i class="fas fa-list-ul"></i></button>
                                                <button type="button" onclick="formatDoc('createLink')" class="w-8 h-8 hover:bg-slate-100 rounded text-slate-600" title="Link"><i class="fas fa-link"></i></button>
                                            </div>
                                            <div id="form-faq-answer-editor" contenteditable="true" class="p-4 min-h-[150px] outline-none bg-transparent prose prose-sm max-w-none" onpaste="handlePaste(event)"></div>
                                        </div>
                                    </div>
                                
                                    <div class="col-span-2 bg-slate-50 p-6 rounded-3xl border border-dashed border-slate-300 space-y-4">
                                        <p class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Recursos Multimedia (Opcional)</p>
                                        <div class="grid grid-cols-2 gap-4">
                                            <input type="url" id="form-faq-video" placeholder="ID o Link YouTube" class="w-full bg-white border p-3 rounded-xl text-sm outline-none">
                                            <input type="url" id="form-faq-image" placeholder="Link Imagen" class="w-full bg-white border p-3 rounded-xl text-sm outline-none">
                                            <input type="text" id="form-faq-btn-text" placeholder="Texto Bot√≥n" class="w-full bg-white border p-3 rounded-xl text-sm outline-none">
                                            <input type="url" id="form-faq-btn-url" placeholder="Link Bot√≥n" class="w-full bg-white border p-3 rounded-xl text-sm outline-none">
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="w-full btn-naranja py-4 rounded-2xl shadow-xl font-bold mt-4">Guardar Cambios</button>
                            </form>
                        </div>

                        <div id="cat-form-block" class="hidden">
                            <h4 class="text-2xl font-black mb-8" id="cat-title-label">Nueva Secci√≥n</h4>
                            <form id="cat-form" class="space-y-6 max-w-md">
                                <input type="hidden" id="form-cat-id">
                                <input type="text" id="form-cat-name" placeholder="Nombre (Ej: Ingreso)" required class="w-full bg-slate-50 border p-4 rounded-2xl outline-none">
                                <input type="text" id="form-cat-icon" placeholder="Icono (Ej: fas fa-user)" required class="w-full bg-slate-50 border p-4 rounded-2xl outline-none">
                                <input type="text" id="form-cat-color" placeholder="Color Borde (Ej: border-cnciAzul)" required class="w-full bg-slate-50 border p-4 rounded-2xl outline-none">
                                <button type="submit" class="w-full btn-naranja py-4 rounded-2xl">Guardar Secci√≥n</button>
                            </form>
                        </div>
                        <div id="area-form-block" class="hidden">
                            <h4 class="text-2xl font-black mb-8" id="area-title-label">Nueva √Årea Universitaria</h4>
                            <form id="area-form" class="space-y-6 max-w-md">
                                <input type="hidden" id="form-area-id">
                                <div>
                                    <label class="text-xs font-bold uppercase text-slate-400">Nombre del √Årea</label>
                                    <input type="text" id="form-area-name" placeholder="Ej: Cobranza" required class="w-full bg-slate-50 border p-4 rounded-2xl outline-none">
                                </div>
                                <button type="submit" class="w-full btn-naranja py-4 rounded-2xl shadow-lg font-bold">Guardar √Årea</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, deleteDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC8jIUPHKmcKy7eO1aq6eS4ZJ6kfq4zrBo",
            authDomain: "apppaneldesupcallcenter.firebaseapp.com",
            projectId: "apppaneldesupcallcenter",
            storageBucket: "apppaneldesupcallcenter.firebasestorage.app",
            messagingSenderId: "1091325080953",
            appId: "1:1091325080953:web:14fd225a15f532f92feba8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let faqData = [];
        let catData = [];
        let areaData = []; // Almacenar√° las √Åreas Universitarias
        let filteredFaqs = [];
        let faqSort = { field: 'question', order: 'asc' };
        let faqFilters = { question: '', category: '', likes: '' };
        let charts = {};

        // --- L√ìGICA DE EXPORTACI√ìN ---
        window.exportDataToCSV = () => {
            if (!faqData || faqData.length === 0) {
                alert("No hay datos para exportar");
                return;
            }
        
            // El secreto: A√±adimos el BOM de UTF-8 (\ufeff) al inicio del contenido
            let csvContent = "\ufeffquestion,answer,category,likes\n";
        
            faqData.forEach(faq => {
                // Limpiamos y escapamos las comillas dobles internas
                const q = `"${faq.question.replace(/"/g, '""')}"`;
                const a = `"${faq.answer.replace(/"/g, '""')}"`;
                const c = `"${faq.category}"`;
                const l = faq.likes || 0;
        
                csvContent += `${q},${a},${c},${l}\n`;
            });
        
            // Creamos el archivo con codificaci√≥n expl√≠cita UTF-8
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            const fecha = new Date().toISOString().split('T')[0];
            
            link.setAttribute("href", url);
            link.setAttribute("download", `respaldo_cnci_${fecha}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- L√ìGICA DE IMPORTACI√ìN MAESTRA (Punto 5 del Plan) ---
            window.importDataFromCSV = (event) => {
                const file = event.target.files[0];
                if (!file) return;
            
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const text = e.target.result;
                    
                    // Procesador robusto de CSV
                    const parseCSV = (str) => {
                        const rows = [];
                        let quote = false, col = '', row = [];
                        for (let c = 0; c < str.length; c++) {
                            let char = str[c], next = str[c+1];
                            if (char === '"' && quote && next === '"') { col += '"'; c++; continue; }
                            if (char === '"') { quote = !quote; continue; }
                            if (char === ',' && !quote) { row.push(col); col = ''; continue; }
                            if (char === '\r' || char === '\n') {
                                if (!quote) { 
                                    if (row.length > 0 || col !== '') { row.push(col); rows.push(row); }
                                    row = []; col = ''; 
                                } else { col += '\n'; }
                                continue;
                            }
                            col += char;
                        }
                        if (row.length > 0 || col !== '') { row.push(col); rows.push(row); }
                        return rows;
                    };
    
                    const data = parseCSV(text);
                    const header = data[0]; // Pregunta, Respuesta, Categor√≠a, √Årea, Video, Imagen, BtnTxt, BtnUrl
                    const rows = data.slice(1);
                    let count = 0;
    
                    for (let r of rows) {
                        if (r.length < 2) continue; // Saltar l√≠neas vac√≠as
                        
                        const [question, answer, catName, areaName, vUrl, iUrl, bTxt, bUrl] = r.map(i => i?.trim());
    
                        if (question && answer) {
                            // 1. Identificar Categor√≠a (ID amigable)
                            const categoryId = catName ? catName.toLowerCase().replace(/\s/g, '-') : 'general';
                            
                            // 2. L√≥gica de AUTO-CREACI√ìN de √Åreas (Punto 1.2 del Plan)
                            let areaId = "";
                            if (areaName) {
                                // Buscamos si el √°rea ya existe (sin importar may√∫sculas)
                                const existingArea = areaData.find(a => a.name.toLowerCase() === areaName.toLowerCase());
                                if (existingArea) {
                                    areaId = existingArea.id;
                                } else {
                                    // Si no existe, la creamos en milisegundos
                                    const newAreaRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'areas'), { 
                                        name: areaName 
                                    });
                                    areaId = newAreaRef.id;
                                    // Actualizamos nuestra lista local temporalmente para no duplicar en el mismo ciclo
                                    areaData.push({ id: areaId, name: areaName });
                                }
                            }
    
                            // 3. Guardar FAQ con toda la multimedia (Punto 3 del Plan)
                            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'faqs'), {
                                question: question,
                                answer: answer, // El editor ya lo recibir√° como HTML
                                categoryId: categoryId,
                                areaId: areaId,
                                videoUrl: vUrl || "",
                                imageUrl: iUrl || "",
                                btnText: bTxt || "",
                                btnUrl: bUrl || "",
                                likes: 0,
                                updatedAt: new Date()
                            });
                            count++;
                        }
                    }
                    alert(`¬°√âxito! Se importaron ${count} preguntas. El sistema vincul√≥ autom√°ticamente las √Åreas y Multimedia.`);
                    location.reload();
                };
                reader.readAsText(file, 'UTF-8');
            };
        // INIT
        const init = async () => {
            await signInAnonymously(auth);
            setupListeners();
        };

        const setupListeners = () => {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'categories'), (snap) => {
                catData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderCategoriesUI();
                renderAdminCats();
                updateFormSelectors();
                if (charts.sections) updateStatsCharts();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'faqs'), (snap) => {
                faqData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                applyAllFaqProcessing();
                renderFAQs(faqData);
                if (charts.likes) updateStatsCharts();
            });
            // Escuchar √Åreas Universitarias en tiempo real
            // --- ESCUCHAR √ÅREAS Y ACTUALIZAR TABLA/SELECTOR ---
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'areas'), (snapshot) => {
                const areasList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // 1. Actualizar la tabla de administraci√≥n de √Åreas
                const areasBody = document.getElementById('admin-areas-body');
                if (areasBody) {
                    areasBody.innerHTML = areasList.map(area => `
                        <tr>
                            <td class="p-5 font-medium">${area.name}</td>
                            <td class="p-5 text-right space-x-2">
                                <button onclick="editArea('${area.id}', '${area.name}')" class="text-blue-500 hover:bg-blue-50 p-2 rounded-lg transition-colors">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteAreaSafe('${area.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded-lg transition-colors">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }

                // 2. Actualizar el selector "√Årea Universitaria" en el formulario de FAQs
                const areaSelect = document.getElementById('form-faq-area');
                if (areaSelect) {
                    areaSelect.innerHTML = '<option value="">Seleccionar √Årea...</option>' + 
                        areasList.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
                }
            });
        };

        // --- NUEVO: Control de apertura ---
        let openedFaqId = null; 

        window.toggleFaq = (id, btn) => {
            const parent = btn.parentElement;
            const isOpening = !parent.classList.contains('active');
            
            // Cerramos otros (opcional, para que solo haya uno abierto)
            document.querySelectorAll('.accordion-item').forEach(item => item.classList.remove('active'));
            
            if (isOpening) {
                parent.classList.add('active');
                openedFaqId = id; // Memorizamos cu√°l se abri√≥
            } else {
                parent.classList.remove('active');
                openedFaqId = null; // Limpiamos si se cerr√≥ manualmente
            }
        };
        
        // UI PUBLIC: Renderizado de preguntas con Multimedia y √Åreas (Plan Maestro Completo)
        window.renderFAQs = () => {
            const list = document.getElementById('faq-list');
            const empty = document.getElementById('empty-search');
            const paginationContainer = document.getElementById('pagination-container');
            
            if (!list) return;

            let filtered = faqData.filter(faq => {
                const matchesCat = currentCategory === 'all' || faq.categoryId === currentCategory;
                if (searchTerm.trim().length < 3) return matchesCat;

                const normalize = (text) => 
                    (text || "").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

                const searchNormalized = normalize(searchTerm);
                const questionNormalized = normalize(faq.question);
                
                const tempDiv = document.createElement("div");
                tempDiv.innerHTML = faq.answer || "";
                const cleanText = tempDiv.textContent || tempDiv.innerText || "";
                const answerNormalized = normalize(cleanText);

                const words = searchNormalized.split(' ').filter(w => w.length > 0);
                const matchesSearch = words.every(word => 
                    questionNormalized.includes(word) || answerNormalized.includes(word)
                );

                return matchesCat && matchesSearch;
            });

            filtered.sort((a, b) => (b.likes || 0) - (a.likes || 0));

            const totalPages = Math.ceil(filtered.length / itemsPerPage);
            if (currentPage > totalPages) currentPage = 1;
            const startIndex = (currentPage - 1) * itemsPerPage;
            const paginatedItems = filtered.slice(startIndex, startIndex + itemsPerPage);

            list.innerHTML = '';
            if (filtered.length === 0) {
                if (empty) empty.classList.remove('hidden');
                if (paginationContainer) paginationContainer.innerHTML = '';
                return;
            }
            if (empty) empty.classList.add('hidden');

            paginatedItems.forEach((faq, index) => {
                const isTop = (faq.likes > 0 && currentPage === 1 && index === 0);
                const isActiveClass = (faq.id === openedFaqId) ? 'active' : '';
                
                const area = areaData.find(a => a.id === faq.areaId);
                const areaName = area ? area.name : 'General';
                const category = catData.find(c => c.id === faq.categoryId);
                const catName = category ? category.name : 'Varios';

                let videoHTML = '';
                if (faq.videoUrl) {
                    const videoId = faq.videoUrl.includes('v=') ? faq.videoUrl.split('v=')[1].split('&')[0] : faq.videoUrl.split('/').pop();
                    videoHTML = `<div class="mb-6 rounded-2xl overflow-hidden shadow-lg bg-black aspect-video">
                        <iframe width="100%" height="100%" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>
                    </div>`;
                }

                const div = document.createElement('div');
                div.className = `accordion-item border rounded-3xl overflow-hidden bg-white shadow-sm animate__animated animate__fadeIn ${isActiveClass}`;
                div.innerHTML = `
                    <button class="w-full flex items-center justify-between p-6 text-left" onclick="toggleFaq('${faq.id}', this)">
                        <span class="font-bold flex items-center pr-4">
                            <i class="fas fa-question-circle mr-3 text-cnciAzul"></i> 
                            ${faq.question}
                            ${isTop ? `<span class="ml-3 text-[10px] bg-orange-100 text-orange-600 px-2 py-1 rounded-lg flex items-center gap-1 border border-orange-200"><i class="fas fa-fire"></i> TOP</span>` : ''}
                        </span>
                        <i class="fas fa-chevron-down text-slate-300 chevron transition-all"></i>
                    </button>
                    <div class="accordion-content">
                        <div class="p-8 border-t bg-slate-50/30">
                            <div class="prose prose-sm max-w-none text-slate-600 mb-6">${faq.answer}</div>
                            ${videoHTML}
                            ${faq.imageUrl ? `<div class="mb-6"><img src="${faq.imageUrl}" class="rounded-2xl w-full object-cover shadow-md"></div>` : ''}
                            ${faq.btnUrl ? `<div class="mb-6"><a href="${faq.btnUrl}" target="_blank" class="inline-block bg-slate-800 text-white px-6 py-2.5 rounded-xl font-bold text-sm">${faq.btnText || 'Ver m√°s'}</a></div>` : ''}
                            <div class="mt-6 pt-6 border-t flex justify-between items-center">
                                <div class="flex flex-col gap-1">
                                    <span class="text-[9px] font-black uppercase text-slate-400">√Årea Universitaria: ${areaName}</span>
                                    <span class="text-[9px] font-bold text-cnciAzul uppercase">${catName}</span>
                                </div>
                                <button onclick="handleLike('${faq.id}', event)" class="px-4 py-2 rounded-full border bg-white flex items-center gap-2 hover:scale-105 transition-all shadow-sm">
                                    <i class="fas fa-heart ${faq.likes > 0 ? 'text-red-500' : 'text-slate-300'}"></i> 
                                    <span class="font-bold text-sm">${faq.likes || 0}</span>
                                </button>
                            </div>
                        </div>
                    </div>`;
                list.appendChild(div);
            });
                    
            // 4. RENDERIZADO DE BOTONCILLOS DE PAGINACI√ìN
            renderPagination(totalPages);
            };
        
        // Nueva funci√≥n de apoyo para los botones
        const renderPagination = (totalPages) => {
            let pagDiv = document.getElementById('pagination-container');
            if (!pagDiv) {
                pagDiv = document.createElement('div');
                pagDiv.id = 'pagination-container';
                document.getElementById('faq-list').after(pagDiv);
            }
            
            if (totalPages <= 1) {
                pagDiv.innerHTML = '';
                return;
            }
        
            let html = `<div class="flex justify-center items-center gap-2 mt-8 mb-12">`;
            for (let i = 1; i <= totalPages; i++) {
                const isActive = i === currentPage;
                html += `
                    <button onclick="changePage(${i})" 
                        class="w-10 h-10 rounded-xl border font-bold transition-all ${isActive ? 'bg-cnciAzul text-white border-cnciAzul shadow-lg' : 'bg-white text-slate-400 hover:border-cnciAzul hover:text-cnciAzul'}">
                        ${i}
                    </button>`;
            }
            html += `</div>`;
            pagDiv.innerHTML = html;
        };
        
        window.changePage = (num) => {
            currentPage = num;
            window.renderFAQs();
            
            // CAMBIO: Apuntamos directamente al contenedor del buscador o de la lista
            // Usamos 'faq-list' o el contenedor del buscador para que quede en el top visual
            const target = document.getElementById('search-container') || document.getElementById('faq-list');
            
            if (target) {
                window.scrollTo({ 
                    top: target.offsetTop - 100, // Restamos 100px para que no quede pegado al borde superior
                    behavior: 'smooth' 
                });
            }
        };
        const renderCategoriesUI = () => {
            const grid = document.getElementById('category-grid');
            if (!grid) return;
            grid.innerHTML = catData.map(cat => `
                <div onclick="filterByCat('${cat.id}')" class="category-card bg-white p-6 rounded-[2rem] shadow-lg text-center border-b-4 ${cat.colorClass} cursor-pointer">
                    <i class="${cat.iconClass} text-2xl mb-3 text-slate-600 block"></i>
                    <span class="font-bold text-slate-700">${cat.name}</span>
                </div>
            `).join('');
        };
        window.filterByCat = (id) => {
            currentCategory = id; 
            currentPage = 1;      // Reiniciamos a la primera p√°gina
            window.renderFAQs();  // Dibujamos con el nuevo filtro
            
            // Opcional: Desplazar suavemente hacia las preguntas
            document.getElementById('faq-list').scrollIntoView({ behavior: 'smooth', block: 'start' });
        };

        // ADMIN PROCESSING
        const applyAllFaqProcessing = () => {
            // 1. Filter
            filteredFaqs = faqData.filter(f => {
                const qMatch = f.question.toLowerCase().includes(faqFilters.question.toLowerCase());
                const cMatch = f.category.toLowerCase().includes(faqFilters.category.toLowerCase());
                const lMatch = f.likes.toString().includes(faqFilters.likes);
                return qMatch && cMatch && lMatch;
            });
            // 2. Sort
            filteredFaqs.sort((a, b) => {
                let valA = a[faqSort.field];
                let valB = b[faqSort.field];
                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }
                if (valA < valB) return faqSort.order === 'asc' ? -1 : 1;
                if (valA > valB) return faqSort.order === 'asc' ? 1 : -1;
                return 0;
            });
            renderAdminFaqs();
        };

        window.applyFaqFilters = (field, val) => {
            faqFilters[field] = val;
            applyAllFaqProcessing();
        };

        window.sortFaqs = (field) => {
            if (faqSort.field === field) {
                faqSort.order = faqSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                faqSort.field = field;
                faqSort.order = 'asc';
            }
            applyAllFaqProcessing();
        };

        const renderAdminFaqs = () => {
            const body = document.getElementById('admin-faqs-body');
            body.innerHTML = filteredFaqs.map(f => `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="p-5 font-medium">${f.question}</td>
                    <td class="p-5 text-[10px] font-black uppercase text-slate-400">${f.category}</td>
                    <td class="p-5 text-center font-bold text-cnciNaranja">${f.likes || 0}</td>
                    <td class="p-5 text-right whitespace-nowrap">
                        <button onclick="editFaq('${f.id}')" class="p-2 text-cnciAzul"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteFaq('${f.id}')" class="p-2 text-red-400"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        };

        const renderAdminCats = () => {
            const body = document.getElementById('admin-cats-body');
            body.innerHTML = catData.map(c => `
                <tr class="hover:bg-slate-50">
                    <td class="p-5"><i class="${c.iconClass} text-slate-400"></i></td>
                    <td class="p-5 font-bold">${c.name}</td>
                    <td class="p-5 text-right">
                        <button onclick="editCat('${c.id}')" class="p-2 text-cnciAzul"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteCat('${c.id}')" class="p-2 text-red-400"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        };

        // STATS
        const updateStatsCharts = () => {
            // Chart Sections
            const secCounts = {};
            catData.forEach(c => secCounts[c.id] = 0);
            faqData.forEach(f => { if(secCounts[f.category] !== undefined) secCounts[f.category]++; });

            const ctx1 = document.getElementById('chart-sections').getContext('2d');
            if (charts.sections) charts.sections.destroy();
            charts.sections = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: Object.keys(secCounts).map(id => catData.find(c => c.id === id)?.name || id),
                    datasets: [{
                        label: 'Preguntas',
                        data: Object.values(secCounts),
                        backgroundColor: '#2a6aff',
                        borderRadius: 8
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Chart Likes
            const topLikes = [...faqData].sort((a,b) => (b.likes||0) - (a.likes||0)).slice(0, 5);
            const ctx2 = document.getElementById('chart-likes').getContext('2d');
            if (charts.likes) charts.likes.destroy();
            charts.likes = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: topLikes.map(f => f.question.substring(0, 15) + '...'),
                    datasets: [{
                        label: 'Votos √∫tiles',
                        data: topLikes.map(f => f.likes || 0),
                        backgroundColor: '#ff8500',
                        borderRadius: 8
                    }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false }
            });
        };

        // TABS & FORMS
        window.switchAdminMainTab = (tab) => {
            // 1. Gestionar botones del sidebar
            document.querySelectorAll('.admin-tab').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
        
            // 2. Ocultar todas las vistas y el contenedor de formularios
            document.querySelectorAll('.admin-view').forEach(v => v.classList.add('hidden'));
            document.getElementById('admin-form-container').classList.add('hidden');
        
            // 3. Mostrar la vista seleccionada
            document.getElementById(`view-${tab}`).classList.remove('hidden');
        };
        window.formatDoc = (cmd, value = null) => {
            document.execCommand(cmd, false, value);
            document.getElementById('form-faq-answer-editor').focus();
        };
        window.openAreaForm = () => {
            document.querySelectorAll('.admin-view').forEach(v => v.classList.add('hidden'));
            document.getElementById('admin-form-container').classList.remove('hidden');
            document.getElementById('faq-form-block').classList.add('hidden');
            document.getElementById('cat-form-block').classList.add('hidden');
            document.getElementById('area-form-block').classList.remove('hidden');
            
            document.getElementById('area-form').reset();
            document.getElementById('form-area-id').value = '';
            document.getElementById('area-title-label').innerText = 'Nueva √Årea Universitaria';
        };
        
        // Listener para el formulario de √Åreas
            document.getElementById('area-form').onsubmit = async (e) => {
                e.preventDefault();
                const id = document.getElementById('form-area-id').value;
                const areaData = {
                    name: document.getElementById('form-area-name').value
                };
            
                try {
                    if (id) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'areas', id), areaData);
                    } else {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'areas'), areaData);
                    }
                    alert("√Årea guardada con √©xito");
                    switchAdminMainTab('areas');
                } catch (error) {
                    console.error("Error al guardar √°rea:", error);
                }
            };
        window.openAreaForm = () => {
            document.querySelectorAll('.admin-view').forEach(v => v.classList.add('hidden'));
            document.getElementById('admin-form-container').classList.remove('hidden');
            document.getElementById('faq-form-block').classList.add('hidden');
            document.getElementById('cat-form-block').classList.add('hidden');
            document.getElementById('area-form-block').classList.remove('hidden');
            
            document.getElementById('area-form').reset();
            document.getElementById('form-area-id').value = '';
            document.getElementById('area-title-label').innerText = 'Nueva √Årea Universitaria';
        };
        
                            
        // Limpia el texto pegado para evitar que traiga estilos raros de Word o webs
        window.handlePaste = (e) => {
            e.preventDefault();
            const text = e.clipboardData.getData('text/plain');
            document.execCommand('insertText', false, text);
        };

        window.openFaqForm = () => {
            document.getElementById('view-faqs').classList.add('hidden');
            document.getElementById('admin-form-container').classList.remove('hidden');
            document.getElementById('faq-form-block').classList.remove('hidden');
            document.getElementById('cat-form-block').classList.add('hidden');
            document.getElementById('faq-form').reset();
            document.getElementById('form-faq-id').value = '';
        };

        window.openCatForm = () => {
            document.getElementById('view-categories').classList.add('hidden');
            document.getElementById('admin-form-container').classList.remove('hidden');
            document.getElementById('cat-form-block').classList.remove('hidden');
            document.getElementById('faq-form-block').classList.add('hidden');
            document.getElementById('cat-form').reset();
            document.getElementById('form-cat-id').value = '';
        };

        window.closeAdminForm = () => {
            document.getElementById('admin-form-container').classList.add('hidden');
            document.getElementById('view-faqs').classList.add('hidden');
            document.getElementById('view-categories').classList.add('hidden');
            document.getElementById('view-stats').classList.add('hidden');
            document.getElementById('view-data').classList.add('hidden');
            
            const activeTab = document.querySelector('.admin-tab.active').id.replace('tab-', '');
            document.getElementById(`view-${activeTab}`).classList.remove('hidden');
        };
        // CRUD: Guardado de Preguntas (Actualizado con Multimedia y Editor)
        document.getElementById('faq-form').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('form-faq-id').value;
            
            // Recopilamos todos los nuevos campos
            const data = {
                question: document.getElementById('form-faq-question').value,
                // Usamos innerHTML para guardar las negritas y links del editor
                answer: document.getElementById('form-faq-answer-editor').innerHTML, 
                categoryId: document.getElementById('form-faq-category').value,
                areaId: document.getElementById('form-faq-area').value,
                videoUrl: document.getElementById('form-faq-video').value,
                imageUrl: document.getElementById('form-faq-image').value,
                btnText: document.getElementById('form-faq-btn-text').value,
                btnUrl: document.getElementById('form-faq-btn-url').value,
                likes: id ? (faqData.find(f => f.id === id)?.likes || 0) : 0,
                updatedAt: new Date()
            };

            try {
                if (id) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'faqs', id), data);
                } else {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'faqs'), data);
                }
                alert("Pregunta guardada correctamente");
                closeAdminForm();
                location.reload(); // Recargamos para que se vean los cambios multimedia
            } catch (error) {
                console.error("Error al guardar FAQ:", error);
                alert("Hubo un error al guardar");
            }
        };

        document.getElementById('cat-form').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('form-cat-id').value;
            const name = document.getElementById('form-cat-name').value;
            const cid = id || name.toLowerCase().replace(/\s/g, '-');
            const data = {
                id: cid,
                name: name,
                iconClass: document.getElementById('form-cat-icon').value,
                colorClass: document.getElementById('form-cat-color').value
            };
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', cid), data);
            closeAdminForm();
        };

        window.editFaq = (id) => {
            const f = faqData.find(f => f.id === id);
            openFaqForm();
            document.getElementById('form-faq-id').value = f.id;
            document.getElementById('form-faq-question').value = f.question;
            document.getElementById('form-faq-answer').value = f.answer;
            document.getElementById('form-faq-category').value = f.category;
            document.getElementById('faq-title-label').innerText = "Editar Pregunta";
        };

        window.editCat = (id) => {
            const c = catData.find(c => c.id === id);
            openCatForm();
            document.getElementById('form-cat-id').value = c.id;
            document.getElementById('form-cat-name').value = c.name;
            document.getElementById('form-cat-icon').value = c.iconClass;
            document.getElementById('form-cat-color').value = c.colorClass;
        };

        window.deleteFaq = async (id) => { if(confirm("¬øEliminar?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'faqs', id)); };
        window.deleteCat = async (id) => { if(confirm("¬øEliminar secci√≥n?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', id)); };

        const updateFormSelectors = () => {
            const sel = document.getElementById('form-faq-category');
            sel.innerHTML = catData.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        };

        window.handleLike = async (id, e) => {
    // ESTO ES LO M√ÅS IMPORTANTE:
    // Evita que el clic llegue al bot√≥n del acorde√≥n y lo cierre
            if (e) {
                e.preventDefault();
                e.stopPropagation();
            }
        
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'faqs', id), { 
                    likes: increment(1) 
                });
                // Nota: No necesitas recargar la p√°gina, Firestore en tiempo real 
                // deber√≠a detectar el cambio y renderizar de nuevo.
            } catch (error) {
                console.error("Error al dar like:", error);
            }
        };

        // --- L√ìGICA DE FILTRADO Y LIMPIEZA ---

        window.clearAllFilters = () => {
            searchTerm = '';
            currentCategory = 'all';
            currentPage = 1;
            const input = document.getElementById('search-input');
            if (input) input.value = '';
            const title = document.getElementById('section-title');
            if (title) title.innerText = 'Preguntas Frecuentes';
            window.renderFAQs();
        };

        window.filterByCat = (catId) => {
            currentCategory = catId;
            currentPage = 1;
            const title = document.getElementById('section-title');
            const category = catData.find(c => c.id === catId);
            if (title && category) title.innerText = category.name;
            window.renderFAQs();
        };

        // --- ACCESO ADMINISTRADOR ---

        document.getElementById('admin-lock-btn').onclick = () => {
            if (prompt("Clave:") === "cnci2026") document.getElementById('admin-modal').classList.remove('hidden');
        };
        document.getElementById('close-admin-btn').onclick = () => document.getElementById('admin-modal').classList.add('hidden');

        // --- INICIALIZACI√ìN ---

        init();

        // Escuchar la barra de b√∫squeda
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                searchTerm = e.target.value; 
                currentPage = 1;
                window.renderFAQs();
            });
        }
        // FUNCI√ìN DE SEGURIDAD: Borrado de √°reas (Punto 1.3 del Plan)
        window.deleteAreaSafe = async (id) => {
            // Verificamos si existe alguna FAQ que use este areaId
            const hasFaqs = faqData.some(f => f.areaId === id);
            
            if (hasFaqs) {
                alert("‚ùå SEGURIDAD: No puedes eliminar esta √°rea porque tiene preguntas vinculadas. Reasigna las preguntas a otra √°rea antes de borrarla.");
            } else {
                if (confirm("¬øEst√°s seguro de eliminar esta √°rea? Esta acci√≥n no se puede deshacer.")) {
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'areas', id));
                        alert("√Årea eliminada correctamente.");
                    } catch (error) {
                        console.error("Error al eliminar:", error);
                    }
                }
            }
        };
    </script>
</body>
</html>
