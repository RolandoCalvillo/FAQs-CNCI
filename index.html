<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Ayuda - Universidad CNCI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>

    <script>
        window.tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cnciAzul: '#2a6aff',
                        cnciNaranja: '#ff8500',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; background-color: #f4f7fe; overflow-x: hidden; }
        .gradient-bg { background: linear-gradient(135deg, #2a6aff 0%, #1a49b8 100%); }
        .category-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; }
        .category-card:hover { transform: translateY(-8px); border-color: #ff8500; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out; }
        .accordion-item.active .accordion-content { max-height: 1500px; }
        .accordion-item.active .chevron { transform: rotate(180deg); color: #ff8500; }
        .btn-naranja { background-color: #ff8500; transition: all 0.3s; color: white; font-weight: 600; }
        .btn-naranja:hover { background-color: #e67700; transform: scale(1.02); }
        .admin-tab.active { background-color: #2a6aff; color: white; box-shadow: 0 4px 12px rgba(42, 106, 255, 0.3); }
        .sort-btn { cursor: pointer; transition: color 0.2s; }
        .sort-btn:hover { color: #2a6aff; }
        .filter-input { border: 1px solid #e2e8f0; border-radius: 8px; padding: 4px 8px; font-size: 12px; width: 100%; outline: none; font-weight: normal; margin-top: 4px; }
        .filter-input:focus { border-color: #2a6aff; }
    </style>
</head>
<body class="text-slate-800">

    <!-- Status Toast -->
    <div id="status-toast" class="fixed top-4 right-4 z-[100] hidden animate__animated animate__fadeInRight">
        <div class="px-6 py-3 rounded-xl shadow-lg flex items-center">
            <i class="fas fa-info-circle mr-3"></i>
            <span id="status-msg"></span>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="bg-white py-4 px-6 shadow-sm sticky top-0 z-40">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <img src="https://i.postimg.cc/KzxV7m0Z/CNCI-VIRTUAL-LOGO.jpg" alt="CNCI Logo" class="h-10 md:h-12">
            <div class="hidden md:flex space-x-6 text-sm font-semibold text-slate-600">
                <a href="#" class="hover:text-cnciAzul transition-colors">Portal Alumnos</a>
                <a href="#" class="hover:text-cnciAzul transition-colors">Biblioteca</a>
                <a href="#" class="hover:text-cnciAzul transition-colors">Blackboard</a>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <header class="gradient-bg text-white pb-32 pt-20 px-4 relative overflow-hidden">
        <div class="max-w-4xl mx-auto text-center animate__animated animate__fadeInDown">
            <h1 class="text-4xl md:text-6xl font-extrabold mb-6 tracking-tight">Centro de Ayuda CNCI üéì</h1>
            <p class="text-blue-100 mb-10 text-lg md:text-xl opacity-90 max-w-2xl mx-auto">Encuentra respuestas inmediatas sobre tu proceso acad√©mico.</p>
            <div class="relative max-w-2xl mx-auto group">
                <input type="text" id="search-input" placeholder="¬øC√≥mo ingreso a Blackboard?..." 
                       class="w-full py-6 px-8 rounded-3xl text-slate-800 shadow-2xl focus:ring-4 focus:ring-cnciNaranja/30 outline-none transition-all text-lg pr-16">
                <div class="absolute right-4 top-1/2 -translate-y-1/2 w-12 h-12 bg-cnciAzul rounded-2xl flex items-center justify-center">
                    <i class="fas fa-search text-white"></i>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-4 -mt-20 mb-24 relative z-10">
        <div id="category-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 mb-16"></div>

        <div class="bg-white rounded-[3rem] shadow-2xl border border-white p-8 md:p-14">
            <div class="flex flex-col md:flex-row md:items-center justify-between mb-12 border-b border-slate-50 pb-8">
                <div>
                    <h2 id="section-title" class="text-3xl md:text-4xl font-black text-slate-800">Preguntas Frecuentes</h2>
                    <p class="text-slate-400 mt-2 font-medium flex items-center"><span class="w-2 h-2 bg-emerald-500 rounded-full mr-2 animate-pulse"></span> Sincronizaci√≥n en tiempo real</p>
                </div>
                <button onclick="renderFAQs(faqData)" class="text-sm font-bold text-cnciAzul hover:bg-blue-50 px-4 py-2 rounded-xl transition-all">Ver todo</button>
            </div>

            <div id="faq-list" class="space-y-6"></div>
            <div id="empty-search" class="hidden py-24 text-center">
                <div class="text-8xl mb-6 grayscale">üïµÔ∏è‚Äç‚ôÇÔ∏è</div>
                <p class="text-2xl font-bold text-slate-800 mb-2">No encontramos coincidencias</p>
                <button onclick="location.reload()" class="btn-naranja px-8 py-3 rounded-2xl shadow-lg mt-4">Reiniciar</button>
            </div>
        </div>
    </main>

    <!-- Admin Button -->
    <footer class="bg-slate-900 text-slate-500 py-16 px-6">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <img src="https://i.postimg.cc/KzxV7m0Z/CNCI-VIRTUAL-LOGO.jpg" alt="Logo" class="h-10 grayscale brightness-200">
            <button id="admin-lock-btn" class="bg-slate-800 hover:bg-slate-700 p-4 rounded-2xl transition-all">
                <i class="fas fa-user-shield text-slate-600 hover:text-cnciNaranja"></i>
            </button>
        </div>
    </footer>

    <!-- ADMIN MODAL -->
    <div id="admin-modal" class="fixed inset-0 bg-slate-950/80 backdrop-blur-md z-50 flex items-center justify-center hidden p-4">
        <div class="bg-white w-full max-w-7xl rounded-[3rem] shadow-2xl overflow-hidden max-h-[90vh] flex flex-col">
            
            <div class="p-8 border-b bg-slate-50 flex justify-between items-center">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-cnciAzul rounded-2xl flex items-center justify-center text-white mr-4 shadow-lg">
                        <i class="fas fa-tools text-xl"></i>
                    </div>
                    <h3 class="text-2xl font-black text-slate-800">Panel Administrativo</h3>
                </div>
                <button id="close-admin-btn" class="text-slate-400 hover:text-red-500 transition-all text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="flex-grow flex flex-col md:flex-row overflow-hidden">
                <!-- Sidebar -->
                <div class="w-full md:w-72 bg-slate-50 border-r p-6 space-y-2 overflow-y-auto">
                    <button onclick="switchAdminMainTab('faqs')" id="tab-faqs" class="admin-tab w-full text-left px-5 py-3 rounded-2xl font-bold flex items-center active"><i class="fas fa-question-circle mr-3"></i> Preguntas</button>
                    <button onclick="switchAdminMainTab('categories')" id="tab-categories" class="admin-tab w-full text-left px-5 py-3 rounded-2xl font-bold flex items-center"><i class="fas fa-th-large mr-3"></i> Secciones</button>
                    <button onclick="switchAdminMainTab('stats')" id="tab-stats" class="admin-tab w-full text-left px-5 py-3 rounded-2xl font-bold flex items-center"><i class="fas fa-chart-bar mr-3"></i> Estad√≠sticas</button>
                    <button onclick="switchAdminMainTab('data')" id="tab-data" class="admin-tab w-full text-left px-5 py-3 rounded-2xl font-bold flex items-center"><i class="fas fa-file-import mr-3"></i> Datos (CSV)</button>
                </div>

                <!-- Admin Content Area -->
                <div class="flex-grow p-8 overflow-y-auto bg-white">
                    
                    <!-- VIEW: FAQS -->
                    <div id="view-faqs" class="admin-view space-y-6">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-xl font-bold">Gesti√≥n de Preguntas</h4>
                            <button onclick="openFaqForm()" class="bg-cnciAzul text-white px-5 py-2.5 rounded-xl font-bold text-sm shadow-md hover:scale-105 transition-transform">
                                <i class="fas fa-plus mr-2"></i> A√±adir Pregunta Individual
                            </button>
                        </div>
                        <div class="border rounded-3xl overflow-x-auto shadow-sm">
                            <table class="w-full text-left text-sm min-w-[700px]">
                                <thead class="bg-slate-50 text-slate-500 font-bold border-b">
                                    <tr>
                                        <th class="p-5">
                                            <div class="flex flex-col">
                                                <div class="flex items-center justify-between">
                                                    <span>Pregunta</span>
                                                    <i class="fas fa-sort sort-btn" onclick="sortFaqs('question')"></i>
                                                </div>
                                                <input type="text" placeholder="Filtrar..." class="filter-input" oninput="applyFaqFilters('question', this.value)">
                                            </div>
                                        </th>
                                        <th class="p-5 w-48">
                                            <div class="flex flex-col">
                                                <div class="flex items-center justify-between">
                                                    <span>Secci√≥n</span>
                                                    <i class="fas fa-sort sort-btn" onclick="sortFaqs('category')"></i>
                                                </div>
                                                <input type="text" placeholder="Filtrar..." class="filter-input" oninput="applyFaqFilters('category', this.value)">
                                            </div>
                                        </th>
                                        <th class="p-5 text-center w-24">
                                            <div class="flex flex-col items-center">
                                                <div class="flex items-center justify-between w-full">
                                                    <span>Likes</span>
                                                    <i class="fas fa-sort sort-btn" onclick="sortFaqs('likes')"></i>
                                                </div>
                                                <input type="text" placeholder="0" class="filter-input text-center" oninput="applyFaqFilters('likes', this.value)">
                                            </div>
                                        </th>
                                        <th class="p-5 text-right w-32">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-faqs-body" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- VIEW: CATEGORIES -->
                    <div id="view-categories" class="admin-view hidden space-y-6">
                        <div class="flex justify-between items-center">
                            <h4 class="text-xl font-bold">Gesti√≥n de Secciones</h4>
                            <button onclick="openCatForm()" class="btn-naranja px-6 py-2.5 rounded-xl shadow-lg text-sm">
                                <i class="fas fa-plus mr-2"></i> Nuevo Registro de Secci√≥n
                            </button>
                        </div>
                        <div class="border rounded-3xl overflow-hidden shadow-sm">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50 text-slate-500 font-bold border-b">
                                    <tr>
                                        <th class="p-5">Icono</th>
                                        <th class="p-5">Nombre</th>
                                        <th class="p-5 text-right">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-cats-body" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- VIEW: STATS -->
                    <div id="view-stats" class="admin-view hidden space-y-10">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                            <div class="bg-slate-50 p-8 rounded-[2.5rem]">
                                <h5 class="font-bold mb-6 flex items-center text-slate-700">
                                    <i class="fas fa-chart-pie mr-3 text-cnciAzul"></i> Preguntas por Secci√≥n
                                </h5>
                                <div class="h-64 flex items-center justify-center">
                                    <canvas id="chart-sections"></canvas>
                                </div>
                            </div>
                            <div class="bg-slate-50 p-8 rounded-[2.5rem]">
                                <h5 class="font-bold mb-6 flex items-center text-slate-700">
                                    <i class="fas fa-heart mr-3 text-cnciNaranja"></i> Top Likes por Pregunta
                                </h5>
                                <div class="h-64 flex items-center justify-center">
                                    <canvas id="chart-likes"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- VIEW: DATA -->
                    <div id="view-data" class="admin-view hidden space-y-10">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="bg-blue-50 p-8 rounded-[2rem] border border-blue-100">
                                <h5 class="text-xl font-bold mb-2">Exportar CSV</h5>
                                <button onclick="exportDataToCSV()" class="mt-4 bg-white text-cnciAzul border border-cnciAzul px-6 py-3 rounded-xl font-bold hover:bg-cnciAzul hover:text-white transition-all">Generar .CSV</button>
                            </div>
                            <div class="bg-orange-50 p-8 rounded-[2rem] border border-orange-100">
                                <h5 class="text-xl font-bold mb-2">Importar CSV</h5>
                                <input type="file" id="csv-upload" class="hidden" accept=".csv" onchange="importDataFromCSV(event)">
                                <button onclick="document.getElementById('csv-upload').click()" class="btn-naranja mt-4 px-6 py-3 rounded-xl">Seleccionar Archivo</button>
                            </div>
                        </div>
                    </div>

                    <!-- FORMS -->
                    <div id="admin-form-container" class="hidden animate__animated animate__fadeIn">
                        <button onclick="closeAdminForm()" class="mb-6 text-cnciAzul font-bold flex items-center"><i class="fas fa-arrow-left mr-2"></i> Volver</button>
                        
                        <div id="faq-form-block" class="hidden">
                            <h4 class="text-2xl font-black mb-8" id="faq-title-label">A√±adir Pregunta</h4>
                            <form id="faq-form" class="space-y-6 max-w-2xl">
                                <input type="hidden" id="form-faq-id">
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="col-span-2">
                                        <label class="text-xs font-bold uppercase text-slate-400">Secci√≥n</label>
                                        <select id="form-faq-category" class="w-full bg-slate-50 border p-4 rounded-2xl outline-none"></select>
                                    </div>
                                    <div class="col-span-2">
                                        <label class="text-xs font-bold uppercase text-slate-400">Pregunta</label>
                                        <input type="text" id="form-faq-question" required class="w-full bg-slate-50 border p-4 rounded-2xl outline-none">
                                    </div>
                                    <div class="col-span-2">
                                        <label class="text-xs font-bold uppercase text-slate-400">Respuesta</label>
                                        <textarea id="form-faq-answer" required rows="4" class="w-full bg-slate-50 border p-4 rounded-2xl outline-none"></textarea>
                                    </div>
                                </div>
                                <button type="submit" class="w-full btn-naranja py-4 rounded-2xl shadow-xl">Guardar Pregunta</button>
                            </form>
                        </div>

                        <div id="cat-form-block" class="hidden">
                            <h4 class="text-2xl font-black mb-8" id="cat-title-label">Nueva Secci√≥n</h4>
                            <form id="cat-form" class="space-y-6 max-w-md">
                                <input type="hidden" id="form-cat-id">
                                <input type="text" id="form-cat-name" placeholder="Nombre (Ej: Ingreso)" required class="w-full bg-slate-50 border p-4 rounded-2xl outline-none">
                                <input type="text" id="form-cat-icon" placeholder="Icono (Ej: fas fa-user)" required class="w-full bg-slate-50 border p-4 rounded-2xl outline-none">
                                <input type="text" id="form-cat-color" placeholder="Color Borde (Ej: border-cnciAzul)" required class="w-full bg-slate-50 border p-4 rounded-2xl outline-none">
                                <button type="submit" class="w-full btn-naranja py-4 rounded-2xl">Guardar Secci√≥n</button>
                            </form>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, deleteDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC8jIUPHKmcKy7eO1aq6eS4ZJ6kfq4zrBo",
            authDomain: "apppaneldesupcallcenter.firebaseapp.com",
            projectId: "apppaneldesupcallcenter",
            storageBucket: "apppaneldesupcallcenter.firebasestorage.app",
            messagingSenderId: "1091325080953",
            appId: "1:1091325080953:web:14fd225a15f532f92feba8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let faqData = [];
        let catData = [];
        let filteredFaqs = [];
        let faqSort = { field: 'question', order: 'asc' };
        let faqFilters = { question: '', category: '', likes: '' };
        let charts = {};

        // INIT
        const init = async () => {
            await signInAnonymously(auth);
            setupListeners();
        };

        const setupListeners = () => {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'categories'), (snap) => {
                catData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderCategoriesUI();
                renderAdminCats();
                updateFormSelectors();
                if (charts.sections) updateStatsCharts();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'faqs'), (snap) => {
                faqData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                applyAllFaqProcessing();
                renderFAQs(faqData);
                if (charts.likes) updateStatsCharts();
            });
        };

        // UI PUBLIC
        window.renderFAQs = (data) => {
            const list = document.getElementById('faq-list');
            const empty = document.getElementById('empty-search');
            list.innerHTML = '';
            
            if (data.length === 0) { empty.classList.remove('hidden'); return; }
            empty.classList.add('hidden');

            data.forEach(faq => {
                const div = document.createElement('div');
                div.className = "accordion-item border rounded-3xl overflow-hidden bg-white shadow-sm";
                div.innerHTML = `
                    <button class="w-full flex items-center justify-between p-6 text-left" onclick="this.parentElement.classList.toggle('active')">
                        <span class="font-bold flex items-center"><i class="fas fa-question-circle mr-3 text-cnciAzul"></i> ${faq.question}</span>
                        <i class="fas fa-chevron-down text-slate-300 chevron transition-all"></i>
                    </button>
                    <div class="accordion-content">
                        <div class="p-8 border-t bg-slate-50/30">
                            <p class="leading-relaxed text-slate-600">${faq.answer}</p>
                            <div class="mt-6 flex justify-between items-center">
                                <span class="text-[10px] font-black uppercase text-slate-400">${faq.category}</span>
                                <button onclick="handleLike('${faq.id}', event)" class="px-4 py-2 rounded-full border bg-white flex items-center gap-2 hover:text-cnciNaranja transition-all">
                                    <i class="fas fa-heart"></i> <span>${faq.likes || 0}</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });
        };

        const renderCategoriesUI = () => {
            const grid = document.getElementById('category-grid');
            grid.innerHTML = catData.map(cat => `
                <div onclick="filterByCat('${cat.id}')" class="category-card bg-white p-6 rounded-[2rem] shadow-lg text-center border-b-4 ${cat.colorClass}">
                    <i class="${cat.iconClass} text-2xl mb-3 text-slate-600 block"></i>
                    <span class="font-bold text-slate-700">${cat.name}</span>
                </div>
            `).join('');
        };

        // ADMIN PROCESSING
        const applyAllFaqProcessing = () => {
            // 1. Filter
            filteredFaqs = faqData.filter(f => {
                const qMatch = f.question.toLowerCase().includes(faqFilters.question.toLowerCase());
                const cMatch = f.category.toLowerCase().includes(faqFilters.category.toLowerCase());
                const lMatch = f.likes.toString().includes(faqFilters.likes);
                return qMatch && cMatch && lMatch;
            });
            // 2. Sort
            filteredFaqs.sort((a, b) => {
                let valA = a[faqSort.field];
                let valB = b[faqSort.field];
                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }
                if (valA < valB) return faqSort.order === 'asc' ? -1 : 1;
                if (valA > valB) return faqSort.order === 'asc' ? 1 : -1;
                return 0;
            });
            renderAdminFaqs();
        };

        window.applyFaqFilters = (field, val) => {
            faqFilters[field] = val;
            applyAllFaqProcessing();
        };

        window.sortFaqs = (field) => {
            if (faqSort.field === field) {
                faqSort.order = faqSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                faqSort.field = field;
                faqSort.order = 'asc';
            }
            applyAllFaqProcessing();
        };

        const renderAdminFaqs = () => {
            const body = document.getElementById('admin-faqs-body');
            body.innerHTML = filteredFaqs.map(f => `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="p-5 font-medium">${f.question}</td>
                    <td class="p-5 text-[10px] font-black uppercase text-slate-400">${f.category}</td>
                    <td class="p-5 text-center font-bold text-cnciNaranja">${f.likes || 0}</td>
                    <td class="p-5 text-right whitespace-nowrap">
                        <button onclick="editFaq('${f.id}')" class="p-2 text-cnciAzul"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteFaq('${f.id}')" class="p-2 text-red-400"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        };

        const renderAdminCats = () => {
            const body = document.getElementById('admin-cats-body');
            body.innerHTML = catData.map(c => `
                <tr class="hover:bg-slate-50">
                    <td class="p-5"><i class="${c.iconClass} text-slate-400"></i></td>
                    <td class="p-5 font-bold">${c.name}</td>
                    <td class="p-5 text-right">
                        <button onclick="editCat('${c.id}')" class="p-2 text-cnciAzul"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteCat('${c.id}')" class="p-2 text-red-400"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        };

        // STATS
        const updateStatsCharts = () => {
            // Chart Sections
            const secCounts = {};
            catData.forEach(c => secCounts[c.id] = 0);
            faqData.forEach(f => { if(secCounts[f.category] !== undefined) secCounts[f.category]++; });

            const ctx1 = document.getElementById('chart-sections').getContext('2d');
            if (charts.sections) charts.sections.destroy();
            charts.sections = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: Object.keys(secCounts).map(id => catData.find(c => c.id === id)?.name || id),
                    datasets: [{
                        label: 'Preguntas',
                        data: Object.values(secCounts),
                        backgroundColor: '#2a6aff',
                        borderRadius: 8
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Chart Likes
            const topLikes = [...faqData].sort((a,b) => (b.likes||0) - (a.likes||0)).slice(0, 5);
            const ctx2 = document.getElementById('chart-likes').getContext('2d');
            if (charts.likes) charts.likes.destroy();
            charts.likes = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: topLikes.map(f => f.question.substring(0, 15) + '...'),
                    datasets: [{
                        label: 'Votos √∫tiles',
                        data: topLikes.map(f => f.likes || 0),
                        backgroundColor: '#ff8500',
                        borderRadius: 8
                    }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false }
            });
        };

        // TABS & FORMS
        window.switchAdminMainTab = (tab) => {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.querySelectorAll('.admin-view').forEach(v => v.classList.add('hidden'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            if (tab === 'stats') setTimeout(updateStatsCharts, 100);
            closeAdminForm();
        };

        window.openFaqForm = () => {
            document.getElementById('view-faqs').classList.add('hidden');
            document.getElementById('admin-form-container').classList.remove('hidden');
            document.getElementById('faq-form-block').classList.remove('hidden');
            document.getElementById('cat-form-block').classList.add('hidden');
            document.getElementById('faq-form').reset();
            document.getElementById('form-faq-id').value = '';
        };

        window.openCatForm = () => {
            document.getElementById('view-categories').classList.add('hidden');
            document.getElementById('admin-form-container').classList.remove('hidden');
            document.getElementById('cat-form-block').classList.remove('hidden');
            document.getElementById('faq-form-block').classList.add('hidden');
            document.getElementById('cat-form').reset();
            document.getElementById('form-cat-id').value = '';
        };

        window.closeAdminForm = () => {
            document.getElementById('admin-form-container').classList.add('hidden');
            document.getElementById('view-faqs').classList.add('hidden');
            document.getElementById('view-categories').classList.add('hidden');
            document.getElementById('view-stats').classList.add('hidden');
            document.getElementById('view-data').classList.add('hidden');
            
            const activeTab = document.querySelector('.admin-tab.active').id.replace('tab-', '');
            document.getElementById(`view-${activeTab}`).classList.remove('hidden');
        };

        // CRUD
        document.getElementById('faq-form').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('form-faq-id').value;
            const data = {
                question: document.getElementById('form-faq-question').value,
                answer: document.getElementById('form-faq-answer').value,
                category: document.getElementById('form-faq-category').value,
                likes: id ? faqData.find(f => f.id === id).likes || 0 : 0
            };
            if (id) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'faqs', id), data);
            else await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'faqs'), data);
            closeAdminForm();
        };

        document.getElementById('cat-form').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('form-cat-id').value;
            const name = document.getElementById('form-cat-name').value;
            const cid = id || name.toLowerCase().replace(/\s/g, '-');
            const data = {
                id: cid,
                name: name,
                iconClass: document.getElementById('form-cat-icon').value,
                colorClass: document.getElementById('form-cat-color').value
            };
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', cid), data);
            closeAdminForm();
        };

        window.editFaq = (id) => {
            const f = faqData.find(f => f.id === id);
            openFaqForm();
            document.getElementById('form-faq-id').value = f.id;
            document.getElementById('form-faq-question').value = f.question;
            document.getElementById('form-faq-answer').value = f.answer;
            document.getElementById('form-faq-category').value = f.category;
            document.getElementById('faq-title-label').innerText = "Editar Pregunta";
        };

        window.editCat = (id) => {
            const c = catData.find(c => c.id === id);
            openCatForm();
            document.getElementById('form-cat-id').value = c.id;
            document.getElementById('form-cat-name').value = c.name;
            document.getElementById('form-cat-icon').value = c.iconClass;
            document.getElementById('form-cat-color').value = c.colorClass;
        };

        window.deleteFaq = async (id) => { if(confirm("¬øEliminar?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'faqs', id)); };
        window.deleteCat = async (id) => { if(confirm("¬øEliminar secci√≥n?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', id)); };

        const updateFormSelectors = () => {
            const sel = document.getElementById('form-faq-category');
            sel.innerHTML = catData.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        };

        window.handleLike = async (id, e) => {
            e.stopPropagation();
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'faqs', id), { likes: increment(1) });
        };

        document.getElementById('admin-lock-btn').onclick = () => {
            if (prompt("Clave:") === "cnci2026") document.getElementById('admin-modal').classList.remove('hidden');
        };
        document.getElementById('close-admin-btn').onclick = () => document.getElementById('admin-modal').classList.add('hidden');

        init();
    </script>
</body>
</html>
