<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Ayuda CNCI</title>
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <!-- 1. Importación de Librerías -->
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    
    <!-- FontAwesome 6.4.0 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Animate.css 4.1.1 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. Configuración de Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cnciBlue: '#2563eb',
                        cnciDark: '#1e40af',
                        cnciNavy: '#004aad',
                        accent: '#ff8500',
                        universityGold: '#facc15'
                    },
                    borderRadius: {
                        '3xl': '1.5rem'
                    },
                    boxShadow: {
                        premium: '0 20px 50px -12px rgba(0,74,173,0.12)'
                    },
                    fontFamily: {
                        poppins: ['Poppins', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <!-- 3. Estilos Base CSS -->
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
        }
        
        .hidden-view {
            display: none !important;
        }

        /* Ocultar scrollbar para el contenedor de categorías */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Estilos base para el output del Editor de Texto Enriquecido (RTE) */
        .rte-output h1 { font-size: 1.75rem; font-weight: 800; color: #1e293b; margin-top: 1rem; margin-bottom: 0.5rem; }
        .rte-output h2 { font-size: 1.5rem; font-weight: 700; color: #1e293b; margin-top: 1rem; margin-bottom: 0.5rem; }
        .rte-output h3 { font-size: 1.25rem; font-weight: 600; color: #1e293b; margin-top: 1rem; margin-bottom: 0.5rem; }
        .rte-output p { margin-bottom: 0.75rem; }
        .rte-output ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; }
        .rte-output ol { list-style-type: decimal; padding-left: 1.5rem; margin-bottom: 1rem; }
        .rte-output li { margin-bottom: 0.25rem; }
        .rte-output a { color: #2563eb; text-decoration: underline; }
        .rte-output b, .rte-output strong { font-weight: 700; }
        .rte-output i, .rte-output em { font-style: italic; }
        .rte-output u { text-decoration: underline; }
        .rte-output strike, .rte-output s { text-decoration: line-through; }
    </style>
</head>

<!-- 4. Estructura del Layout -->
<body class="min-h-screen flex flex-col">
    
    <!-- Contenedor de Alertas -->
    <div id="toast-container" class="fixed top-4 right-4 z-[100] flex flex-col gap-2"></div>

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 bg-white border-b border-gray-200/60 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-20 items-center">
                
                <!-- Navbar Izquierda -->
                <div class="flex items-center gap-3">
                    <img src="https://i.ibb.co/m5QcyKWg/Logo-CNCI.png" alt="Logo Universidad Virtual CNCI" class="h-12 w-auto object-contain">
                    <h1 class="font-semibold text-lg sm:text-xl tracking-tight text-gray-800">
                        Centro de Ayuda <span class="text-cnciBlue">CNCI</span>
                    </h1>
                </div>

                <!-- Navbar Derecha -->
                <div class="flex items-center gap-5">
                    <a href="https://www.office.com/" target="_blank" class="hidden md:block text-sm font-medium text-gray-600 hover:text-cnciBlue transition-colors duration-200">Office 365</a>
                    <a href="https://cnci.unlimitedlearning.io/" target="_blank" class="hidden md:block text-sm font-medium text-gray-600 hover:text-cnciBlue transition-colors duration-200">Biblioteca Virtual</a>
                    <a href="https://cnci.blackboard.com/ultra/" target="_blank" class="hidden md:block text-sm font-medium text-gray-600 hover:text-cnciBlue transition-colors duration-200">Blackboard</a>
                    <a href="#" class="block md:hidden text-gray-600 hover:text-cnciBlue transition-colors duration-200"><i class="fa-solid fa-bars text-xl"></i></a>
                    
                    <!-- Admin Logged Info (Oculto por defecto) -->
                    <div id="admin-logged-info" class="hidden-view items-center gap-4 ml-2 pl-4 border-l border-gray-200">
                        <span class="bg-cnciNavy text-white text-[10px] sm:text-xs px-2.5 py-1 rounded-md font-bold tracking-wider shadow-sm">STAFF</span>
                        <button onclick="window.logoutAdmin()" class="text-sm text-red-500 hover:text-red-700 font-medium transition-colors duration-200 flex items-center gap-1.5">
                            <i class="fa-solid fa-arrow-right-from-bracket"></i>
                            <span class="hidden sm:inline">Salir</span>
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </nav>

    <!-- Vista Cliente -->
    <main id="view-client" class="flex-grow w-full flex flex-col">
        
        <!-- Sección Hero (Buscador) -->
        <section class="w-full bg-gradient-to-br from-[#004aad] to-[#002d69] pt-20 pb-32 px-6 text-center">
            <div class="max-w-4xl mx-auto">
                <h2 class="font-black text-4xl md:text-6xl text-white mb-10 tracking-tight leading-tight">¿En qué podemos orientarte hoy?</h2>
                
                <div class="relative max-w-2xl mx-auto">
                    <i class="fa-solid fa-magnifying-glass absolute left-6 top-1/2 transform -translate-y-1/2 text-slate-400 text-xl z-10"></i>
                    <input type="text" oninput="window.handleSearch(event)" placeholder="Buscar Blackboard, titulación, constancias..." class="w-full pl-16 pr-6 py-5 rounded-2xl shadow-2xl text-slate-800 text-lg md:text-xl focus:outline-none focus:ring-4 focus:ring-accent/40 transition-all border-none placeholder-slate-400">
                </div>
            </div>
        </section>

        <!-- Contenedor Principal y Categorías -->
        <div class="max-w-6xl mx-auto w-full px-4 -mt-16 relative z-10 pb-20">
            
            <!-- Categorías Dinámicas (Tarjetas con scroll horizontal) -->
            <div id="categories-container" class="flex overflow-x-auto gap-4 mb-12 pb-6 no-scrollbar snap-x snap-mandatory justify-start lg:justify-center items-center px-2">
                <!-- Se llenará mediante JS -->
            </div>

            <!-- Tarjetas FAQ Dinámicas -->
            <div id="faqs-container" class="space-y-6 max-w-5xl mx-auto">
                <!-- Se llenará mediante JS -->
            </div>

            <!-- Controles de Paginación (Estáticos por ahora) -->
            <div id="pagination-controls" class="mt-16 flex justify-center gap-3">
                <button class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm bg-cnciBlue text-white shadow-md hover:bg-blue-700 transition-colors">1</button>
                <button class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm bg-white text-slate-500 border border-slate-200 hover:border-cnciBlue hover:text-cnciBlue transition-all shadow-sm">2</button>
                <button class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm bg-white text-slate-500 border border-slate-200 hover:border-cnciBlue hover:text-cnciBlue transition-all shadow-sm">3</button>
            </div>
            <!-- NUEVA SECCIÓN: Directorio CNCI -->
            <section class="mt-24 mb-10 w-full max-w-5xl mx-auto animate__animated animate__fadeIn">
                <div class="bg-white rounded-[2rem] shadow-premium border border-slate-100 p-8 md:p-12 text-center overflow-hidden relative">
                    <!-- Decoración de fondo suave -->
                    <div class="absolute top-0 right-0 w-40 h-40 bg-blue-50/50 rounded-bl-full -z-0"></div>
                    <div class="absolute bottom-0 left-0 w-32 h-32 bg-slate-50 rounded-tr-full -z-0"></div>
                    
                    <div class="relative z-10">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-blue-50 text-cnciBlue mb-6 shadow-sm border border-blue-100">
                            <i class="fa-solid fa-address-book text-3xl"></i>
                        </div>
                        <h2 class="text-3xl md:text-4xl font-black text-slate-800 mb-4 tracking-tight">Directorio CNCI</h2>
                        <p class="text-slate-500 mb-10 max-w-2xl mx-auto font-medium text-lg">Encuentra rápidamente la información de contacto de nuestros diferentes departamentos para recibir la asistencia que necesitas.</p>
                        
                        <div class="rounded-2xl overflow-hidden border border-slate-200 shadow-lg bg-white transition-transform duration-300 hover:shadow-xl group">
                            <img src="https://i.ibb.co/RF36Vz7/Directorios-Departamentos-1.png" alt="Directorio de Departamentos" class="w-full h-auto object-cover">
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Vista Admin -->
    <main id="view-admin" class="flex-grow hidden-view w-full pb-24">
        <div class="max-w-7xl mx-auto px-4 py-10">
            <!-- Cabecera del Panel y Menú de Pestañas -->
            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-10 gap-6">
                <div>
                    <h2 class="text-3xl font-black text-slate-800">Panel Universitario</h2>
                    <p class="text-slate-500 font-medium mt-1">Gestión de base de conocimientos CNCI</p>
                </div>
                
                <div class="flex bg-white p-1 rounded-2xl shadow-sm border w-full lg:w-auto overflow-x-auto no-scrollbar">
                    <button id="tab-btn-dashboard" onclick="window.switchAdminTab('dashboard')" class="flex-1 lg:flex-none px-4 lg:px-8 py-3 rounded-xl text-xs font-black transition-all bg-blue-600 text-white shadow-md whitespace-nowrap">Dashboard</button>
                    <button id="tab-btn-metrics" onclick="window.switchAdminTab('metrics')" class="flex-1 lg:flex-none px-4 lg:px-8 py-3 rounded-xl text-xs font-black transition-all text-slate-500 hover:bg-slate-100 whitespace-nowrap">Sesiones</button>
                    <button id="tab-btn-faqs" onclick="window.switchAdminTab('faqs')" class="flex-1 lg:flex-none px-4 lg:px-8 py-3 rounded-xl text-xs font-black transition-all text-slate-500 hover:bg-slate-100 whitespace-nowrap">Preguntas</button>
                    <button id="tab-btn-categories" onclick="window.switchAdminTab('categories')" class="flex-1 lg:flex-none px-4 lg:px-8 py-3 rounded-xl text-xs font-black transition-all text-slate-500 hover:bg-slate-100 whitespace-nowrap">Estructura</button>
                    <button id="tab-btn-tools" onclick="window.switchAdminTab('tools')" class="flex-1 lg:flex-none px-4 lg:px-8 py-3 rounded-xl text-xs font-black transition-all text-slate-500 hover:bg-slate-100 whitespace-nowrap">Datos</button>
                </div>
            </div>

            <!-- Pestaña Dashboard (Analítica On-Demand) -->
            <div id="admin-tab-dashboard" class="animate__animated animate__fadeIn">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    
                    <!-- 1. Tendencia de Tráfico Histórico -->
                    <div class="bg-white p-6 md:p-8 rounded-[2rem] shadow-premium flex flex-col border border-slate-100 h-full">
                        <div class="mb-5">
                            <h3 class="font-black text-slate-800 text-lg leading-tight">Tendencia de Tráfico Histórico</h3>
                            <p class="text-xs text-slate-500 font-medium mt-1">Total de accesos por día en un periodo.</p>
                        </div>
                        <div class="flex flex-wrap gap-2 mb-6 bg-slate-50 p-3 md:p-4 rounded-2xl border border-slate-200">
                            <div class="flex-1 min-w-[110px]">
                                <label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase tracking-wider">Inicio</label>
                                <input type="date" id="chart1-start" class="w-full px-3 py-2 rounded-xl border border-slate-200 focus:ring-2 focus:ring-cnciBlue/50 text-xs md:text-sm font-medium">
                            </div>
                            <div class="flex-1 min-w-[110px]">
                                <label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase tracking-wider">Fin</label>
                                <input type="date" id="chart1-end" class="w-full px-3 py-2 rounded-xl border border-slate-200 focus:ring-2 focus:ring-cnciBlue/50 text-xs md:text-sm font-medium">
                            </div>
                            <div class="flex items-end gap-2 w-full sm:w-auto mt-1 sm:mt-0">
                                <button onclick="window.genChart1()" class="flex-1 sm:flex-none bg-cnciBlue text-white text-xs font-bold px-4 py-2.5 rounded-xl hover:bg-blue-700 transition-colors shadow-md flex justify-center items-center"><i class="fa-solid fa-play mr-1.5"></i> Generar</button>
                                <button onclick="window.csvChart1()" class="flex-none bg-white border border-slate-200 text-slate-600 text-xs font-bold px-3 py-2.5 rounded-xl hover:text-cnciBlue hover:border-cnciBlue transition-colors shadow-sm flex justify-center items-center" title="Exportar CSV"><i class="fa-solid fa-file-csv text-base"></i></button>
                            </div>
                        </div>
                        <div class="relative h-[250px] md:h-[300px] w-full flex-grow flex flex-col justify-end">
                            <div id="empty-chart1" class="absolute inset-0 flex flex-col items-center justify-center text-center bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200 z-10 transition-opacity">
                                <div class="w-12 h-12 bg-white rounded-full shadow-sm flex items-center justify-center text-slate-300 mb-3 text-xl"><i class="fa-solid fa-chart-line"></i></div>
                                <p class="text-xs font-medium text-slate-500 max-w-[200px]">Selecciona las fechas y haz clic en Generar.</p>
                            </div>
                            <canvas id="canvasChart1" class="hidden-view"></canvas>
                        </div>
                    </div>

                    <!-- 2. Horarios de Mayor Demanda -->
                    <div class="bg-white p-6 md:p-8 rounded-[2rem] shadow-premium flex flex-col border border-slate-100 h-full">
                        <div class="mb-5">
                            <h3 class="font-black text-slate-800 text-lg leading-tight">Horarios de Mayor Demanda</h3>
                            <p class="text-xs text-slate-500 font-medium mt-1">Frecuencia de accesos por hora del día.</p>
                        </div>
                        <div class="flex flex-wrap gap-2 mb-6 bg-slate-50 p-3 md:p-4 rounded-2xl border border-slate-200">
                            <div class="flex-1 min-w-[110px]">
                                <label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase tracking-wider">Inicio</label>
                                <input type="date" id="chart2-start" class="w-full px-3 py-2 rounded-xl border border-slate-200 focus:ring-2 focus:ring-cnciBlue/50 text-xs md:text-sm font-medium">
                            </div>
                            <div class="flex-1 min-w-[110px]">
                                <label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase tracking-wider">Fin</label>
                                <input type="date" id="chart2-end" class="w-full px-3 py-2 rounded-xl border border-slate-200 focus:ring-2 focus:ring-cnciBlue/50 text-xs md:text-sm font-medium">
                            </div>
                            <div class="flex items-end gap-2 w-full sm:w-auto mt-1 sm:mt-0">
                                <button onclick="window.genChart2()" class="flex-1 sm:flex-none bg-cnciBlue text-white text-xs font-bold px-4 py-2.5 rounded-xl hover:bg-blue-700 transition-colors shadow-md flex justify-center items-center"><i class="fa-solid fa-play mr-1.5"></i> Generar</button>
                                <button onclick="window.csvChart2()" class="flex-none bg-white border border-slate-200 text-slate-600 text-xs font-bold px-3 py-2.5 rounded-xl hover:text-cnciBlue hover:border-cnciBlue transition-colors shadow-sm flex justify-center items-center" title="Exportar CSV"><i class="fa-solid fa-file-csv text-base"></i></button>
                            </div>
                        </div>
                        <div class="relative h-[250px] md:h-[300px] w-full flex-grow flex flex-col justify-end">
                            <div id="empty-chart2" class="absolute inset-0 flex flex-col items-center justify-center text-center bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200 z-10 transition-opacity">
                                <div class="w-12 h-12 bg-white rounded-full shadow-sm flex items-center justify-center text-slate-300 mb-3 text-xl"><i class="fa-solid fa-clock"></i></div>
                                <p class="text-xs font-medium text-slate-500 max-w-[200px]">Selecciona las fechas y haz clic en Generar.</p>
                            </div>
                            <canvas id="canvasChart2" class="hidden-view"></canvas>
                        </div>
                    </div>

                    <!-- 3. Mapa Demográfico -->
                    <div class="bg-white p-6 md:p-8 rounded-[2rem] shadow-premium flex flex-col border border-slate-100 h-full">
                        <div class="mb-5">
                            <h3 class="font-black text-slate-800 text-lg leading-tight">Mapa Demográfico (Top 10)</h3>
                            <p class="text-xs text-slate-500 font-medium mt-1">Distribución de ciudades con más accesos.</p>
                        </div>
                        <div class="flex flex-wrap gap-2 mb-6 bg-slate-50 p-3 md:p-4 rounded-2xl border border-slate-200">
                            <div class="flex-1 min-w-[110px]">
                                <label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase tracking-wider">Inicio</label>
                                <input type="date" id="chart3-start" class="w-full px-3 py-2 rounded-xl border border-slate-200 focus:ring-2 focus:ring-cnciBlue/50 text-xs md:text-sm font-medium">
                            </div>
                            <div class="flex-1 min-w-[110px]">
                                <label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase tracking-wider">Fin</label>
                                <input type="date" id="chart3-end" class="w-full px-3 py-2 rounded-xl border border-slate-200 focus:ring-2 focus:ring-cnciBlue/50 text-xs md:text-sm font-medium">
                            </div>
                            <div class="flex items-end gap-2 w-full sm:w-auto mt-1 sm:mt-0">
                                <button onclick="window.genChart3()" class="flex-1 sm:flex-none bg-cnciBlue text-white text-xs font-bold px-4 py-2.5 rounded-xl hover:bg-blue-700 transition-colors shadow-md flex justify-center items-center"><i class="fa-solid fa-play mr-1.5"></i> Generar</button>
                                <button onclick="window.csvChart3()" class="flex-none bg-white border border-slate-200 text-slate-600 text-xs font-bold px-3 py-2.5 rounded-xl hover:text-cnciBlue hover:border-cnciBlue transition-colors shadow-sm flex justify-center items-center" title="Exportar CSV"><i class="fa-solid fa-file-csv text-base"></i></button>
                            </div>
                        </div>
                        <div class="relative h-[250px] md:h-[300px] w-full flex-grow flex flex-col justify-end">
                            <div id="empty-chart3" class="absolute inset-0 flex flex-col items-center justify-center text-center bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200 z-10 transition-opacity">
                                <div class="w-12 h-12 bg-white rounded-full shadow-sm flex items-center justify-center text-slate-300 mb-3 text-xl"><i class="fa-solid fa-earth-americas"></i></div>
                                <p class="text-xs font-medium text-slate-500 max-w-[200px]">Selecciona las fechas y haz clic en Generar.</p>
                            </div>
                            <canvas id="canvasChart3" class="hidden-view"></canvas>
                        </div>
                    </div>

                    <!-- 4. Matriz de Efectividad de FAQs -->
                    <div class="bg-white p-6 md:p-8 rounded-[2rem] shadow-premium flex flex-col border border-slate-100 h-full">
                        <div class="mb-5">
                            <h3 class="font-black text-slate-800 text-lg leading-tight">Matriz de Efectividad de FAQs</h3>
                            <p class="text-xs text-slate-500 font-medium mt-1">Relación entre Vistas (Eje X) y Likes (Eje Y).</p>
                        </div>
                        <div class="flex flex-wrap gap-2 mb-6 bg-slate-50 p-3 md:p-4 rounded-2xl border border-slate-200">
                            <div class="flex-1 w-full sm:min-w-[200px]">
                                <label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase tracking-wider">Categoría a analizar</label>
                                <select id="chart4-cat" class="w-full px-3 py-2 rounded-xl border border-slate-200 focus:ring-2 focus:ring-cnciBlue/50 text-xs md:text-sm font-medium">
                                    <option value="ALL">Todas las categorías</option>
                                    <!-- Se llenará vía JS -->
                                </select>
                            </div>
                            <div class="flex items-end gap-2 w-full sm:w-auto mt-1 sm:mt-0">
                                <button onclick="window.genChart4()" class="flex-1 sm:flex-none bg-cnciBlue text-white text-xs font-bold px-4 py-2.5 rounded-xl hover:bg-blue-700 transition-colors shadow-md flex justify-center items-center"><i class="fa-solid fa-play mr-1.5"></i> Analizar</button>
                                <button onclick="window.csvChart4()" class="flex-none bg-white border border-slate-200 text-slate-600 text-xs font-bold px-3 py-2.5 rounded-xl hover:text-cnciBlue hover:border-cnciBlue transition-colors shadow-sm flex justify-center items-center" title="Exportar CSV"><i class="fa-solid fa-file-csv text-base"></i></button>
                            </div>
                        </div>
                        <div class="relative h-[250px] md:h-[300px] w-full flex-grow flex flex-col justify-end">
                            <div id="empty-chart4" class="absolute inset-0 flex flex-col items-center justify-center text-center bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200 z-10 transition-opacity">
                                <div class="w-12 h-12 bg-white rounded-full shadow-sm flex items-center justify-center text-slate-300 mb-3 text-xl"><i class="fa-solid fa-microscope"></i></div>
                                <p class="text-xs font-medium text-slate-500 max-w-[200px]">Selecciona la categoría y haz clic en Analizar.</p>
                            </div>
                            <canvas id="canvasChart4" class="hidden-view"></canvas>
                        </div>
                    </div>
                    
                </div>
            </div>

            <!-- Pestaña: Sesiones -->
            <div id="admin-tab-metrics" class="animate__animated animate__fadeIn hidden-view">
                <div class="bg-white p-8 rounded-[2rem] shadow-premium border border-slate-100">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                        <div>
                            <h3 class="font-black text-slate-800 text-xl">Registro de Sesiones</h3>
                            <p class="text-xs text-slate-500 font-medium mt-1">Carga de datos bajo demanda (Optimizado)</p>
                        </div>
                        <button onclick="window.exportSessionsCSV()" class="bg-green-600 text-white text-sm font-bold px-5 py-2.5 rounded-xl hover:bg-green-700 transition-colors shadow-md flex items-center">
                            <i class="fa-solid fa-file-csv mr-2"></i> EXPORTAR CSV
                        </button>
                    </div>

                    <!-- Filtros para la consulta -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 bg-slate-50 p-5 rounded-2xl border border-slate-200">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1.5 ml-1">Fecha Inicio</label>
                            <input type="date" id="session-start" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-cnciBlue/50 text-sm text-slate-700 font-medium">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1.5 ml-1">Fecha Fin</label>
                            <input type="date" id="session-end" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-cnciBlue/50 text-sm text-slate-700 font-medium">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1.5 ml-1">Ciudad (Filtro local)</label>
                            <input type="text" id="session-city" placeholder="Ej. Monterrey" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-cnciBlue/50 text-sm text-slate-700 font-medium">
                        </div>
                        <div class="flex items-end">
                            <button onclick="window.loadAdminSessions()" class="w-full bg-cnciBlue text-white text-sm font-bold px-4 py-2.5 rounded-xl hover:bg-blue-700 transition-colors shadow-md flex justify-center items-center">
                                <i class="fa-solid fa-cloud-arrow-down mr-2"></i> CARGAR DATOS
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto rounded-xl border border-slate-100">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th onclick="window.sortMetrics('date')" class="p-4 text-slate-500 font-bold text-xs uppercase tracking-wider cursor-pointer hover:bg-slate-100 transition-colors">Fecha <i class="fa-solid fa-sort ml-1"></i></th>
                                    <th onclick="window.sortMetrics('time')" class="p-4 text-slate-500 font-bold text-xs uppercase tracking-wider cursor-pointer hover:bg-slate-100 transition-colors">Hora <i class="fa-solid fa-sort ml-1"></i></th>
                                    <th onclick="window.sortMetrics('location')" class="p-4 text-slate-500 font-bold text-xs uppercase tracking-wider cursor-pointer hover:bg-slate-100 transition-colors">Ubicación <i class="fa-solid fa-sort ml-1"></i></th>
                                </tr>
                            </thead>
                            <tbody id="admin-metrics-table-body" class="divide-y divide-slate-100">
                                <tr><td colspan="3" class="p-10 text-center text-slate-500 font-medium"><i class="fa-solid fa-filter mr-2"></i> Selecciona las fechas y haz clic en "Cargar Datos".</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Pestaña: Preguntas (CRUD FAQs) -->
            <div id="admin-tab-faqs" class="animate__animated animate__fadeIn hidden-view">
                <div class="bg-white p-8 rounded-[2rem] shadow-premium border border-slate-100">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
                        <h3 class="font-black text-slate-800 text-xl">Banco de Conocimiento</h3>
                        <button onclick="window.openFaqModal()" class="bg-cnciBlue text-white text-sm font-bold px-5 py-2.5 rounded-xl hover:bg-blue-700 transition-colors shadow-md flex items-center">
                            <i class="fa-solid fa-plus mr-2"></i> NUEVA FAQ
                        </button>
                    </div>

                    <div class="overflow-x-auto rounded-xl border border-slate-100">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="p-4 text-slate-500 font-bold text-xs tracking-wider w-[35%] align-top">
                                        <div class="uppercase mb-2">PREGUNTA</div>
                                        <input type="text" id="filter-col-q" oninput="window.filterAdminFaqs()" placeholder="Buscar en preguntas..." class="w-full px-3 py-1.5 rounded-lg border border-slate-200 text-sm font-normal focus:outline-none focus:ring-1 focus:ring-cnciBlue">
                                    </th>
                                    <th class="p-4 text-slate-500 font-bold text-xs tracking-wider align-top">
                                        <div class="uppercase mb-2">CATEGORÍA</div>
                                        <select id="filter-col-cat" onchange="window.filterAdminFaqs()" class="w-full px-3 py-1.5 rounded-lg border border-slate-200 text-sm font-normal focus:outline-none focus:ring-1 focus:ring-cnciBlue">
                                            <!-- Se inyectará desde JS -->
                                        </select>
                                    </th>
                                    <th class="p-4 text-slate-500 font-bold text-xs tracking-wider align-top">
                                        <div class="uppercase mb-2">ÁREA</div>
                                        <select id="filter-col-area" onchange="window.filterAdminFaqs()" class="w-full px-3 py-1.5 rounded-lg border border-slate-200 text-sm font-normal focus:outline-none focus:ring-1 focus:ring-cnciBlue">
                                            <!-- Se inyectará desde JS -->
                                        </select>
                                    </th>
                                    <!-- COLUMNAS DE FECHAS SEPARADAS -->
                                    <th class="p-4 text-slate-500 font-bold text-xs uppercase tracking-wider align-top pt-5">Fecha Carga</th>
                                    <th class="p-4 text-slate-500 font-bold text-xs uppercase tracking-wider align-top pt-5">Última Modif.</th>
                                    <th class="p-4 text-slate-500 font-bold text-xs uppercase tracking-wider align-top pt-5">Likes</th>
                                    <th class="p-4 text-slate-500 font-bold text-xs uppercase tracking-wider text-center align-top pt-5">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="admin-faqs-table-body" class="divide-y divide-slate-100">
                                <!-- Filas inyectadas por JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Pestaña: Estructura (Categorías y Áreas) -->
            <div id="admin-tab-categories" class="animate__animated animate__fadeIn hidden-view">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Columna Categorías -->
                    <div class="bg-white p-8 rounded-[2rem] shadow-premium border border-slate-100 flex flex-col h-full">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-black text-slate-800 text-lg">Categorías</h3>
                            <button onclick="window.openCategoryModal()" class="bg-cnciBlue text-white text-xs font-bold px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors shadow-md">
                                <i class="fa-solid fa-plus mr-1"></i> Añadir
                            </button>
                        </div>
                        <ul id="admin-categories-list" class="divide-y divide-slate-100 text-sm flex-grow">
                            <!-- JS inyectará <li> -->
                        </ul>
                    </div>

                    <!-- Columna Áreas -->
                    <div class="bg-white p-8 rounded-[2rem] shadow-premium border border-slate-100 flex flex-col h-full">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-black text-slate-800 text-lg">Áreas Operativas</h3>
                            <button onclick="window.openSimpleModal('areas')" class="bg-cnciBlue text-white text-xs font-bold px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors shadow-md">
                                <i class="fa-solid fa-plus mr-1"></i> Añadir
                            </button>
                        </div>
                        <ul id="admin-areas-list" class="divide-y divide-slate-100 text-sm flex-grow">
                            <!-- JS inyectará <li> -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Pestaña Datos (Importar/Exportar CSV) -->
            <div id="admin-tab-tools" class="animate__animated animate__fadeIn hidden-view">
                <div class="bg-white p-8 rounded-[2rem] shadow-premium border border-slate-100">
                    <h3 class="font-black text-slate-800 text-xl mb-4">Gestión de Datos (CSV)</h3>
                    <p class="text-slate-500 mb-8 font-medium">Exporta o importa el banco de conocimientos completo para migraciones masivas.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Contenedor Exportar -->
                        <div class="p-8 border-2 border-dashed border-slate-200 rounded-2xl flex flex-col items-center text-center">
                            <i class="fa-solid fa-file-export text-4xl text-cnciBlue mb-4"></i>
                            <h4 class="font-bold text-slate-800 mb-2">Exportar Banco de Conocimientos</h4>
                            <p class="text-sm text-slate-500 mb-6">Descarga todas las preguntas, respuestas y métricas actuales en formato CSV (UTF-8).</p>
                            <button onclick="window.exportToCSV()" class="bg-cnciBlue text-white font-bold px-6 py-2.5 rounded-xl hover:bg-blue-700 transition-colors shadow-md w-full max-w-[200px]">DESCARGAR .CSV</button>
                        </div>
                        <!-- Contenedor Importar -->
                        <div class="p-8 border-2 border-dashed border-slate-200 rounded-2xl flex flex-col items-center text-center relative">
                            <i class="fa-solid fa-file-import text-4xl text-accent mb-4"></i>
                            <h4 class="font-bold text-slate-800 mb-2">Importar Banco de Conocimientos</h4>
                            <p class="text-sm text-slate-500 mb-3">Sube un archivo CSV usando exclusivamente la plantilla oficial para añadir múltiples FAQs a la vez.</p>
                            
                            <button type="button" onclick="window.downloadTemplateCSV()" class="text-accent font-semibold text-sm hover:underline mb-6 flex items-center gap-1 transition-all">
                                <i class="fa-solid fa-download"></i> Descargar plantilla base
                            </button>

                            <label class="bg-accent text-white font-bold px-6 py-2.5 rounded-xl hover:bg-orange-600 transition-colors shadow-md cursor-pointer w-full max-w-[200px] inline-block text-center">
                                SUBIR .CSV
                                <input type="file" accept=".csv" class="hidden" onchange="window.importFromCSV(event)">
                            </label>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white mt-auto border-t border-gray-200/60 py-8 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.02)] relative z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col md:flex-row justify-between items-center gap-6">
            
            <!-- 1. Copyright & Secret Login -->
            <p class="text-sm text-gray-500 font-medium text-center md:text-left order-2 md:order-1 relative">
                © 2026 Universidad Virtual CNCI
                <!-- Este punto es el botón secreto de Login -->
                <button id="footer-login-btn" onclick="window.showLoginModal()" class="cursor-default focus:outline-none" title="Staff Area">.</button>
            </p>

            <!-- 2. Redes Sociales CNCI -->
            <div class="flex items-center gap-4 order-1 md:order-2">
                <a href="https://www.facebook.com/UniversidadVirtualCNCIoficial" target="_blank" class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 hover:bg-[#1877F2] hover:text-white transition-all duration-300 shadow-sm hover:shadow-md hover:-translate-y-1" title="Facebook">
                    <i class="fa-brands fa-facebook-f text-lg"></i>
                </a>
                
                <a href="https://www.instagram.com/UniversidadVirtualCNCIoficial" target="_blank" class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 hover:bg-[#E4405F] hover:text-white transition-all duration-300 shadow-sm hover:shadow-md hover:-translate-y-1" title="Instagram">
                    <i class="fa-brands fa-instagram text-lg"></i>
                </a>
                
                <a href="https://www.youtube.com/c/UniversidadVirtualCNCIOficial" target="_blank" class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 hover:bg-[#FF0000] hover:text-white transition-all duration-300 shadow-sm hover:shadow-md hover:-translate-y-1" title="YouTube">
                    <i class="fa-brands fa-youtube text-lg"></i>
                </a>
                
                <a href="https://www.linkedin.com/school/universidad-virtual-cnci/" target="_blank" class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 hover:bg-[#0A66C2] hover:text-white transition-all duration-300 shadow-sm hover:shadow-md hover:-translate-y-1" title="LinkedIn">
                    <i class="fa-brands fa-linkedin-in text-lg"></i>
                </a>
            </div>
        </div>
    </footer>

    <!-- Modal de Login -->
    <div id="modal-login" class="fixed inset-0 bg-slate-900/70 z-[100] flex justify-center items-center hidden-view backdrop-blur-sm">
        <div class="bg-white p-10 rounded-[2rem] max-w-sm w-full shadow-2xl relative animate__animated animate__fadeIn animate__faster">
            <button onclick="window.closeModal('modal-login')" class="absolute top-6 right-6 text-slate-400 hover:text-slate-700 transition-colors">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
            
            <div class="text-center mb-8">
                <div class="bg-blue-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-shield-halved text-2xl text-cnciBlue"></i>
                </div>
                <h3 class="text-2xl font-black text-slate-800">Acceso Staff</h3>
                <p class="text-sm text-slate-500 mt-2">Ingresa tus credenciales de administrador</p>
            </div>

            <form onsubmit="window.handleLogin(event)" class="space-y-5">
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-1.5 ml-1">Correo electrónico</label>
                    <div class="relative">
                        <i class="fa-regular fa-envelope absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                        <input id="login-email" type="email" required class="w-full pl-11 pr-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:outline-none focus:ring-2 focus:ring-cnciBlue/50 focus:border-cnciBlue transition-all text-slate-700">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-1.5 ml-1">Contraseña</label>
                    <div class="relative">
                        <i class="fa-solid fa-lock absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                        <input id="login-password" type="password" required class="w-full pl-11 pr-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:outline-none focus:ring-2 focus:ring-cnciBlue/50 focus:border-cnciBlue transition-all text-slate-700">
                    </div>
                </div>
                <button type="submit" class="w-full bg-cnciBlue text-white font-bold py-3.5 rounded-xl shadow-lg shadow-cnciBlue/30 hover:bg-blue-700 transition-colors mt-4">
                    Entrar al panel
                </button>
                <div class="text-center mt-4">
                    <button type="button" onclick="window.closeModal('modal-login')" class="text-sm text-slate-500 hover:text-slate-700 font-medium transition-colors">Volver al inicio</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal del Editor de FAQs -->
    <div id="modal-faq" class="fixed inset-0 bg-slate-900/80 z-[100] flex justify-center items-center hidden-view p-4 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-[2rem] max-w-5xl w-full max-h-[90vh] overflow-y-auto shadow-2xl relative animate__animated animate__fadeIn animate__faster">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-black text-slate-800">Editor de Artículo</h3>
                <button onclick="window.closeModal('modal-faq')" class="text-slate-400 hover:text-slate-700 transition-colors">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <form id="faq-form" onsubmit="window.saveFaq(event)" class="space-y-6">
                <input type="hidden" id="faq-id">
                
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Pregunta / Título <span class="text-red-500">*</span></label>
                    <input type="text" id="faq-question" required placeholder="Ej. ¿Cómo tramitar una constancia?" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:outline-none focus:ring-2 focus:ring-cnciBlue/50 focus:border-cnciBlue transition-all text-slate-800 font-medium">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Categoría <span class="text-red-500">*</span></label>
                        <select id="faq-category" required class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:outline-none focus:ring-2 focus:ring-cnciBlue/50 focus:border-cnciBlue transition-all text-slate-700">
                            <!-- Inyectado por JS -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Área Responsable <span class="text-red-500">*</span></label>
                        <select id="faq-area" required class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:outline-none focus:ring-2 focus:ring-cnciBlue/50 focus:border-cnciBlue transition-all text-slate-700">
                            <!-- Inyectado por JS -->
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Respuesta <span class="text-red-500">*</span></label>
                    
                    <!-- NUEVO RTE TOOLBAR AVANZADO -->
                    <div class="bg-slate-100 border border-slate-200 border-b-0 rounded-t-xl px-4 py-3 flex flex-wrap gap-2 items-center">
                        
                        <!-- Formato de texto -->
                        <div class="flex bg-white border border-slate-200 rounded overflow-hidden">
                            <button type="button" onclick="document.execCommand('bold', false, null)" class="w-8 h-8 flex items-center justify-center hover:bg-slate-100 text-slate-700 transition-colors" title="Negrita"><i class="fa-solid fa-bold"></i></button>
                            <button type="button" onclick="document.execCommand('italic', false, null)" class="w-8 h-8 flex items-center justify-center hover:bg-slate-100 text-slate-700 transition-colors border-l border-slate-200" title="Cursiva"><i class="fa-solid fa-italic"></i></button>
                            <button type="button" onclick="document.execCommand('underline', false, null)" class="w-8 h-8 flex items-center justify-center hover:bg-slate-100 text-slate-700 transition-colors border-l border-slate-200" title="Subrayado"><i class="fa-solid fa-underline"></i></button>
                            <button type="button" onclick="document.execCommand('strikeThrough', false, null)" class="w-8 h-8 flex items-center justify-center hover:bg-slate-100 text-slate-700 transition-colors border-l border-slate-200" title="Tachado"><i class="fa-solid fa-strikethrough"></i></button>
                        </div>
                        
                        <!-- Alineación -->
                        <div class="flex bg-white border border-slate-200 rounded overflow-hidden">
                            <button type="button" onclick="document.execCommand('justifyLeft', false, null)" class="w-8 h-8 flex items-center justify-center hover:bg-slate-100 text-slate-700 transition-colors" title="Izquierda"><i class="fa-solid fa-align-left"></i></button>
                            <button type="button" onclick="document.execCommand('justifyCenter', false, null)" class="w-8 h-8 flex items-center justify-center hover:bg-slate-100 text-slate-700 transition-colors border-l border-slate-200" title="Centrado"><i class="fa-solid fa-align-center"></i></button>
                            <button type="button" onclick="document.execCommand('justifyRight', false, null)" class="w-8 h-8 flex items-center justify-center hover:bg-slate-100 text-slate-700 transition-colors border-l border-slate-200" title="Derecha"><i class="fa-solid fa-align-right"></i></button>
                            <button type="button" onclick="document.execCommand('justifyFull', false, null)" class="w-8 h-8 flex items-center justify-center hover:bg-slate-100 text-slate-700 transition-colors border-l border-slate-200" title="Justificado"><i class="fa-solid fa-align-justify"></i></button>
                        </div>

                        <!-- Listas -->
                        <div class="flex bg-white border border-slate-200 rounded overflow-hidden">
                            <button type="button" onclick="document.execCommand('insertUnorderedList', false, null)" class="w-8 h-8 flex items-center justify-center hover:bg-slate-100 text-slate-700 transition-colors" title="Lista con viñetas"><i class="fa-solid fa-list-ul"></i></button>
                            <button type="button" onclick="document.execCommand('insertOrderedList', false, null)" class="w-8 h-8 flex items-center justify-center hover:bg-slate-100 text-slate-700 transition-colors border-l border-slate-200" title="Lista numerada"><i class="fa-solid fa-list-ol"></i></button>
                        </div>

                        <!-- Estilos y Encabezados -->
                        <select onchange="document.execCommand('formatBlock', false, this.value); this.selectedIndex=0;" class="h-8 px-2 bg-white border border-slate-200 rounded text-sm text-slate-700 focus:outline-none cursor-pointer">
                            <option value="" disabled selected>Formato</option>
                            <option value="H1">Encabezado 1</option>
                            <option value="H2">Encabezado 2</option>
                            <option value="H3">Encabezado 3</option>
                            <option value="P">Párrafo Normal</option>
                        </select>

                        <select onchange="document.execCommand('fontName', false, this.value); this.selectedIndex=0;" class="h-8 px-2 bg-white border border-slate-200 rounded text-sm text-slate-700 focus:outline-none cursor-pointer">
                            <option value="" disabled selected>Fuente</option>
                            <option value="Arial">Arial</option>
                            <option value="Courier New">Courier New</option>
                            <option value="Georgia">Georgia</option>
                            <option value="Times New Roman">Times New Roman</option>
                            <option value="Verdana">Verdana</option>
                            <option value="Poppins">Poppins</option>
                        </select>

                        <select onchange="document.execCommand('fontSize', false, this.value); this.selectedIndex=0;" class="h-8 px-2 bg-white border border-slate-200 rounded text-sm text-slate-700 focus:outline-none cursor-pointer">
                            <option value="" disabled selected>Tamaño</option>
                            <option value="1">Muy pequeño</option>
                            <option value="2">Pequeño</option>
                            <option value="3">Normal</option>
                            <option value="4">Medio</option>
                            <option value="5">Grande</option>
                            <option value="6">Muy grande</option>
                        </select>

                        <!-- Color de Texto -->
                        <div class="flex items-center bg-white border border-slate-200 rounded px-1 h-8 cursor-pointer" title="Color de texto">
                            <input type="color" oninput="document.execCommand('foreColor', false, this.value);" class="w-6 h-6 border-0 p-0 bg-transparent cursor-pointer">
                        </div>

                        <!-- Selector Emojis -->
                        <select onchange="document.execCommand('insertText', false, this.value); this.selectedIndex=0;" class="h-8 px-2 bg-white border border-slate-200 rounded text-sm text-slate-700 focus:outline-none w-16 text-center cursor-pointer">
                            <option value="" disabled selected>😊</option>
                            <option value="😀">😀</option>
                            <option value="😂">😂</option>
                            <option value="🥰">🥰</option>
                            <option value="😎">😎</option>
                            <option value="🤔">🤔</option>
                            <option value="🙌">🙌</option>
                            <option value="👍">👍</option>
                            <option value="💡">💡</option>
                            <option value="🔥">🔥</option>
                            <option value="✅">✅</option>
                            <option value="❌">❌</option>
                            <option value="📌">📌</option>
                            <option value="🎓">🎓</option>
                            <option value="📚">📚</option>
                            <option value="💻">💻</option>
                            <option value="🚀">🚀</option>
                        </select>

                        <button type="button" onclick="document.execCommand('removeFormat', false, null)" class="w-8 h-8 flex items-center justify-center bg-white border border-slate-200 rounded hover:bg-slate-100 text-slate-700 transition-colors ml-auto" title="Quitar formato"><i class="fa-solid fa-eraser"></i></button>
                    </div>
                    
                    <div id="faq-answer-rte" contenteditable="true" class="w-full p-6 bg-slate-50 border border-slate-200 rounded-b-xl min-h-[200px] focus:outline-none focus:ring-2 focus:ring-cnciBlue/50 text-slate-700 leading-relaxed rte-output"></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">URL de Imagen (Opcional)</label>
                        <input type="url" id="faq-image" placeholder="https://..." class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:outline-none focus:ring-2 focus:ring-cnciBlue/50 focus:border-cnciBlue transition-all text-slate-700">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Enlace del Video de YouTube (Opcional)</label>
                        <input type="text" id="faq-video-embed" placeholder="Ej. https://youtu.be/5WBw1Mbg6rI" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:outline-none focus:ring-2 focus:ring-cnciBlue/50 focus:border-cnciBlue transition-all text-slate-700">
                    </div>
                </div>

                <div class="flex justify-end gap-3 pt-4 border-t border-slate-100 mt-6">
                    <button type="button" onclick="window.closeModal('modal-faq')" class="px-6 py-2.5 rounded-xl text-slate-600 font-semibold hover:bg-slate-100 transition-colors">Cancelar</button>
                    <button type="submit" class="px-8 py-2.5 rounded-xl bg-cnciBlue text-white font-bold shadow-lg shadow-cnciBlue/30 hover:bg-blue-700 transition-colors">Guardar FAQ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal del Editor de Categorías -->
    <div id="modal-category" class="fixed inset-0 bg-slate-900/80 z-[100] flex justify-center items-center hidden-view p-4 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-[2rem] max-w-md w-full shadow-2xl relative animate__animated animate__fadeIn animate__faster">
            <button onclick="window.closeModal('modal-category')" class="absolute top-6 right-6 text-slate-400 hover:text-slate-700 transition-colors">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
            <h3 class="text-2xl font-black text-slate-800 mb-6">Editor de Categoría</h3>
            
            <form id="category-form" onsubmit="window.saveCategory(event)" class="space-y-5">
                <input type="hidden" id="cat-id">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Nombre <span class="text-red-500">*</span></label>
                    <input type="text" id="cat-name" required placeholder="Ej. Pagos y Becas" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:outline-none focus:ring-2 focus:ring-cnciBlue/50 focus:border-cnciBlue transition-all text-slate-800 font-medium">
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">URL de Imagen Miniatura (Opcional)</label>
                    <input type="url" id="cat-image" placeholder="https://..." class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:outline-none focus:ring-2 focus:ring-cnciBlue/50 focus:border-cnciBlue transition-all text-slate-700">
                    <p class="text-xs text-slate-500 mt-2">Recomendado: Imagen cuadrada con fondo transparente (PNG).</p>
                </div>
                <div class="flex justify-end gap-3 pt-4 border-t border-slate-100 mt-6">
                    <button type="button" onclick="window.closeModal('modal-category')" class="px-5 py-2.5 rounded-xl text-slate-600 font-semibold hover:bg-slate-100 transition-colors">Cancelar</button>
                    <button type="submit" class="px-6 py-2.5 rounded-xl bg-cnciBlue text-white font-bold shadow-lg shadow-cnciBlue/30 hover:bg-blue-700 transition-colors">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts Modulares (Firebase y Lógica) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, getDocs, doc, updateDoc, increment, addDoc, deleteDoc, serverTimestamp, writeBatch, query, orderBy, limit, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables de Estado Globales
        let faqsData = [];
        let categoriesData = [];
        let areasData = [];
        let currentCategory = 'all';
        let searchQuery = '';
        const customAppId = "cnci-faq-hub-v2";
        
        let metricsData = [];
        let filteredMetrics = [];
        let metricSort = { col: 'rawTimestamp', order: 'desc' };
        
        window.openedFaqId = null;
        window.listenersActive = false;

        // Instancias del Dashboard Analítico
        let chart1Inst = null;
        let chart2Inst = null;
        let chart3Inst = null;
        let chart4Inst = null;

        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC8jIUPHKmcKy7eO1aq6eS4ZJ6kfq4zrBo",
            authDomain: "apppaneldesupcallcenter.firebaseapp.com",
            projectId: "apppaneldesupcallcenter",
            storageBucket: "apppaneldesupcallcenter.firebasestorage.app",
            messagingSenderId: "1091325080953",
            appId: "1:1091325080953:web:14fd225a15f532f92feba8",
            measurementId: "G-MGBBK91GZR"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app); 

        // UTILITARIO: Extraer y limpiar URL de YouTube
        window.formatYouTubeUrl = (url) => {
            if (!url) return '';
            if (url.includes('<iframe')) {
                const matchSrc = url.match(/src="([^"]+)"/);
                if (matchSrc) url = matchSrc[1];
            }
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            if (match && match[2].length === 11) {
                return `https://www.youtube.com/embed/${match[2]}`;
            }
            return url;
        };

        // Sistema de Alertas (Toast)
        window.showToast = (msg, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const isSuccess = type === 'success';
            const bgColor = isSuccess ? 'bg-green-600' : 'bg-red-500';
            const icon = isSuccess ? 'fa-check-circle' : 'fa-circle-exclamation';

            toast.className = `flex items-center gap-3 ${bgColor} text-white px-6 py-3.5 rounded-xl shadow-xl transform transition-all duration-300 animate__animated animate__fadeInRight z-[110]`;
            toast.innerHTML = `
                <i class="fa-solid ${icon} text-xl"></i> 
                <span class="font-semibold text-sm tracking-wide">${msg}</span>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.replace('animate__fadeInRight', 'animate__fadeOutRight');
                setTimeout(() => toast.remove(), 500); 
            }, 3000);
        };

        // Lógica Funcional del Modal Auth
        window.showLoginModal = () => {
            const modal = document.getElementById('modal-login');
            modal.classList.remove('hidden-view');
        };

        window.closeModal = (id) => {
            const modal = document.getElementById(id);
            modal.classList.add('hidden-view');
        };

        window.handleLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                window.closeModal('modal-login');
                window.showToast('Bienvenido, acceso autorizado.', 'success');
                e.target.reset();
            } catch (error) {
                console.error("Error de login:", error.code);
                let errorMsg = 'Credenciales incorrectas.';
                if (error.code === 'auth/invalid-email') errorMsg = 'El correo electrónico no es válido.';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') errorMsg = 'Correo o contraseña incorrectos.';
                
                window.showToast(errorMsg, 'error');
            }
        };

        window.logoutAdmin = async () => {
            try {
                await signOut(auth);
                window.showToast('Sesión cerrada correctamente.', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 800);
            } catch (error) {
                window.showToast('Error al cerrar sesión.', 'error');
            }
        };

        window.switchAdminTab = (tabId) => {
            const tabs = ['dashboard', 'metrics', 'faqs', 'categories', 'tools'];
            tabs.forEach(id => {
                const view = document.getElementById(`admin-tab-${id}`);
                if (view) view.classList.toggle('hidden-view', id !== tabId);
                
                const btn = document.getElementById(`tab-btn-${id}`);
                if (btn) {
                    btn.className = `flex-1 lg:flex-none px-4 lg:px-8 py-3 rounded-xl text-xs font-black transition-all whitespace-nowrap ${id === tabId ? 'bg-blue-600 text-white shadow-md' : 'text-slate-500 hover:bg-slate-100'}`;
                }
            });

            if (tabId === 'dashboard') {
                window.updateCharts();
            }
            // ¡Ya no cargamos sesiones automáticamente aquí! Ahorramos lecturas.
        };

        window.loadAdminSessions = async () => {
            const tbody = document.getElementById('admin-metrics-table-body');
            const startDateStr = document.getElementById('session-start').value;
            const endDateStr = document.getElementById('session-end').value;
            const cityFilter = document.getElementById('session-city').value.toLowerCase().trim();

            tbody.innerHTML = `<tr><td colspan="3" class="p-10 text-center text-slate-500"><i class="fa-solid fa-spinner fa-spin mr-2"></i> Consultando base de datos...</td></tr>`;
            
            try {
                let qConstraints = [];
                
                // Filtramos por fecha directamente en Firebase (ahorra descargas y cobros)
                if (startDateStr) {
                    const startD = new Date(startDateStr + 'T00:00:00');
                    qConstraints.push(where('timestamp', '>=', startD));
                }
                if (endDateStr) {
                    const endD = new Date(endDateStr + 'T23:59:59');
                    qConstraints.push(where('timestamp', '<=', endD));
                }
                
                qConstraints.push(orderBy('timestamp', 'desc'));
                qConstraints.push(limit(1000)); // Límite máximo de seguridad por consulta

                const q = query(collection(db, 'artifacts', customAppId, 'public', 'data', 'sessions'), ...qConstraints);
                const snapshot = await getDocs(q);

                let fetchedData = snapshot.docs.map(doc => {
                    const data = doc.data();
                    let dateObj = data.timestamp ? (data.timestamp.toDate ? data.timestamp.toDate() : new Date(data.timestamp)) : new Date();
                    return {
                        id: doc.id,
                        date: dateObj.toLocaleDateString('es-MX', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                        time: dateObj.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' }),
                        location: `${data.city || 'N/A'}, ${data.region || 'N/A'}`,
                        cityStr: (data.city || '').toLowerCase(),
                        rawTimestamp: dateObj.getTime()
                    };
                });

                // Filtrado local en memoria para la ciudad (evitamos pagar índices complejos)
                if (cityFilter) {
                    fetchedData = fetchedData.filter(m => m.cityStr.includes(cityFilter));
                }

                metricsData = fetchedData;
                filteredMetrics = [...metricsData];
                
                if (filteredMetrics.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="3" class="p-10 text-center text-slate-500 font-medium">No se encontraron sesiones en esas fechas.</td></tr>`;
                    window.showToast('Búsqueda completada sin resultados.', 'info');
                } else {
                    window.showToast(`Se cargaron ${filteredMetrics.length} sesiones.`, 'success');
                    window.renderMetricsTable();
                }
                
            } catch (error) {
                console.error("Error cargando sesiones:", error);
                window.showToast('Error al cargar datos estadísticos.', 'error');
                tbody.innerHTML = `<tr><td colspan="3" class="p-10 text-center text-red-500">Error de conexión. Intenta nuevamente.</td></tr>`;
            }
        };

        window.exportSessionsCSV = () => {
            if (!filteredMetrics || filteredMetrics.length === 0) {
                window.showToast('Primero carga datos para poder exportarlos.', 'error');
                return;
            }

            const headers = "Fecha,Hora,Ubicacion\n";
            const rows = filteredMetrics.map(m => {
                const cleanLoc = String(m.location).replace(/"/g, '""');
                return `"${m.date}","${m.time}","${cleanLoc}"`;
            });

            const csvContent = headers + rows.join('\n');
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `Reporte_Sesiones_${new Date().toLocaleDateString('es-MX').replace(/\//g, '-')}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            window.showToast('Reporte descargado correctamente.', 'success');
        };

        // Lógica de Renderizado y Búsqueda (Cliente)
        window.handleSearch = (e) => {
            searchQuery = e.target.value.toLowerCase();
            renderFAQs();
        };

        window.setCategory = (id) => {
            currentCategory = id;
            window.openedFaqId = null; 
            renderFAQs();
            renderCategories();
        };

        const renderCategories = () => {
            const container = document.getElementById('categories-container');
            if (!container) return;

            const isAllActive = currentCategory === 'all';
            
            let html = `
            <button onclick="window.setCategory('all')" class="flex-shrink-0 w-[110px] h-[110px] sm:w-32 sm:h-32 flex flex-col items-center justify-center rounded-[1.5rem] border-2 transition-all snap-start group ${isAllActive ? 'border-cnciBlue bg-blue-50/50 text-cnciBlue shadow-md' : 'border-slate-100 bg-white text-slate-500 hover:border-slate-300 hover:shadow-sm'}">
                <div class="w-12 h-12 flex items-center justify-center mb-2 rounded-full transition-transform group-hover:scale-110 ${isAllActive ? 'bg-cnciBlue text-white shadow-md' : 'bg-slate-100 text-slate-400 group-hover:text-cnciBlue group-hover:bg-blue-50'}">
                    <i class="fa-solid fa-border-all text-xl"></i>
                </div>
                <span class="text-xs sm:text-sm font-bold text-center leading-tight px-2">Todos</span>
            </button>`;
            
            categoriesData.forEach(cat => {
                const isActive = currentCategory === cat.id;
                const hasImg = cat.imageUrl && cat.imageUrl.trim() !== '';
                
                const iconHtml = hasImg 
                    ? `<img src="${cat.imageUrl}" alt="${cat.name}" class="w-12 h-12 mb-2 object-contain transition-transform group-hover:scale-110 drop-shadow-sm" onerror="this.outerHTML='<div class=\\'w-12 h-12 flex items-center justify-center mb-2 rounded-full bg-slate-100 text-slate-400 group-hover:text-cnciBlue group-hover:bg-blue-50 transition-transform group-hover:scale-110\\'><i class=\\'fa-solid fa-folder text-xl\\'></i></div>'">` 
                    : `<div class="w-12 h-12 flex items-center justify-center mb-2 rounded-full transition-transform group-hover:scale-110 ${isActive ? 'bg-cnciBlue text-white shadow-md' : 'bg-slate-100 text-slate-400 group-hover:text-cnciBlue group-hover:bg-blue-50'}"><i class="fa-solid fa-folder text-xl"></i></div>`;

                html += `
                <button onclick="window.setCategory('${cat.id}')" class="flex-shrink-0 w-[110px] h-[110px] sm:w-32 sm:h-32 flex flex-col items-center justify-center rounded-[1.5rem] border-2 transition-all snap-start group ${isActive ? 'border-cnciBlue bg-blue-50/50 text-cnciBlue shadow-md' : 'border-slate-100 bg-white text-slate-500 hover:border-slate-300 hover:shadow-sm'}">
                    ${iconHtml}
                    <span class="text-xs sm:text-sm font-bold text-center leading-tight px-2 line-clamp-2">${cat.name}</span>
                </button>`;
            });
            
            container.innerHTML = html;
        };

        const renderFAQs = () => {
            const container = document.getElementById('faqs-container');
            if (!container) return;

            let filtered = faqsData;

            if (currentCategory !== 'all') {
                filtered = filtered.filter(f => f.categoryId === currentCategory);
            }

            if (searchQuery) {
                filtered = filtered.filter(f => 
                    (f.question && f.question.toLowerCase().includes(searchQuery)) || 
                    (f.answer && f.answer.toLowerCase().includes(searchQuery))
                );
            }

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fa-solid fa-folder-open text-4xl text-slate-300 mb-4"></i>
                        <p class="text-slate-500 font-medium">No encontramos resultados para tu búsqueda.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(faq => {
                const isOpen = window.openedFaqId === faq.id;
                
                let mediaHtml = '';
                if (faq.imageUrl) {
                    mediaHtml += `<img src="${faq.imageUrl}" alt="Referencia visual" class="w-full h-auto object-contain rounded-3xl shadow-md mb-6 border border-slate-100">`;
                }
                if (faq.videoUrl) {
                    const safeVideoUrl = window.formatYouTubeUrl(faq.videoUrl);
                    mediaHtml += `
                    <div class="relative w-full pb-[56.25%] h-0 rounded-2xl overflow-hidden bg-black shadow-lg mb-6 border border-slate-100">
                        <iframe class="absolute top-0 left-0 w-full h-full" src="${safeVideoUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </div>`;
                }

                return `
                <article class="bg-white rounded-3xl shadow-premium border border-slate-100 faq-card hover:-translate-y-1 hover:shadow-2xl transition-all duration-300 overflow-hidden">
                    <button onclick="window.toggleFaq('${faq.id}')" class="w-full text-left p-6 md:p-8 flex justify-between items-center focus:outline-none group">
                        <h3 class="text-slate-800 font-black text-lg md:text-xl pr-6 group-hover:text-cnciBlue transition-colors">${faq.question || 'Sin título'}</h3>
                        <i class="fa-solid ${isOpen ? 'fa-chevron-up text-cnciBlue' : 'fa-chevron-down text-slate-400'} group-hover:text-cnciBlue text-xl transition-transform duration-300"></i>
                    </button>
                    <!-- Aquí se inyecta la clase rte-output para que el formato enriquecido se vea genial -->
                    <div class="${isOpen ? 'block' : 'hidden'} px-6 md:px-8 pb-6 md:pb-8 animate__animated animate__fadeIn animate__faster">
                        <div class="text-slate-600 leading-relaxed mb-6 rte-output">${faq.answer || ''}</div>
                        ${mediaHtml}
                        <button onclick="window.handleLike(event, '${faq.id}')" class="inline-flex items-center gap-2 text-sm font-medium transition-colors bg-slate-50 px-4 py-2 rounded-full border border-slate-100 ${faq.likes > 0 ? 'text-red-500 hover:bg-red-50' : 'text-slate-500 hover:text-red-500 hover:bg-red-50'}">
                            <i class="fa-solid fa-heart ${faq.likes > 0 ? 'text-red-500' : ''}"></i>
                            <span class="${faq.likes > 0 ? 'text-red-600 font-semibold' : ''}">${faq.likes || 0} Likes</span>
                        </button>
                    </div>
                </article>`;
            }).join('');
        };

        // Interacciones con la Base de Datos (Likes y Clics)
        window.toggleFaq = async (id) => {
            const isOpening = window.openedFaqId !== id;
            window.openedFaqId = isOpening ? id : null;
            renderFAQs();

            if (isOpening) {
                // ANTI-ABUSO: Registrar vista solo una vez por sesión en la memoria del navegador
                let viewedFaqs = JSON.parse(sessionStorage.getItem('cnci_viewed_faqs') || '[]');
                if (!viewedFaqs.includes(id)) {
                    viewedFaqs.push(id);
                    sessionStorage.setItem('cnci_viewed_faqs', JSON.stringify(viewedFaqs));
                    
                    try {
                        const faqRef = doc(db, 'artifacts', customAppId, 'public', 'data', 'faqs', id);
                        await updateDoc(faqRef, { clicks: increment(1) });
                    } catch (error) {
                        console.error("Error al registrar click en FAQ:", error);
                    }
                }
            }
        };
        window.handleLike = async (e, id) => {
            e.stopPropagation(); 
            
            // ANTI-ABUSO: Verificar si ya dio like en este dispositivo (localStorage)
            let likedFaqs = JSON.parse(localStorage.getItem('cnci_liked_faqs') || '[]');
            if (likedFaqs.includes(id)) {
                // Si ya existe, le mostramos un mensajito pero abortamos la petición a Firebase
                window.showToast('Ya has valorado esta pregunta anteriormente. ¡Gracias!', 'info');
                return;
            }

            try {
                const faqRef = doc(db, 'artifacts', customAppId, 'public', 'data', 'faqs', id);
                await updateDoc(faqRef, { likes: increment(1) });
                
                // Guardar en localStorage para bloquear futuros clics permanentemente en este PC/Celular
                likedFaqs.push(id);
                localStorage.setItem('cnci_liked_faqs', JSON.stringify(likedFaqs));

                // Actualizar la memoria local al instante para que el contador suba sin recargar
                const faqIndex = faqsData.findIndex(f => f.id === id);
                if (faqIndex > -1) {
                    faqsData[faqIndex].likes = (faqsData[faqIndex].likes || 0) + 1;
                    renderFAQs(); 
                }

                window.showToast('¡Gracias por tu valoración!', 'success');
            } catch (error) {
                console.error("Error al registrar like:", error);
                window.showToast('Error al registrar valoración', 'error');
            }
        };
        // LÓGICA ESTRUCTURA (Categorías Avanzadas y Áreas Simples)
        window.renderSimple = () => {
            const catList = document.getElementById('admin-categories-list');
            if (catList) {
                if (categoriesData.length === 0) {
                    catList.innerHTML = '<li class="py-4 text-slate-500 italic">No hay categorías registradas.</li>';
                } else {
                    catList.innerHTML = categoriesData.map(c => {
                        const imgHtml = c.imageUrl 
                            ? `<img src="${c.imageUrl}" class="w-10 h-10 rounded-lg object-contain bg-slate-50 border border-slate-100 p-1" onerror="this.outerHTML='<div class=\\'w-10 h-10 rounded-lg bg-slate-100 flex items-center justify-center text-slate-400 border border-slate-200\\'><i class=\\'fa-solid fa-folder\\'></i></div>'">` 
                            : `<div class="w-10 h-10 rounded-lg bg-slate-100 flex items-center justify-center text-slate-400 border border-slate-200"><i class="fa-solid fa-folder"></i></div>`;
                        
                        return `
                        <li class="py-3 flex justify-between items-center group">
                            <div class="flex items-center gap-3">
                                ${imgHtml}
                                <span class="font-medium text-slate-700">${c.name}</span>
                            </div>
                            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="window.openCategoryModal('${c.id}')" class="text-slate-400 hover:text-blue-500 w-8 h-8 rounded hover:bg-blue-50 transition-colors" title="Editar">
                                    <i class="fa-solid fa-pen-to-square"></i>
                                </button>
                                <button onclick="window.delSimple('categories', '${c.id}')" class="text-slate-400 hover:text-red-500 w-8 h-8 rounded hover:bg-red-50 transition-colors" title="Eliminar">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </div>
                        </li>
                        `;
                    }).join('');
                }
            }

            const areaList = document.getElementById('admin-areas-list');
            if (areaList) {
                if (areasData.length === 0) {
                    areaList.innerHTML = '<li class="py-4 text-slate-500 italic">No hay áreas registradas.</li>';
                } else {
                    areaList.innerHTML = areasData.map(a => `
                        <li class="py-3 flex justify-between items-center group">
                            <span class="font-medium text-slate-700">${a.name}</span>
                            <button onclick="window.delSimple('areas', '${a.id}')" class="text-slate-400 hover:text-red-500 p-2 transition-colors opacity-0 group-hover:opacity-100">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </li>
                    `).join('');
                }
            }
        };

        window.openCategoryModal = (id = null) => {
            const form = document.getElementById('category-form');
            form.reset();
            
            if (id) {
                const cat = categoriesData.find(c => c.id === id);
                if (cat) {
                    document.getElementById('cat-id').value = cat.id;
                    document.getElementById('cat-name').value = cat.name;
                    document.getElementById('cat-image').value = cat.imageUrl || '';
                }
            } else {
                document.getElementById('cat-id').value = '';
            }
            
            document.getElementById('modal-category').classList.remove('hidden-view');
        };

        window.saveCategory = async (e) => {
            e.preventDefault();
            const id = document.getElementById('cat-id').value;
            const name = document.getElementById('cat-name').value.trim();
            const imageUrl = document.getElementById('cat-image').value.trim();

            if (!name) return;

            try {
                if (id) {
                    await updateDoc(doc(db, 'artifacts', customAppId, 'public', 'data', 'categories', id), {
                        name, imageUrl
                    });
                    window.showToast('Categoría actualizada.', 'success');
                } else {
                    await addDoc(collection(db, 'artifacts', customAppId, 'public', 'data', 'categories'), {
                        name, imageUrl, createdAt: serverTimestamp()
                    });
                    window.showToast('Categoría añadida.', 'success');
                }
                window.closeModal('modal-category');
            } catch (error) {
                console.error("Error guardando categoría:", error);
                window.showToast('Ocurrió un error al guardar.', 'error');
            }
        };

        window.openSimpleModal = async (type) => {
            if(type === 'categories') return; 
            
            const name = prompt(`Ingresa el nombre de la nueva Área:`);
            if (name && name.trim() !== '') {
                try {
                    await addDoc(collection(db, 'artifacts', customAppId, 'public', 'data', 'areas'), {
                        name: name.trim(),
                        createdAt: serverTimestamp()
                    });
                    window.showToast(`Área añadida correctamente.`, 'success');
                } catch (error) {
                    console.error(`Error al añadir área:`, error);
                    window.showToast('Hubo un error al guardar.', 'error');
                }
            }
        };

        window.delSimple = async (col, id) => {
            if (confirm(`¿Estás seguro de eliminar este elemento? Las FAQs vinculadas podrían no mostrarse correctamente.`)) {
                try {
                    await deleteDoc(doc(db, 'artifacts', customAppId, 'public', 'data', col, id));
                    window.showToast('Elemento eliminado.', 'success');
                } catch (error) {
                    console.error("Error eliminando documento:", error);
                    window.showToast('Error al eliminar.', 'error');
                }
            }
        };

        // LÓGICA SESIONES (Métricas)
        window.renderMetricsTable = () => {
            const tbody = document.getElementById('admin-metrics-table-body');
            if (!tbody) return;

            if (filteredMetrics.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" class="p-6 text-center text-slate-500">No hay sesiones registradas o que coincidan con la búsqueda.</td></tr>`;
                return;
            }

            tbody.innerHTML = filteredMetrics.map(m => `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="p-4 text-slate-700 text-sm">${m.date}</td>
                    <td class="p-4 text-slate-700 text-sm">${m.time}</td>
                    <td class="p-4 text-slate-700 text-sm">
                        <span class="bg-blue-50 text-cnciBlue px-2.5 py-1 rounded-md font-medium text-xs">
                            <i class="fa-solid fa-location-dot mr-1"></i> ${m.location}
                        </span>
                    </td>
                </tr>
            `).join('');
        };

        window.filterMetrics = () => {
            const val = document.getElementById('metric-filter')?.value.toLowerCase() || '';
            
            if (!val) {
                filteredMetrics = [...metricsData];
            } else {
                filteredMetrics = metricsData.filter(m => 
                    m.date.toLowerCase().includes(val) || 
                    m.time.toLowerCase().includes(val) || 
                    m.location.toLowerCase().includes(val)
                );
            }
            window.sortMetrics(metricSort.col, true); 
        };

        window.sortMetrics = (col, refresh = false) => {
            if (!refresh) {
                if (metricSort.col === col) {
                    metricSort.order = metricSort.order === 'asc' ? 'desc' : 'asc';
                } else {
                    metricSort.col = col;
                    metricSort.order = col === 'rawTimestamp' ? 'desc' : 'asc';
                }
            }

            filteredMetrics.sort((a, b) => {
                let valA = a[col];
                let valB = b[col];
                
                if (col !== 'rawTimestamp') {
                    valA = valA.toString().toLowerCase();
                    valB = valB.toString().toLowerCase();
                }

                if (valA < valB) return metricSort.order === 'asc' ? -1 : 1;
                if (valA > valB) return metricSort.order === 'asc' ? 1 : -1;
                return 0;
            });

            window.renderMetricsTable();
        };

        async function trackSession() {
            // ANTI-ABUSO: Si ya se registró en esta sesión del navegador, ignorar
            if (sessionStorage.getItem('cnci_session_tracked')) return;

            try {
                const response = await fetch('https://get.geojs.io/v1/ip/geo.json');
                const data = await response.json();
                const city = data.city || 'Desconocida';
                const region = data.region || 'Desconocida';
                
                await addDoc(collection(db, 'artifacts', customAppId, 'public', 'data', 'sessions'), {
                    city: city,
                    region: region,
                    timestamp: serverTimestamp()
                });
                
                // Marcamos la sesión como registrada para no volver a gastar escrituras hoy
                sessionStorage.setItem('cnci_session_tracked', 'true');
            } catch (error) {
                console.log("Geolocalización bloqueada o fallida, omitiendo registro estricto.");
            }
        }

        // LÓGICA CRUD FAQs AVANZADO
        window.updateSelects = () => {
            const faqCat = document.getElementById('faq-category');
            const filterCat = document.getElementById('filter-col-cat');
            const faqArea = document.getElementById('faq-area');
            const filterArea = document.getElementById('filter-col-area');

            let catOptions = categoriesData.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            if (faqCat) faqCat.innerHTML = catOptions;
            if (filterCat) filterCat.innerHTML = `<option value="">Todas</option>` + catOptions;

            let areaOptions = areasData.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
            if (faqArea) faqArea.innerHTML = areaOptions;
            if (filterArea) filterArea.innerHTML = `<option value="">Todas</option>` + areaOptions; 
        };

        window.filterAdminFaqs = () => {
            const tbody = document.getElementById('admin-faqs-table-body');
            if (!tbody) return;

            const q = document.getElementById('filter-col-q')?.value.toLowerCase() || '';
            const cat = document.getElementById('filter-col-cat')?.value || '';
            const area = document.getElementById('filter-col-area')?.value || ''; 

            let filtered = faqsData;
            if (q) filtered = filtered.filter(f => (f.question || '').toLowerCase().includes(q));
            if (cat) filtered = filtered.filter(f => f.categoryId === cat);
            if (area) filtered = filtered.filter(f => f.areaId === area); 

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="p-6 text-center text-slate-500 italic">No hay FAQs que coincidan con la búsqueda.</td></tr>`;
                return;
            }
            
            const formatTimestamp = (ts) => {
                if (!ts) return 'N/A';
                try {
                    const d = ts.toDate ? ts.toDate() : new Date(ts);
                    return d.toLocaleDateString('es-MX', { day: '2-digit', month: '2-digit', year: 'numeric' });
                } catch(e) { return 'N/A'; }
            };

            tbody.innerHTML = filtered.map(f => {
                const catName = categoriesData.find(c => c.id === f.categoryId)?.name || 'Sin categoría';
                const areaName = areasData.find(a => a.id === f.areaId)?.name || 'Sin área'; 
                
                const createdDate = formatTimestamp(f.createdAt);
                const updatedDate = f.updatedAt ? formatTimestamp(f.updatedAt) : createdDate;
                
                return `
                    <tr class="hover:bg-slate-50 transition-colors group">
                        <td class="p-4 text-slate-800 font-medium text-sm w-[30%]">${f.question || 'Sin título'}</td>
                        <td class="p-4 text-slate-600 text-sm">
                            <span class="bg-slate-100 px-2.5 py-1 rounded-md text-xs font-semibold">${catName}</span>
                        </td>
                        <td class="p-4 text-slate-600 text-sm">
                            <span class="bg-blue-50 text-cnciBlue px-2.5 py-1 rounded-md text-xs font-semibold">${areaName}</span>
                        </td>
                        <td class="p-4 text-slate-600 text-xs whitespace-nowrap">${createdDate}</td>
                        <td class="p-4 text-slate-600 text-xs whitespace-nowrap">${updatedDate}</td>
                        <td class="p-4 text-slate-600 text-sm font-medium">
                            <i class="fa-solid fa-heart text-red-400 mr-1"></i> ${f.likes || 0}
                        </td>
                        <td class="p-4 text-center space-x-2 whitespace-nowrap">
                            <button onclick="window.editFaq('${f.id}')" class="text-slate-400 hover:text-blue-500 p-2 transition-colors" title="Editar">
                                <i class="fa-solid fa-pen-to-square"></i>
                            </button>
                            <button onclick="window.deleteFaq('${f.id}')" class="text-slate-400 hover:text-red-500 p-2 transition-colors" title="Eliminar">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        };

        window.openFaqModal = () => {
            document.getElementById('faq-form').reset();
            document.getElementById('faq-id').value = '';
            document.getElementById('faq-answer-rte').innerHTML = '';
            document.getElementById('modal-faq').classList.remove('hidden-view');
        };

        window.editFaq = (id) => {
            const faq = faqsData.find(f => f.id === id);
            if (!faq) return;
            
            document.getElementById('faq-id').value = faq.id;
            document.getElementById('faq-question').value = faq.question || '';
            document.getElementById('faq-category').value = faq.categoryId || '';
            document.getElementById('faq-area').value = faq.areaId || '';
            document.getElementById('faq-image').value = faq.imageUrl || '';
            document.getElementById('faq-video-embed').value = faq.videoUrl || '';
            document.getElementById('faq-answer-rte').innerHTML = faq.answer || '';
            
            document.getElementById('modal-faq').classList.remove('hidden-view');
        };

        window.saveFaq = async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('faq-id').value;
            const question = document.getElementById('faq-question').value.trim();
            const categoryId = document.getElementById('faq-category').value;
            const areaId = document.getElementById('faq-area').value;
            const imageUrl = document.getElementById('faq-image').value.trim();
            
            const rawVideoUrl = document.getElementById('faq-video-embed').value.trim();
            const videoUrl = window.formatYouTubeUrl(rawVideoUrl);

            const answer = document.getElementById('faq-answer-rte').innerHTML;

            if(!question || !categoryId || !areaId || !answer.trim()) {
                window.showToast('Por favor completa todos los campos requeridos.', 'error');
                return;
            }

            const payload = { 
                question, 
                categoryId, 
                areaId, 
                imageUrl, 
                videoUrl, 
                answer,
                updatedAt: serverTimestamp() 
            };

            try {
                if (id) {
                    await updateDoc(doc(db, 'artifacts', customAppId, 'public', 'data', 'faqs', id), payload);
                    window.showToast('Pregunta actualizada con éxito.', 'success');
                } else {
                    payload.likes = 0;
                    payload.clicks = 0;
                    payload.createdAt = serverTimestamp(); 
                    await addDoc(collection(db, 'artifacts', customAppId, 'public', 'data', 'faqs'), payload);
                    window.showToast('Nueva pregunta publicada correctamente.', 'success');
                }
                window.closeModal('modal-faq');
            } catch(error) {
                console.error("Error guardando FAQ:", error);
                window.showToast('Ocurrió un error al guardar.', 'error');
            }
        };

        window.deleteFaq = async (id) => {
            if (confirm(`¿Estás completamente seguro de eliminar esta pregunta del banco de conocimiento? Esta acción es irreversible.`)) {
                try {
                    await deleteDoc(doc(db, 'artifacts', customAppId, 'public', 'data', 'faqs', id));
                    window.showToast('Pregunta eliminada permanentemente.', 'success');
                } catch (error) {
                    console.error("Error eliminando FAQ:", error);
                    window.showToast('Error al intentar eliminar.', 'error');
                }
            }
        };

        // LÓGICA DASHBOARD (Chart.js) - Inicialización On-Demand
        window.updateCharts = () => {
            // Ya NO cargamos gráficas automáticamente para ahorrar lecturas de Firebase.
            // Solo preparamos el selector de la Gráfica 4 (Matriz de Efectividad)
            const catSelect = document.getElementById('chart4-cat');
            if (catSelect && categoriesData.length > 0) {
                const options = `<option value="ALL">Todas las categorías</option>` + 
                                categoriesData.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                catSelect.innerHTML = options;
            }
        };
        // UTILITARIO: Función maestra para descargar CSV del Dashboard Analítico
        window.downloadAnalyticCSV = (csvContent, filename) => {
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.showToast('Archivo descargado con éxito', 'success');
        };
        // ==========================================
        // GRÁFICA 1: Tendencia de Tráfico Histórico
        // ==========================================
        window.genChart1 = async () => {
            const startStr = document.getElementById('chart1-start').value;
            const endStr = document.getElementById('chart1-end').value;
            if (!startStr || !endStr) { window.showToast('Selecciona Fecha de Inicio y Fin', 'error'); return; }

            const startD = new Date(startStr + 'T00:00:00');
            const endD = new Date(endStr + 'T23:59:59');
            
            document.getElementById('empty-chart1').innerHTML = '<i class="fa-solid fa-spinner fa-spin text-3xl text-cnciBlue mb-3"></i><p class="text-xs text-slate-500">Consultando datos...</p>';

            try {
                const q = query(collection(db, 'artifacts', customAppId, 'public', 'data', 'sessions'),
                    where('timestamp', '>=', startD),
                    where('timestamp', '<=', endD),
                    orderBy('timestamp', 'asc')
                );
                const snap = await getDocs(q);

                // Agrupamos por fecha
                const counts = {};
                snap.docs.forEach(doc => {
                    const ts = doc.data().timestamp;
                    if(ts) {
                        const dateObj = ts.toDate ? ts.toDate() : new Date(ts);
                        const dateKey = dateObj.toLocaleDateString('es-MX', { day: '2-digit', month: '2-digit', year: 'numeric' });
                        counts[dateKey] = (counts[dateKey] || 0) + 1;
                    }
                });

                const labels = Object.keys(counts);
                const dataValues = Object.values(counts);

                // Guardamos en memoria por si queremos exportar el CSV luego
                window.chart1Data = { labels, dataValues };

                document.getElementById('empty-chart1').classList.add('hidden-view');
                const canvas = document.getElementById('canvasChart1');
                canvas.classList.remove('hidden-view');

                // Si ya existía una gráfica, la destruimos para evitar bugs visuales
                if (chart1Inst) chart1Inst.destroy();
                
                chart1Inst = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total de Accesos',
                            data: dataValues,
                            borderColor: '#ff8500', // Puntos naranjas
                            backgroundColor: 'rgba(37, 99, 235, 0.1)', // Azul translúcido abajo
                            borderWidth: 2,
                            pointBackgroundColor: '#ff8500',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
                window.showToast(`Se cargaron ${snap.docs.length} sesiones.`, 'success');
            } catch (e) { 
                console.error(e); 
                window.showToast('Error de conexión a la base de datos', 'error'); 
                document.getElementById('empty-chart1').innerHTML = '<i class="fa-solid fa-triangle-exclamation text-3xl text-red-400 mb-3"></i><p class="text-xs text-slate-500">Error al cargar.</p>';
            }
        };

        window.csvChart1 = () => {
            if(!window.chart1Data || window.chart1Data.labels.length === 0) { window.showToast('Primero genera la gráfica', 'info'); return; }
            const headers = "Fecha,Total de Accesos\n";
            const rows = window.chart1Data.labels.map((l, i) => `"${l}","${window.chart1Data.dataValues[i]}"`).join('\n');
            window.downloadAnalyticCSV(headers + rows, `Tendencia_Trafico_${new Date().getTime()}.csv`);
        };

        // ==========================================
        // GRÁFICA 2: Horarios de Mayor Demanda
        // ==========================================
        window.genChart2 = async () => {
            const startStr = document.getElementById('chart2-start').value;
            const endStr = document.getElementById('chart2-end').value;
            if (!startStr || !endStr) { window.showToast('Selecciona Fecha de Inicio y Fin', 'error'); return; }

            const startD = new Date(startStr + 'T00:00:00');
            const endD = new Date(endStr + 'T23:59:59');
            
            document.getElementById('empty-chart2').innerHTML = '<i class="fa-solid fa-spinner fa-spin text-3xl text-cnciBlue mb-3"></i><p class="text-xs text-slate-500">Analizando horarios...</p>';

            try {
                const q = query(collection(db, 'artifacts', customAppId, 'public', 'data', 'sessions'),
                    where('timestamp', '>=', startD),
                    where('timestamp', '<=', endD)
                );
                const snap = await getDocs(q);

                const hoursCount = Array(24).fill(0); 
                snap.docs.forEach(doc => {
                    const ts = doc.data().timestamp;
                    if(ts) {
                        const dateObj = ts.toDate ? ts.toDate() : new Date(ts);
                        hoursCount[dateObj.getHours()]++;
                    }
                });

                const labels = Array.from({length: 24}, (_, i) => `${i.toString().padStart(2, '0')}:00`);
                window.chart2Data = { labels, dataValues: hoursCount };

                document.getElementById('empty-chart2').classList.add('hidden-view');
                const canvas = document.getElementById('canvasChart2');
                canvas.classList.remove('hidden-view');

                if (chart2Inst) chart2Inst.destroy();
                
                chart2Inst = new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Frecuencia de Accesos',
                            data: hoursCount,
                            backgroundColor: '#ff8500', 
                            borderRadius: 6
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
                window.showToast('Mapa de horarios generado', 'success');
            } catch (e) { 
                console.error(e); 
                window.showToast('Error cargando mapa de calor', 'error'); 
            }
        };

        window.csvChart2 = () => {
            if(!window.chart2Data) { window.showToast('Primero genera la gráfica', 'info'); return; }
            const headers = "Hora del Dia,Cantidad de Consultas\n";
            const rows = window.chart2Data.labels.map((l, i) => `"${l}","${window.chart2Data.dataValues[i]}"`).join('\n');
            window.downloadAnalyticCSV(headers + rows, `Horarios_Demanda_${new Date().getTime()}.csv`);
        };

        // ==========================================
        // GRÁFICA 3: Mapa Demográfico (Top 10)
        // ==========================================
        window.genChart3 = async () => {
            const startStr = document.getElementById('chart3-start').value;
            const endStr = document.getElementById('chart3-end').value;
            if (!startStr || !endStr) { window.showToast('Selecciona Fecha de Inicio y Fin', 'error'); return; }

            const startD = new Date(startStr + 'T00:00:00');
            const endD = new Date(endStr + 'T23:59:59');
            
            document.getElementById('empty-chart3').innerHTML = '<i class="fa-solid fa-spinner fa-spin text-3xl text-cnciBlue mb-3"></i><p class="text-xs text-slate-500">Mapeando ciudades...</p>';

            try {
                const q = query(collection(db, 'artifacts', customAppId, 'public', 'data', 'sessions'),
                    where('timestamp', '>=', startD),
                    where('timestamp', '<=', endD)
                );
                const snap = await getDocs(q);

                const cityCounts = {};
                snap.docs.forEach(doc => {
                    const data = doc.data();
                    // Ignoramos registros sin ciudad para no manchar la gráfica
                    if (data.city && data.city !== 'Desconocida') {
                        const location = `${data.city}, ${data.region || ''}`;
                        cityCounts[location] = (cityCounts[location] || 0) + 1;
                    }
                });

                // Ordenar descendente y tomar Top 10
                const sortedCities = Object.entries(cityCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
                const labels = sortedCities.map(item => item[0]);
                const dataValues = sortedCities.map(item => item[1]);

                window.chart3Data = { labels, dataValues };

                document.getElementById('empty-chart3').classList.add('hidden-view');
                const canvas = document.getElementById('canvasChart3');
                canvas.classList.remove('hidden-view');

                if (chart3Inst) chart3Inst.destroy();
                
                chart3Inst = new Chart(canvas, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: dataValues,
                            backgroundColor: ['#2563eb', '#1e40af', '#004aad', '#facc15', '#ff8500', '#3b82f6', '#60a5fa', '#93c5fd', '#fef08a', '#fdba74'],
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right', labels: { boxWidth: 12, font: { size: 11, family: 'Poppins' } } }
                        }
                    }
                });
                
                if(labels.length === 0) window.showToast('No hay ciudades registradas en esta fecha', 'info');
                else window.showToast('Top 10 ciudades generado', 'success');

            } catch (e) { 
                console.error(e); 
                window.showToast('Error cargando demografía', 'error'); 
            }
        };

        window.csvChart3 = () => {
            if(!window.chart3Data || window.chart3Data.labels.length === 0) { window.showToast('Primero genera la gráfica', 'info'); return; }
            const headers = "Ciudad/Region,Total de Visitas\n";
            const rows = window.chart3Data.labels.map((l, i) => `"${l.replace(/"/g, '""')}","${window.chart3Data.dataValues[i]}"`).join('\n');
            window.downloadAnalyticCSV(headers + rows, `Demografia_Top10_${new Date().getTime()}.csv`);
        };

        // ==========================================
        // GRÁFICA 4: Matriz de Efectividad de FAQs
        // ==========================================
        window.genChart4 = () => {
            const catId = document.getElementById('chart4-cat').value;
            // Recordatorio: faqsData ya está en memoria (Costo de Firebase: 0 lecturas)
            
            document.getElementById('empty-chart4').innerHTML = '<i class="fa-solid fa-spinner fa-spin text-3xl text-cnciBlue mb-3"></i><p class="text-xs text-slate-500">Procesando matriz...</p>';

            let filteredFaqs = faqsData;
            if (catId !== 'ALL') {
                filteredFaqs = faqsData.filter(f => f.categoryId === catId);
            }

            if (filteredFaqs.length === 0) {
                window.showToast('No hay FAQs en esta categoría', 'info');
                document.getElementById('empty-chart4').innerHTML = '<i class="fa-solid fa-folder-open text-3xl text-slate-300 mb-3"></i><p class="text-xs text-slate-500 font-medium">Categoría vacía.</p>';
                return;
            }

            const scatterData = filteredFaqs.map(faq => {
                const x = faq.clicks || 0; // Eje X: Vistas
                const y = faq.likes || 0;  // Eje Y: Likes
                
                // Semáforo de efectividad UX/UI
                let pointColor = '#94a3b8'; // Gris (Normal)
                if (x > 100 && y < 5) pointColor = '#ef4444'; // Rojo (Crítico: muchas vistas, pocos likes)
                else if (x > 100 && y > 20) pointColor = '#22c55e'; // Verde (Excelente)

                return {
                    x: x,
                    y: y,
                    title: faq.question || 'Sin título',
                    backgroundColor: pointColor,
                    faqRef: faq
                };
            });

            window.chart4Data = { scatterData };

            document.getElementById('empty-chart4').classList.add('hidden-view');
            const canvas = document.getElementById('canvasChart4');
            canvas.classList.remove('hidden-view');

            if (chart4Inst) chart4Inst.destroy();
            
            chart4Inst = new Chart(canvas, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'FAQs (Vistas vs Likes)',
                        data: scatterData,
                        pointBackgroundColor: scatterData.map(d => d.backgroundColor),
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 1,
                        pointRadius: 6,
                        pointHoverRadius: 9
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(30, 41, 59, 0.95)',
                            padding: 12,
                            titleFont: { family: 'Poppins', size: 13 },
                            bodyFont: { family: 'Poppins', size: 12 },
                            callbacks: {
                                label: function(context) {
                                    const pt = context.raw;
                                    return [
                                        pt.title,
                                        `👁️ Vistas: ${pt.x}`,
                                        `❤️ Likes: ${pt.y}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Vistas (Eje X)', font: { weight: 'bold' } }, beginAtZero: true },
                        y: { title: { display: true, text: 'Likes (Eje Y)', font: { weight: 'bold' } }, beginAtZero: true }
                    }
                }
            });
            window.showToast('Matriz de efectividad calculada', 'success');
        };

        window.csvChart4 = () => {
            if(!window.chart4Data) { window.showToast('Primero analiza la matriz', 'info'); return; }
            const headers = "Pregunta,Categoria,Vistas,Likes,Ratio Efectividad (%)\n";
            const rows = window.chart4Data.scatterData.map(d => {
                const catName = categoriesData.find(c => c.id === d.faqRef.categoryId)?.name || 'Sin categoria';
                const ratio = d.x > 0 ? ((d.y / d.x) * 100).toFixed(2) : '0.00';
                const cleanQ = String(d.title).replace(/"/g, '""');
                return `"${cleanQ}","${catName}","${d.x}","${d.y}","${ratio}%"`;
            }).join('\n');
            window.downloadAnalyticCSV(headers + rows, `Matriz_Efectividad_${new Date().getTime()}.csv`);
        };

        // LÓGICA DATOS (Exportar / Importar / Descargar Plantilla CSV)
        
        window.downloadTemplateCSV = () => {
            const headers = "Pregunta,Respuesta,Categoria,Area,URL Youtube,URL Imagen\n";
            const exampleRow = '"¿Cómo genero mi credencial?","Ingresa al portal y ve al apartado de credenciales.","Trámites","Servicios Estudiantiles","https://youtu.be/ejemplo",""';
            
            const csvContent = headers + exampleRow;
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' }); 
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "Plantilla_Importacion_FAQs.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            window.showToast('Plantilla descargada.', 'success');
        };

        // UTILITARIO: Remover etiquetas HTML para exportación limpia
        const stripHtml = (html) => {
            const tmp = document.createElement("DIV");
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || "";
        };

        // Exportar Banco de Conocimiento con Fechas y Respuesta Sin Formato
        window.exportToCSV = () => {
            if (faqsData.length === 0) {
                window.showToast('No hay datos para exportar.', 'error');
                return;
            }

            const headers = ["Pregunta", "Respuesta (HTML)", "Respuesta (Sin Formato)", "Categoria", "Area", "URL Youtube", "URL Imagen", "Likes", "Vistas", "Fecha de Carga", "Ultima Modificacion"];
            
            const formatTimestamp = (ts) => {
                if (!ts) return 'N/A';
                try {
                    const d = ts.toDate ? ts.toDate() : new Date(ts);
                    return d.toLocaleDateString('es-MX', { day: '2-digit', month: '2-digit', year: 'numeric' });
                } catch(e) { return 'N/A'; }
            };

            const rows = faqsData.map(faq => {
                const catName = categoriesData.find(c => c.id === faq.categoryId)?.name || 'Sin categoría';
                const areaName = areasData.find(a => a.id === faq.areaId)?.name || 'Sin área';
                
                const createdDate = formatTimestamp(faq.createdAt);
                const updatedDate = faq.updatedAt ? formatTimestamp(faq.updatedAt) : createdDate;
                
                const plainAnswer = stripHtml(faq.answer || '');

                return [
                    faq.question || '',
                    faq.answer || '',
                    plainAnswer,
                    catName,
                    areaName,
                    faq.videoUrl || '',
                    faq.imageUrl || '',
                    (faq.likes || 0).toString(),
                    (faq.clicks || 0).toString(),
                    createdDate,
                    updatedDate
                ].map(text => {
                    const cleanText = String(text).replace(/"/g, '""');
                    return `"${cleanText}"`;
                }).join(',');
            });

            const csvContent = headers.join(',') + '\n' + rows.join('\n');
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "Banco_Conocimientos_CNCI.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            window.showToast('Archivo CSV descargado con éxito.', 'success');
        };

        window.importFromCSV = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (event) => {
                const text = event.target.result;
                const lines = text.split(/\r\n|\n/).filter(l => l.trim() !== '');
                
                if (lines.length <= 1) {
                    window.showToast('El archivo está vacío o no tiene datos válidos.', 'error');
                    e.target.value = '';
                    return;
                }

                const headerLine = lines[0].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                const cleanHeaders = headerLine.map(h => h.replace(/^"|"$/g, '').replace(/""/g, '"').trim());
                const expectedHeaders = ["Pregunta", "Respuesta", "Categoria", "Area", "URL Youtube", "URL Imagen"];
                
                const isValidTemplate = expectedHeaders.every((h, i) => cleanHeaders[i] === h);
                
                if (!isValidTemplate) {
                    window.showToast('Formato inválido. Usa exclusivamente la plantilla CSV descargable.', 'error');
                    e.target.value = '';
                    return;
                }

                const batch = writeBatch(db);
                let importCount = 0;

                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i];
                    const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    
                    if (!values || values.length < 6) continue;

                    const cleanValues = values.map(v => v.replace(/^"|"$/g, '').replace(/""/g, '"').trim());
                    
                    const q = cleanValues[0];
                    const a = cleanValues[1];
                    const catName = cleanValues[2];
                    const areaName = cleanValues[3];
                    const vUrl = cleanValues[4] || '';
                    const iUrl = cleanValues[5] || '';

                    const catMatch = categoriesData.find(c => c.name.toLowerCase() === catName.toLowerCase());
                    const areaMatch = areasData.find(ar => ar.name.toLowerCase() === areaName.toLowerCase());

                    if (catMatch && areaMatch && q && a) {
                        const newDocRef = doc(collection(db, 'artifacts', customAppId, 'public', 'data', 'faqs'));
                        batch.set(newDocRef, {
                            question: q,
                            answer: a,
                            categoryId: catMatch.id,
                            areaId: areaMatch.id,
                            imageUrl: iUrl,
                            videoUrl: window.formatYouTubeUrl(vUrl),
                            likes: 0,
                            clicks: 0,
                            createdAt: serverTimestamp(),
                            updatedAt: serverTimestamp() 
                        });
                        importCount++;
                    }
                }

                if (importCount > 0) {
                    try {
                        await batch.commit();
                        window.showToast(`¡Se importaron ${importCount} preguntas con éxito!`, 'success');
                    } catch (error) {
                        console.error('Error importando:', error);
                        window.showToast('Error de escritura en base de datos.', 'error');
                    }
                } else {
                    window.showToast('Cero filas válidas. Revisa que las categorías y áreas existan previamente.', 'error');
                }
                
                e.target.value = '';
            };
            
            reader.readAsText(file, "UTF-8");
        };

        // LÓGICA DE CARGA: Admin (Tiempo Real) vs Cliente (Caché)
        window.listenersActive = false;

        async function loadClientDataWithCache() {
            const cacheKey = 'cnci_faq_data_v1';
            const cacheTimeKey = 'cnci_faq_time_v1';
            const TTL = 2 * 60 * 60 * 1000; // 2 horas de vida
            const now = new Date().getTime();
            const cachedTime = localStorage.getItem(cacheTimeKey);

            // 1. Intentar cargar desde memoria si es válido
            if (cachedTime && (now - cachedTime < TTL)) {
                console.log("Cargando desde Caché Local (Ahorrando lecturas en Firebase) 🚀");
                const cachedData = JSON.parse(localStorage.getItem(cacheKey));
                categoriesData = cachedData.categories;
                areasData = cachedData.areas;
                faqsData = cachedData.faqs;
                renderCategories();
                renderFAQs();
                return;
            }

            // 2. Si no hay caché o expiró, consumir Firebase
            console.log("Caché expirado o inexistente. Consultando Firebase... ☁️");
            try {
                const [catSnap, areaSnap, faqSnap] = await Promise.all([
                    getDocs(collection(db, 'artifacts', customAppId, 'public', 'data', 'categories')),
                    getDocs(collection(db, 'artifacts', customAppId, 'public', 'data', 'areas')),
                    getDocs(collection(db, 'artifacts', customAppId, 'public', 'data', 'faqs'))
                ]);

                categoriesData = catSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                areasData = areaSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                faqsData = faqSnap.docs.map(d => ({ id: d.id, ...d.data() }));

                // 3. Guardar nueva data en caché
                localStorage.setItem(cacheKey, JSON.stringify({ categories: categoriesData, areas: areasData, faqs: faqsData }));
                localStorage.setItem(cacheTimeKey, now.toString());

                renderCategories();
                renderFAQs();
            } catch (error) {
                console.error("Error cargando datos:", error);
            }
        }

        async function setupAdminListeners() {
            window.listenersActive = true;
            console.log("Admin logueado: Activando tiempo real 🟢");

            onSnapshot(collection(db, 'artifacts', customAppId, 'public', 'data', 'categories'), (snapshot) => {
                categoriesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCategories(); window.renderSimple(); window.updateSelects(); window.filterAdminFaqs(); 
            });

            onSnapshot(collection(db, 'artifacts', customAppId, 'public', 'data', 'areas'), (snapshot) => {
                areasData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.renderSimple(); window.updateSelects(); window.filterAdminFaqs(); 
            });

            onSnapshot(collection(db, 'artifacts', customAppId, 'public', 'data', 'faqs'), (snapshot) => {
                faqsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderFAQs(); window.filterAdminFaqs(); 
                if (document.getElementById('admin-tab-dashboard') && !document.getElementById('admin-tab-dashboard').classList.contains('hidden-view')) window.updateCharts();
            });
        }

        // Estado de Autenticación (onAuthStateChanged)
        onAuthStateChanged(auth, (user) => {
            const viewClient = document.getElementById('view-client');
            const viewAdmin = document.getElementById('view-admin');
            const adminInfo = document.getElementById('admin-logged-info');
            const footerLoginBtn = document.getElementById('footer-login-btn');

            if (user && !user.isAnonymous) {
                // Usuario Admin Autenticado
                viewClient.classList.add('hidden-view');
                viewAdmin.classList.remove('hidden-view');
                adminInfo.classList.remove('hidden-view');
                footerLoginBtn.classList.add('hidden-view');
                
                setTimeout(() => window.updateCharts(), 500);
            } else {
                // Usuario Normal o Visitante
                viewClient.classList.remove('hidden-view');
                viewAdmin.classList.add('hidden-view');
                adminInfo.classList.add('hidden-view');
                footerLoginBtn.classList.remove('hidden-view');

                if (!user) {
                    signInAnonymously(auth).catch((error) => {
                        console.error("Error al iniciar sesión anónima:", error);
                    });
                }
            }
            // Iniciar Lógica de Carga según perfil
            if (user && !user.isAnonymous) {
                // Es Admin: Tiempo real
                if (!window.listenersActive) setupAdminListeners();
            } else {
                // Es Cliente Anónimo: Caché
                loadClientDataWithCache();
                trackSession();
            }
        });
    </script>
</body>
</html>
