<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Ayuda CNCI | Premium</title>
    
    <!-- Fuentes y Estilos -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cnciBlue: '#2563eb',
                        cnciDark: '#1e40af',
                        cnciNavy: '#004aad',
                        accent: '#ff8500',
                        bgSoft: '#f8fafc'
                    },
                    borderRadius: { '3xl': '1.5rem' },
                    boxShadow: { 'premium': '0 20px 50px -12px rgba(0,74,173,0.12)' }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; color: #1e293b; overflow-x: hidden; }
        
        .video-wrapper {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            border-radius: 1rem;
            background: #000;
        }
        .video-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
        
        .faq-content { height: auto; overflow: visible; }
        .faq-content img { max-width: 100%; height: auto; border-radius: 1rem; margin: 1rem 0; }

        .hero-gradient {
            background: linear-gradient(135deg, #004aad 0%, #002d69 100%);
            padding-bottom: 120px;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .hidden-view { display: none !important; }

        .tag-pill {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            padding: 4px 10px;
            border-radius: 6px;
            letter-spacing: 0.05em;
        }

        #mobile-menu { transition: transform 0.3s ease-in-out; }
        #mobile-menu.closed { transform: translateY(-120%); }

        .filters-container {
            position: relative;
            z-index: 20;
            margin-top: -60px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="toast-container" class="fixed top-4 right-4 z-[100] flex flex-col gap-2"></div>

    <nav class="bg-white sticky top-0 z-50 border-b border-slate-100 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 h-20 flex justify-between items-center">
            <div class="flex items-center cursor-pointer hover:opacity-80 transition-opacity" onclick="location.reload()">
                <img class="h-8 sm:h-10 w-auto" src="https://i.ibb.co/m5QcyKWg/Logo-CNCI.png" alt="Logo CNCI">
                <span class="ml-3 text-lg font-bold text-slate-800 hidden lg:block tracking-tight">Centro de Ayuda</span>
            </div>

            <div class="hidden md:flex items-center space-x-6 lg:space-x-8 text-sm font-semibold text-slate-600">
                <a href="https://www.office.com/" target="_blank" class="hover:text-blue-700 transition-colors">Office 365</a>
                <a href="https://cnci.unlimitedlearning.io/" target="_blank" class="hover:text-blue-700 transition-colors">Biblioteca</a>
                <a href="https://cnci.blackboard.com/ultra/" target="_blank" 
                   class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700 transition-all shadow-sm hover:shadow-md active:scale-95">
                    Blackboard
                </a>
                <div id="admin-logged-info" class="hidden flex items-center gap-3 border-l pl-6 ml-2">
                    <span class="text-[10px] font-black bg-blue-100 text-blue-700 px-2 py-1 rounded">STAFF</span>
                    <button onclick="window.logoutAdmin()" class="text-red-500 hover:underline">Salir</button>
                </div>
            </div>

            <button onclick="window.toggleMobileMenu()" class="md:hidden text-slate-600 p-2">
                <i class="fa-solid fa-bars-staggered text-2xl"></i>
            </button>
        </div>

        <div id="mobile-menu" class="fixed inset-x-0 top-20 bg-white border-b shadow-xl p-6 flex flex-col gap-4 md:hidden closed z-40">
            <a href="https://www.office.com/" target="_blank" class="py-3 border-b font-semibold text-slate-600">Office 365</a>
            <a href="https://cnci.unlimitedlearning.io/" target="_blank" class="py-3 border-b font-semibold text-slate-600">Biblioteca</a>
            <a href="https://cnci.blackboard.com/ultra/" target="_blank" class="py-4 bg-blue-600 text-white text-center rounded-xl font-bold">Ir a Blackboard</a>
        </div>
    </nav>

    <main id="view-client" class="flex-grow animate__animated animate__fadeIn">
        <section class="hero-gradient text-white py-16 md:py-24 px-6 relative overflow-hidden">
            <div class="max-w-4xl mx-auto text-center relative z-10">
                <h1 class="text-3xl md:text-5xl font-extrabold mb-4 animate__animated animate__fadeInDown">
                    ¬øC√≥mo podemos ayudarte?
                </h1>
                <p class="text-blue-100 text-base md:text-lg mb-10 opacity-90 font-light px-4">
                    Busca tutoriales, procesos de titulaci√≥n, becas y m√°s.
                </p>
                
                <div class="max-w-2xl mx-auto relative group px-2">
                    <i class="fa-solid fa-search absolute left-8 top-1/2 -translate-y-1/2 text-slate-400 text-lg"></i>
                    <input type="text" id="search-input" oninput="window.handleSearch(event)" 
                        placeholder="Escribe tu pregunta aqu√≠..." 
                        class="w-full pl-14 pr-6 py-5 rounded-2xl border-0 shadow-2xl focus:ring-4 focus:ring-blue-400/30 outline-none text-gray-800 text-base transition-all">
                </div>
            </div>
        </section>

        <div class="max-w-5xl mx-auto px-4 sm:px-6 filters-container pb-24">
            <div class="flex overflow-x-auto no-scrollbar gap-3 mb-10 pb-4 justify-start md:justify-center" id="categories-container"></div>
            <div id="faqs-container" class="space-y-4 md:space-y-6"></div>
        </div>
    </main>

    <!-- Vista Admin -->
    <main id="view-admin" class="flex-grow bg-slate-50 hidden-view pb-24 animate__animated animate__fadeIn">
        <div class="max-w-7xl mx-auto px-4 py-10">
            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-10 gap-6">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">Panel de Control</h2>
                    <p class="text-slate-500 text-sm">Administra el conocimiento institucional</p>
                </div>
                <div class="flex bg-white p-1 rounded-2xl shadow-sm border w-full lg:w-auto overflow-x-auto">
                    <button onclick="window.switchAdminTab('dashboard')" id="tab-btn-dashboard" class="flex-1 lg:flex-none px-6 py-2 rounded-xl text-xs font-bold transition-all">Dashboard</button>
                    <button onclick="window.switchAdminTab('metrics')" id="tab-btn-metrics" class="flex-1 lg:flex-none px-6 py-2 rounded-xl text-xs font-bold transition-all">M√©tricas</button>
                    <button onclick="window.switchAdminTab('faqs')" id="tab-btn-faqs" class="flex-1 lg:flex-none px-6 py-2 rounded-xl text-xs font-bold transition-all">FAQs</button>
                    <button onclick="window.switchAdminTab('categories')" id="tab-btn-categories" class="flex-1 lg:flex-none px-6 py-2 rounded-xl text-xs font-bold transition-all">Estructura</button>
                </div>
            </div>

            <!-- Tab Dashboard -->
            <div id="admin-tab-dashboard">
                <!-- Filtros Dashboard -->
                <div class="bg-white p-6 rounded-3xl shadow-sm border mb-8 flex flex-wrap gap-4 items-end">
                    <div class="flex-1 min-w-[200px] space-y-1">
                        <label class="text-[10px] font-black text-slate-400 uppercase">Categor√≠a</label>
                        <select id="dash-filter-cat" onchange="window.updateCharts()" class="w-full px-4 py-2.5 bg-slate-50 border rounded-xl text-xs outline-none focus:ring-2 focus:ring-blue-500"></select>
                    </div>
                    <div class="flex-1 min-w-[200px] space-y-1">
                        <label class="text-[10px] font-black text-slate-400 uppercase">√Årea</label>
                        <select id="dash-filter-area" onchange="window.updateCharts()" class="w-full px-4 py-2.5 bg-slate-50 border rounded-xl text-xs outline-none focus:ring-2 focus:ring-blue-500"></select>
                    </div>
                    <div class="flex-1 min-w-[150px] space-y-1">
                        <label class="text-[10px] font-black text-slate-400 uppercase">Desde</label>
                        <input type="date" id="dash-filter-start" onchange="window.updateCharts()" class="w-full px-4 py-2.5 bg-slate-50 border rounded-xl text-xs outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex-1 min-w-[150px] space-y-1">
                        <label class="text-[10px] font-black text-slate-400 uppercase">Hasta</label>
                        <input type="date" id="dash-filter-end" onchange="window.updateCharts()" class="w-full px-4 py-2.5 bg-slate-50 border rounded-xl text-xs outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button onclick="window.resetDashFilters()" class="px-4 py-2.5 text-blue-600 font-bold text-xs">Reset</button>
                </div>

                <div class="grid grid-cols-1 gap-8">
                    <div class="bg-white p-8 rounded-3xl shadow-premium border border-slate-100 min-h-[450px]">
                        <h3 class="font-bold text-slate-700 mb-8 text-sm flex items-center gap-2">
                            <i class="fa-solid fa-eye text-blue-500"></i> Top 10 FAQs m√°s consultadas (Aperturas)
                        </h3>
                        <div class="h-[400px]">
                            <canvas id="chartTopClicks"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-8 rounded-3xl shadow-premium border border-slate-100 min-h-[450px]">
                        <h3 class="font-bold text-slate-700 mb-8 text-sm flex items-center gap-2">
                            <i class="fa-solid fa-thumbs-up text-orange-500"></i> Top 10 FAQs con mejor valoraci√≥n (Likes)
                        </h3>
                        <div class="h-[400px]">
                            <canvas id="chartTopLikes"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab M√©tricas -->
            <div id="admin-tab-metrics" class="hidden-view">
                <div class="bg-white rounded-3xl shadow-premium border overflow-hidden">
                    <div class="p-6 border-b flex flex-col md:flex-row justify-between items-center bg-slate-50/50 gap-4">
                        <span class="font-bold text-slate-700">Bit√°cora de Accesos Globales</span>
                        <div class="relative w-full md:w-80">
                            <i class="fa-solid fa-filter absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                            <input type="text" id="metric-table-search" oninput="window.renderMetricsTable()" 
                                placeholder="Filtrar por ciudad, estado o IP..." 
                                class="w-full pl-10 pr-4 py-2.5 rounded-xl border bg-white outline-none text-xs focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 text-[10px] uppercase text-slate-400 font-black">
                                <tr>
                                    <th class="px-6 py-4">Fecha/Hora</th>
                                    <th class="px-6 py-4">Ciudad/Estado</th>
                                    <th class="px-6 py-4">Pa√≠s</th>
                                    <th class="px-6 py-4">Direcci√≥n IP</th>
                                </tr>
                            </thead>
                            <tbody id="admin-metrics-table-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab FAQs -->
            <div id="admin-tab-faqs" class="hidden-view">
                <div class="bg-white rounded-3xl shadow-premium border overflow-hidden">
                    <div class="p-6 border-b flex justify-between items-center bg-slate-50/50">
                        <span class="font-bold text-slate-700">Listado de Respuestas</span>
                        <button onclick="window.openFaqModal()" class="bg-blue-600 text-white px-5 py-2.5 rounded-xl text-xs font-bold flex items-center gap-2">
                            <i class="fa-solid fa-plus"></i> Nueva FAQ
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 text-[10px] uppercase text-slate-400 font-black">
                                <tr>
                                    <th class="px-6 py-4">Pregunta</th>
                                    <th class="px-6 py-4 text-center">Likes</th>
                                    <th class="px-6 py-4 text-center">Abrir (clics)</th>
                                    <th class="px-6 py-4 text-right">Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="admin-faqs-table-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab Estructura -->
            <div id="admin-tab-categories" class="hidden-view grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-3xl shadow-premium border">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-slate-700 text-sm">Categor√≠as</h3>
                        <button onclick="window.openSimpleModal('category')" class="text-blue-600"><i class="fa-solid fa-plus-circle"></i></button>
                    </div>
                    <ul id="admin-categories-list" class="divide-y text-sm"></ul>
                </div>
                <div class="bg-white p-6 rounded-3xl shadow-premium border">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-slate-700 text-sm">√Åreas Acad√©micas</h3>
                        <button onclick="window.openSimpleModal('area')" class="text-blue-600"><i class="fa-solid fa-plus-circle"></i></button>
                    </div>
                    <ul id="admin-areas-list" class="divide-y text-sm"></ul>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-white border-t py-10 px-6 mt-auto">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="text-center md:text-left">
                <img class="h-6 opacity-30 mx-auto md:mx-0 grayscale" src="https://i.ibb.co/m5QcyKWg/Logo-CNCI.png">
                <p class="text-slate-400 text-[10px] mt-3 uppercase tracking-tighter">¬© 2024 Universidad Virtual CNCI. Todos los derechos reservados.</p>
            </div>
            <button id="nav-admin-btn" onclick="window.showLoginModal()" class="text-slate-300 text-[10px] font-black uppercase hover:text-blue-600 transition-colors">
                üîê Acceso restringido
            </button>
        </div>
    </footer>

    <!-- Modales -->
    <div id="modal-login" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] flex justify-center items-center hidden-view p-4">
        <div class="bg-white rounded-3xl p-8 max-sm w-full shadow-2xl animate__animated animate__zoomIn">
            <h3 class="text-xl font-bold text-slate-800 text-center mb-6">Personal CNCI</h3>
            <form onsubmit="window.handleLogin(event)" class="space-y-4">
                <input type="email" id="login-email" placeholder="Correo institucional" required class="w-full px-5 py-3 bg-slate-50 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" id="login-password" placeholder="Contrase√±a" required class="w-full px-5 py-3 bg-slate-50 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition-all">Ingresar</button>
                <button type="button" onclick="window.closeModal('modal-login')" class="w-full text-slate-400 text-xs font-medium">Volver</button>
            </form>
        </div>
    </div>

    <div id="modal-faq" class="fixed inset-0 bg-slate-900/80 backdrop-blur-md z-[100] flex justify-center items-center hidden-view p-2 sm:p-4">
        <div class="bg-white rounded-[2rem] p-6 sm:p-10 max-w-3xl w-full max-h-[95vh] overflow-y-auto shadow-2xl animate__animated animate__fadeInUp">
            <h3 id="modal-faq-title" class="text-2xl font-bold text-slate-800 mb-6">Gestionar Respuesta</h3>
            <form onsubmit="window.saveFaq(event)" class="space-y-5">
                <input type="hidden" id="faq-id">
                <div class="space-y-1">
                    <label class="text-[10px] font-black uppercase text-slate-400">Pregunta al Estudiante</label>
                    <input type="text" id="faq-question" required class="w-full px-5 py-3 bg-slate-50 border-0 rounded-xl outline-none focus:ring-2 focus:ring-blue-600">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-black uppercase text-slate-400">Categor√≠a</label>
                        <select id="faq-category" required class="w-full px-5 py-3 bg-slate-50 border-0 rounded-xl outline-none"></select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-black uppercase text-slate-400">√Årea Responsable</label>
                        <select id="faq-area" required class="w-full px-5 py-3 bg-slate-50 border-0 rounded-xl outline-none"></select>
                    </div>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-black uppercase text-slate-400">Respuesta Detallada</label>
                    <div class="border rounded-xl overflow-hidden bg-white">
                        <div class="bg-slate-50 p-2 border-b flex gap-1">
                            <button type="button" onclick="document.execCommand('bold')" class="w-8 h-8 hover:bg-white rounded transition-all"><i class="fa-solid fa-bold"></i></button>
                            <button type="button" onclick="document.execCommand('insertUnorderedList')" class="w-8 h-8 hover:bg-white rounded transition-all"><i class="fa-solid fa-list-ul"></i></button>
                        </div>
                        <div id="faq-answer-rte" contenteditable="true" class="p-5 min-h-[150px] outline-none text-slate-600 text-sm leading-relaxed"></div>
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-black uppercase text-slate-400">Imagen de apoyo (URL)</label>
                        <input type="url" id="faq-image" class="w-full px-5 py-3 bg-slate-50 border-0 rounded-xl outline-none text-sm">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-black uppercase text-red-500">C√≥digo de Inserci√≥n (Embed) de YouTube</label>
                        <textarea id="faq-video-embed" placeholder='Ej: <iframe ... src="https://www.youtube.com/embed/..." ...></iframe>' 
                            class="w-full px-5 py-3 bg-red-50/30 border border-red-100 rounded-xl outline-none text-[11px] font-mono h-24"></textarea>
                    </div>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="window.closeModal('modal-faq')" class="px-6 py-2 text-slate-400 font-bold text-sm">Cerrar</button>
                    <button type="submit" class="px-8 py-2 bg-blue-600 text-white rounded-xl font-bold shadow-lg">Publicar FAQ</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, increment, addDoc, deleteDoc, query, limit, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC8jIUPHKmcKy7eO1aq6eS4ZJ6kfq4zrBo",
            authDomain: "apppaneldesupcallcenter.firebaseapp.com",
            projectId: "apppaneldesupcallcenter",
            storageBucket: "apppaneldesupcallcenter.firebasestorage.app",
            messagingSenderId: "1091325080953",
            appId: "1:1091325080953:web:14fd225a15f532f92feba8"
        };
        const customAppId = "cnci-faq-hub-v2";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let faqsData = [], categoriesData = [], areasData = [], metricsData = [];
        let currentCategory = 'all', searchQuery = '', chartL, chartC;

        const extractYouTubeId = (input) => {
            if (!input) return null;
            const iframeMatch = input.match(/src="[^"]*\/embed\/([^"?]+)/);
            if (iframeMatch && iframeMatch[1]) return iframeMatch[1];
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = input.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        };

        const showToast = (msg, type='success') => {
            const container = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = `px-6 py-4 rounded-xl shadow-xl text-white text-xs font-bold animate__animated animate__fadeInRight ${type === 'success' ? 'bg-blue-600' : 'bg-red-500'}`;
            t.innerHTML = msg;
            container.appendChild(t);
            setTimeout(() => { t.classList.replace('animate__fadeInRight', 'animate__fadeOutRight'); setTimeout(() => t.remove(), 500); }, 3000);
        };

        async function trackSession() {
            try {
                const res = await fetch('https://ipapi.co/json/');
                const data = await res.json();
                await addDoc(collection(db, 'artifacts', customAppId, 'public', 'data', 'sessions'), {
                    city: data.city || 'Desconocido',
                    region: data.region || 'Desconocido',
                    country: data.country_name || 'Desconocido',
                    ip: data.ip || '0.0.0.0',
                    timestamp: serverTimestamp(),
                    userAgent: navigator.userAgent
                });
            } catch (e) { console.error("Error tracking session", e); }
        }

        onAuthStateChanged(auth, (user) => {
            const isAdmin = user && !user.isAnonymous;
            document.getElementById('admin-logged-info').classList.toggle('hidden', !isAdmin);
            document.getElementById('nav-admin-btn').classList.toggle('hidden', isAdmin);
            if (!window.listenersActive) {
                setupListeners();
                if (!isAdmin) trackSession();
            }
        });

        async function setupListeners() {
            window.listenersActive = true;
            onSnapshot(collection(db, 'artifacts', customAppId, 'public', 'data', 'categories'), s => {
                categoriesData = s.docs.map(d => ({id: d.id, ...d.data()}));
                renderCategories();
                updateSelects();
                renderSimple();
            });
            onSnapshot(collection(db, 'artifacts', customAppId, 'public', 'data', 'areas'), s => {
                areasData = s.docs.map(d => ({id: d.id, ...d.data()}));
                updateSelects();
                renderSimple();
            });
            onSnapshot(collection(db, 'artifacts', customAppId, 'public', 'data', 'faqs'), s => {
                faqsData = s.docs.map(d => ({id: d.id, ...d.data()}));
                renderFAQs();
                renderAdminTable();
                if(!document.getElementById('admin-tab-dashboard').classList.contains('hidden-view')) updateCharts();
            });
            onSnapshot(collection(db, 'artifacts', customAppId, 'public', 'data', 'sessions'), s => {
                metricsData = s.docs.map(d => ({id: d.id, ...d.data()}));
                metricsData.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                renderMetricsTable();
            });
        }

        window.handleSearch = (e) => { searchQuery = e.target.value.toLowerCase(); renderFAQs(); };
        window.setCategory = (id) => { currentCategory = id; renderFAQs(); renderCategories(); };

        function renderCategories() {
            const container = document.getElementById('categories-container');
            const btnClass = (active) => `flex-shrink-0 px-5 py-2.5 rounded-xl text-[10px] font-black transition-all ${active ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-500 border hover:bg-slate-100 shadow-sm'}`;
            let html = `<button onclick="window.setCategory('all')" class="${btnClass(currentCategory === 'all')}">TODOS</button>`;
            categoriesData.forEach(c => html += `<button onclick="window.setCategory('${c.id}')" class="${btnClass(currentCategory === c.id)}">${c.name.toUpperCase()}</button>`);
            container.innerHTML = html;
        }

        function renderFAQs() {
            const container = document.getElementById('faqs-container');
            const filtered = faqsData.filter(f => {
                const matchCat = currentCategory === 'all' || f.categoryId === currentCategory;
                const text = (f.question + f.answer).toLowerCase();
                const matchSearch = !searchQuery || text.includes(searchQuery);
                return matchCat && matchSearch;
            });

            if(!filtered.length) { container.innerHTML = '<div class="text-center py-20 text-slate-400 text-sm">No encontramos respuestas...</div>'; return; }

            container.innerHTML = filtered.map(f => {
                const isOpen = window.openedFaqId === f.id;
                const vId = extractYouTubeId(f.videoUrl);
                const area = areasData.find(a => a.id === f.areaId)?.name || 'General';
                const cat = categoriesData.find(c => c.id === f.categoryId)?.name || 'Tr√°mite';

                return `
                <div class="bg-white rounded-3xl overflow-hidden shadow-premium border border-slate-100/50">
                    <button onclick="window.toggleFaq('${f.id}')" class="w-full text-left p-6 flex justify-between items-center group">
                        <div class="flex items-center gap-4">
                            <div class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center">
                                <i class="fa-solid fa-circle-question text-xs"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800 text-sm md:text-base">${f.question}</h3>
                                ${f.clicks > 10 ? '<span class="text-[8px] font-black bg-orange-100 text-orange-600 px-2 py-0.5 rounded mt-1 inline-block uppercase tracking-wider">üî• Popular</span>' : ''}
                            </div>
                        </div>
                        <i class="fa-solid fa-chevron-down text-slate-300 text-xs transition-transform ${isOpen ? 'rotate-180' : ''}"></i>
                    </button>
                    <div class="overflow-hidden transition-all duration-300" style="max-height: ${isOpen ? 'auto' : '0'}; display: ${isOpen ? 'block' : 'none'}">
                        <div class="px-6 pb-8 pt-2 border-t border-slate-50 faq-content">
                            <div class="text-slate-600 text-sm leading-relaxed mb-4">${f.answer}</div>
                            ${f.imageUrl ? `<img src="${f.imageUrl}" alt="Apoyo Visual" class="w-full">` : ''}
                            ${vId ? `<div class="video-wrapper mt-4"><iframe src="https://www.youtube.com/embed/${vId}?rel=0" allowfullscreen></iframe></div>` : ''}
                            <div class="mt-8 pt-6 border-t border-slate-50 flex flex-wrap justify-between items-center gap-4">
                                <div class="space-y-1">
                                    <p class="text-[8px] font-black text-slate-300 uppercase tracking-widest">√Årea: ${area}</p>
                                    <span class="tag-pill bg-blue-50 text-blue-600">${cat}</span>
                                </div>
                                <button onclick="window.handleLike(event, '${f.id}')" class="flex items-center gap-2 bg-slate-50 hover:bg-blue-50 px-4 py-2 rounded-xl transition-all font-bold text-slate-400 group">
                                    <i class="fa-solid fa-heart group-hover:text-red-500 ${f.likes>0?'text-red-400':''}"></i>
                                    <span class="text-[10px]">${f.likes || 0}</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        window.toggleFaq = async (id) => { 
            const isOpening = window.openedFaqId !== id;
            window.openedFaqId = isOpening ? id : null; 
            renderFAQs();
            if(isOpening) {
                await updateDoc(doc(db, 'artifacts', customAppId, 'public', 'data', 'faqs', id), { clicks: increment(1) });
            }
        };

        window.handleLike = async (e, id) => { e.stopPropagation(); await updateDoc(doc(db, 'artifacts', customAppId, 'public', 'data', 'faqs', id), { likes: increment(1) }); };
        
        window.showLoginModal = () => document.getElementById('modal-login').classList.remove('hidden-view');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden-view');
        
        window.handleLogin = async (e) => {
            e.preventDefault();
            try {
                await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value);
                window.closeModal('modal-login');
                document.getElementById('view-client').classList.add('hidden-view');
                document.getElementById('view-admin').classList.remove('hidden-view');
                updateCharts();
            } catch(e) { showToast("Error de acceso", "error"); }
        };

        window.logoutAdmin = async () => { await signOut(auth); location.reload(); };

        window.switchAdminTab = (t) => {
            ['dashboard', 'metrics', 'faqs', 'categories'].forEach(id => {
                const el = document.getElementById(`admin-tab-${id}`);
                if (el) el.classList.toggle('hidden-view', id !== t);
                const btn = document.getElementById(`tab-btn-${id}`);
                if (btn) btn.className = `px-6 py-2 rounded-xl text-xs font-bold ${id === t ? 'bg-blue-600 text-white shadow-md' : 'text-slate-500 hover:bg-slate-100'}`;
            });
            if(t === 'dashboard') setTimeout(updateCharts, 50);
        };

        window.saveFaq = async (e) => {
            e.preventDefault();
            const id = document.getElementById('faq-id').value;
            const data = {
                question: document.getElementById('faq-question').value,
                categoryId: document.getElementById('faq-category').value,
                areaId: document.getElementById('faq-area').value,
                answer: document.getElementById('faq-answer-rte').innerHTML,
                imageUrl: document.getElementById('faq-image').value,
                videoUrl: document.getElementById('faq-video-embed').value,
                updatedAt: serverTimestamp()
            };
            if(id) await updateDoc(doc(db, 'artifacts', customAppId, 'public', 'data', 'faqs', id), data);
            else await addDoc(collection(db, 'artifacts', customAppId, 'public', 'data', 'faqs'), {...data, likes: 0, clicks: 0, createdAt: serverTimestamp()});
            window.closeModal('modal-faq');
            showToast("FAQ guardada correctamente");
        };

        function renderAdminTable() {
            document.getElementById('admin-faqs-table-body').innerHTML = faqsData.map(f => `
                <tr class="hover:bg-slate-50">
                    <td class="px-6 py-4 font-semibold text-slate-700 text-xs">${f.question}</td>
                    <td class="px-6 py-4 text-center"><span class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded text-[10px] font-black">${f.likes || 0}</span></td>
                    <td class="px-6 py-4 text-center"><span class="bg-slate-100 text-slate-500 px-2 py-0.5 rounded text-[10px] font-black">${f.clicks || 0}</span></td>
                    <td class="px-6 py-4 text-right space-x-1">
                        <button onclick="window.editFaq('${f.id}')" class="p-2 text-slate-400 hover:text-blue-600"><i class="fa-solid fa-pen-to-square"></i></button>
                        <button onclick="window.deleteFaq('${f.id}')" class="p-2 text-slate-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`).join('');
        }

        window.renderMetricsTable = () => {
            const search = document.getElementById('metric-table-search').value.toLowerCase();
            const filtered = metricsData.filter(m => 
                m.city.toLowerCase().includes(search) || 
                m.region.toLowerCase().includes(search) || 
                m.ip.toLowerCase().includes(search) ||
                m.country.toLowerCase().includes(search)
            );

            document.getElementById('admin-metrics-table-body').innerHTML = filtered.slice(0, 100).map(m => {
                const date = m.timestamp?.toDate() || new Date();
                return `
                <tr class="hover:bg-slate-50 text-[11px]">
                    <td class="px-6 py-4 text-slate-600 font-medium">${date.toLocaleString('es-MX')}</td>
                    <td class="px-6 py-4 font-bold text-slate-800">${m.city}, ${m.region}</td>
                    <td class="px-6 py-4 text-slate-500">${m.country}</td>
                    <td class="px-6 py-4 font-mono text-slate-400">${m.ip}</td>
                </tr>`;
            }).join('');
        };

        window.updateCharts = () => {
            const catF = document.getElementById('dash-filter-cat').value;
            const areaF = document.getElementById('dash-filter-area').value;
            const startF = document.getElementById('dash-filter-start').value;
            const endF = document.getElementById('dash-filter-end').value;

            let filtered = faqsData.filter(f => {
                const matchCat = catF === 'all' || f.categoryId === catF;
                const matchArea = areaF === 'all' || f.areaId === areaF;
                
                let matchDate = true;
                if(startF || endF) {
                    const fDate = f.createdAt?.toDate() || new Date();
                    if(startF && fDate < new Date(startF)) matchDate = false;
                    if(endF && fDate > new Date(endF)) matchDate = false;
                }
                return matchCat && matchArea && matchDate;
            });

            const ctxL = document.getElementById('chartTopLikes'), ctxC = document.getElementById('chartTopClicks');
            if(!ctxL || !ctxC) return;
            
            if(chartL) chartL.destroy();
            if(chartC) chartC.destroy();

            const topLikes = [...filtered].sort((a,b) => b.likes - a.likes).slice(0,10);
            const topClicks = [...filtered].sort((a,b) => b.clicks - a.clicks).slice(0,10);

            const chartConfig = (data, label, color) => ({
                type: 'bar',
                data: {
                    labels: data.map(x => x.question.length > 40 ? x.question.substring(0, 37) + '...' : x.question),
                    datasets: [{
                        label: label,
                        data: data.map(x => (label === 'Likes' ? x.likes : x.clicks)),
                        backgroundColor: color,
                        borderRadius: 8,
                        barThickness: 24
                    }]
                },
                options: {
                    indexAxis: 'y', // Barra horizontal para leer mejor los nombres
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { 
                            backgroundColor: '#1e293b',
                            titleFont: { family: 'Poppins', size: 12 },
                            bodyFont: { family: 'Poppins', size: 11 },
                            callbacks: {
                                label: (context) => ` ${label}: ${context.parsed.x}`
                            }
                        }
                    },
                    scales: {
                        x: { grid: { display: false }, ticks: { font: { size: 10 } } },
                        y: { grid: { display: false }, ticks: { font: { size: 11, weight: '600' }, color: '#475569' } }
                    }
                }
            });

            chartL = new Chart(ctxL, chartConfig(topLikes, 'Likes', '#f97316'));
            chartC = new Chart(ctxC, chartConfig(topClicks, 'Aperturas', '#2563eb'));
        };

        window.resetDashFilters = () => {
            document.getElementById('dash-filter-cat').value = 'all';
            document.getElementById('dash-filter-area').value = 'all';
            document.getElementById('dash-filter-start').value = '';
            document.getElementById('dash-filter-end').value = '';
            updateCharts();
        };

        window.openFaqModal = () => {
            document.getElementById('faq-id').value = '';
            document.getElementById('faq-question').value = '';
            document.getElementById('faq-answer-rte').innerHTML = '';
            document.getElementById('faq-image').value = '';
            document.getElementById('faq-video-embed').value = '';
            document.getElementById('modal-faq-title').innerText = 'Publicar Respuesta';
            document.getElementById('modal-faq').classList.remove('hidden-view');
        };

        window.editFaq = (id) => {
            const f = faqsData.find(x => x.id === id);
            document.getElementById('faq-id').value = f.id;
            document.getElementById('faq-question').value = f.question;
            document.getElementById('faq-category').value = f.categoryId;
            document.getElementById('faq-area').value = f.areaId;
            document.getElementById('faq-answer-rte').innerHTML = f.answer;
            document.getElementById('faq-image').value = f.imageUrl || '';
            document.getElementById('faq-video-embed').value = f.videoUrl || '';
            document.getElementById('modal-faq').classList.remove('hidden-view');
        };

        window.deleteFaq = async (id) => {
            if(confirm('¬øEliminar esta FAQ de forma permanente?')) {
                await deleteDoc(doc(db, 'artifacts', customAppId, 'public', 'data', 'faqs', id));
                showToast("FAQ eliminada", "error");
            }
        };

        window.updateSelects = () => {
            const selects = [
                {id: 'faq-category', data: categoriesData, default: false},
                {id: 'faq-area', data: areasData, default: false},
                {id: 'dash-filter-cat', data: categoriesData, default: true},
                {id: 'dash-filter-area', data: areasData, default: true}
            ];

            selects.forEach(s => {
                const el = document.getElementById(s.id);
                if(el) {
                    let html = s.default ? '<option value="all">Todas</option>' : '';
                    html += s.data.map(i => `<option value="${i.id}">${i.name}</option>`).join('');
                    el.innerHTML = html;
                }
            });
        };

        window.openSimpleModal = (type) => {
            const name = prompt(`Nombre del nuevo elemento (${type}):`);
            if(name) addDoc(collection(db, 'artifacts', customAppId, 'public', 'data', type === 'category' ? 'categories' : 'areas'), { name });
        };

        window.renderSimple = () => {
            document.getElementById('admin-categories-list').innerHTML = categoriesData.map(c => `
                <li class="py-3 flex justify-between items-center group"><span class="text-slate-600 font-medium">${c.name}</span> 
                <button onclick="window.delSimple('categories','${c.id}')" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fa-solid fa-trash-can"></i></button></li>`).join('');
            document.getElementById('admin-areas-list').innerHTML = areasData.map(a => `
                <li class="py-3 flex justify-between items-center group"><span class="text-slate-600 font-medium">${a.name}</span> 
                <button onclick="window.delSimple('areas','${a.id}')" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fa-solid fa-trash-can"></i></button></li>`).join('');
        };
        window.delSimple = async (col, id) => { if(confirm('¬øSeguro? Se podr√≠an ver afectadas las FAQs vinculadas.')) await deleteDoc(doc(db, 'artifacts', customAppId, 'public', 'data', col, id)); };

        window.toggleMobileMenu = () => {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('closed');
        };

        signInAnonymously(auth);
    </script>
</body>
</html>
